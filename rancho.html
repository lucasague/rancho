<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ignis Latte</title>
<style>
  /* Base m√≠nimo; puedes sobreescribir desde fuera */
  body { font-family: Arial, sans-serif; }

  /* Inputs/controles con fondo transparente */
  input, select, textarea {
    background: transparent;
  }

  /* Tabs */
  .tabs { display:flex; gap:8px; align-items:center; justify-content:center; margin:10px auto; width:min(1200px,95%); }
  .tab-btn { padding:8px 14px; border:1px solid #ccc; background:#f9f9f9; cursor:pointer; border-radius:6px; }
  .tab-btn.active { font-weight:bold; background:#eee; }
  .tab-content { width:min(1200px,95%); margin:10px auto; }

  /* Distribuci√≥n especial para pedidos en tablet horizontal */
  .pedidos-layout {
    display:flex;
    gap:20px;
    align-items:flex-start;
  }
  .pedidos-left,
  .pedidos-right {
    flex:1;
    min-width:0;
  }
  .pedidos-left {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .pedidos-right {
    display:flex;
    flex-direction:column;
    gap:12px;
    padding-right:4px;
  }

  .panel-nuevo-pedido {
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* Grid productos */
  .grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap:10px;
  }
  .producto {
    border:1px solid #999; padding:9px; position:relative; font-weight:bold; font-size:14px; border-radius:6px;
    display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; /* centrado */
    min-height:60px;
    user-select:none;
  }
  .icono { display:block; font-size:30px; margin-bottom:4px; line-height:1; text-align:center; }
  .contador {
    position:absolute; top:6px; right:6px; background:#000; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    display:none; text-align:center; font-size:12px;
  }
  .restar {
    position:absolute; bottom:6px; right:6px; background:#c00; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    text-align:center; cursor:pointer; display:none; font-size:14px;
  }

  button { padding:8px 14px; margin:6px; cursor:pointer; }
  .eliminar-todos-btn {
    background:#d32f2f;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:6px 12px;
    font-weight:bold;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    transition:background 0.2s ease;
  }
  .eliminar-todos-btn:hover { background:#b71c1c; }
  .boton-enviar {
    border:3px solid #2e7d32;
    background-color:#2e7d32;
    color:#fff;
  }
  table { margin:16px auto; width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; vertical-align: middle; text-align:left; }
  .resumen-panel {
    display:grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap:12px;
    width:100%;
    align-items:flex-start;
  }
  .resumen-panel > div {
    background:#f9f9f9;
    border:1px solid #ddd;
    border-radius:6px;
    padding:10px;
  }
  #resumenOrden,
  #total,
  #sugerenciaCambio {
    text-align:left;
    width:100%;
  }
  #sugerenciaCambio ul {
    list-style:none;
    padding:0;
    margin:8px 0 0 0;
  }
  #sugerenciaCambio li { margin-bottom:4px; }
  .indentado { padding-left:20px; color:#555; font-size:90%; text-align:left; }

  .warning-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:20px;
  }
  .warning-overlay.active { display:flex; }
  .warning-dialog {
    background:#fff8e1;
    border:4px solid #ff6f00;
    padding:30px 26px;
    max-width:520px;
    width:100%;
    text-align:center;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,0.45);
    animation:warning-pop 0.25s ease-out;
  }
  .warning-dialog h2 {
    margin:0 0 18px 0;
    color:#d84315;
    font-size:30px;
    text-transform:uppercase;
    letter-spacing:1px;
  }
  .warning-dialog p {
    margin:0 0 24px 0;
    color:#5d4037;
    font-size:18px;
    line-height:1.5;
  }
  .warning-actions {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    justify-content:center;
  }
  .warning-actions button {
    border:none;
    border-radius:8px;
    padding:10px 20px;
    font-weight:bold;
    cursor:pointer;
    font-size:16px;
  }
  .warning-actions .confirm { background:#d32f2f; color:#fff; }
  .warning-actions .confirm:hover { background:#b71c1c; }
  .warning-actions .cancel { background:#eceff1; color:#37474f; }
  .warning-actions .cancel:hover { background:#cfd8dc; }

  @keyframes warning-pop {
    from { transform:scale(0.8); opacity:0; }
    to { transform:scale(1); opacity:1; }
  }

  /* M√©todo de pago */
  .pago-label input[type="radio"] { display:none; }
  .pago-label { display:inline-block; padding:10px 20px; margin:5px; cursor:pointer; border:2px solid #ccc; border-radius:6px; }
  .pago-label.active { border-color:#007bff; background-color:#e0f0ff; font-weight:bold; }

  .pendiente-checkbox { width:16px; height:16px; cursor:pointer; vertical-align:middle; margin-right:6px; }

  tr.servido { opacity:0.35; }

  #cliente {
    padding:7px 10px; width:min(520px, 100%); margin:10px 0 0 0; display:block;
    border:1px solid #ccc; border-radius:6px; font-size:14px;
  }

  .productos-linea {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
    flex-wrap:wrap;
    text-align:right;
  }
  .productos-nombre { font-size:12px; color:#666; margin-left:6px; }
  .productos-linea .productos-nombre.indentado {
    width:100%;
    margin-left:0;
    text-align:right;
  }
  .productos-maestro {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
    text-align:right;
  }
  .master-checkbox { width:20px; height:20px; cursor:pointer; transform:scale(1.2); transform-origin:left center; }
  .master-label { font-weight:bold; font-size:14px; color:#333; }

  .metodos-acciones {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .metodo-pago {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:flex-start;
    align-items:stretch;
  }
  .metodo-pago .pago-label {
    flex:1 1 140px;
    text-align:center;
    padding:7px 20px;
  }
  .metodo-pago .cuenta-abierta-btn {
    flex:1 1 140px;
    padding:10px 20px;
    margin:5px;
  }
  .metodos-acciones .botones-acciones {
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap:8px;
  }
  .metodos-acciones button {
    margin:0;
  }
  .metodos-acciones .botones-acciones button {
    padding:4.2px 14px;
  }
  .btn-cierre-caja {
    background:#fdeaea;
    border:2px solid #d64b4b;
    color:#8a1e1e;
  }
  .btn-cierre-caja:hover {
    background:#f8d0d0;
    border-color:#c03a3a;
  }

  @media (max-width: 1024px) {
    .pedidos-layout { flex-direction:column; }
  }

  @media (max-width: 900px) {
    .productos-editor {
      margin-left:0;
      width:100%;
    }
  }

  @media (max-width: 768px) {
    .resumen-panel {
      grid-template-columns:1fr;
    }
  }

  /* Cuentas abiertas */
  #cuentasPanel { display:none; width:100%; margin:16px 0 8px 0; text-align:left; }
  #cuentasHeader { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  #cuentasLista { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:8px; }
  .cta-card { border:1px solid #ddd; border-radius:8px; padding:8px 10px; background:#fafafa; line-height:1.2; }
  .cta-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; font-size:14px; font-weight:bold; }
  .cta-sub { font-size:12px; color:#555; margin-bottom:6px; }
  .cta-actions { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .cta-actions button { padding:6px 10px; margin:0; font-size:12px; }
  .cta-actions select { padding:4px 6px; font-size:12px; }
  .muted { color:#666; font-size:12px; }

  /* Editor de productos */
  #tabProductos {
    position:relative;
  }
  .productos-editor {
    margin-left:34%;
    width:66%;
  }
  .editor-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:8px 0; }
  .small { font-size:12px; color:#555; }
  .number { width:110px; }
  .tipo-select { width:130px; }
  .icono-input { width:100px; }
  .nombre-input { width:100%; }
  .variantes-input { width:100%; }
  .help { font-size:12px; color:#666; margin-top:-4px; }

  /* Men√∫ radial de variantes (columna izquierda) */
  .radial-overlay {
    position:fixed; inset:0; background:rgba(0,0,0,0.25);
    z-index:9999;
    touch-action:none;
  }
  .radial-center {
    position:absolute; width:0; height:0; /* punto de referencia */
  }
  .rad-item {
    position:absolute; transform:translate(-50%, -50%);
    background:#fff; border:1px solid #ccc; border-radius:20px; padding:6px 10px; cursor:pointer;
    white-space:nowrap; font-size:14px; box-shadow:0 6px 16px rgba(0,0,0,0.15);
    text-align:center;
  }
  .rad-item.active {
    border-color:#007bff;
    background:#e0f0ff;
    font-weight:bold;
  }
</style>
</head>
<body>

<!-- TABS -->
<div class="tabs">
  <button id="tabProductosBtn" class="tab-btn" onclick="mostrarTab('productos')">Productos</button>
  <button id="tabPedidosBtn" class="tab-btn active" onclick="mostrarTab('pedidos')">Pedidos</button>
</div>

<!-- TAB: PEDIDOS (por defecto activa) -->
<section id="tabPedidos" class="tab-content">
  <div class="pedidos-layout">
    <div class="pedidos-left">
      <table id="tabla">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Importe</th>
            <th>M√©todo</th>
            <th>Productos</th>
            <th><button type="button" class="eliminar-todos-btn" onclick="mostrarWarningEliminarTodos()">Eliminar todos</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <table id="tablaResumen">
        <thead><tr><th>Resumen</th><th>Valor</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pedidos-right">
      <div class="panel-nuevo-pedido">
        <div class="grid" id="productosGrid"></div>

        <input id="cliente" type="text" placeholder="Nombre del cliente (opcional)">
        <div class="metodos-acciones">
          <div id="metodoPago" class="metodo-pago">
            <label class="pago-label active"><input type="radio" name="pago" value="efectivo" checked>Efectivo</label>
            <label class="pago-label"><input type="radio" name="pago" value="sinpe">Sinpe</label>
            <button class="cuenta-abierta-btn" onclick="anadirACuentaAbierta()">Pendiente</button>
          </div>

          <div class="botones-acciones">
            <button onclick="enviar()">Enviar</button>
            <button onclick="borrar()">Limpiar</button>
            <button onclick="cerrarCaja()">Cierre de caja</button>
          </div>
        </div>

        <div class="resumen-panel">
          <div id="resumenOrden"><span class="muted">Sin productos seleccionados</span></div>
          <div id="total"><strong>Total: 0‚Ç°</strong></div>
          <div id="sugerenciaCambio"><strong>Cambio</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span></div>
        </div>
      </div>
      <section id="cuentasPanel">
        <div id="cuentasHeader">
          <h2 style="margin:0;font-size:16px;">Cuentas abiertas</h2>
          <span class="muted">Crea cuentas con ‚ÄúA√±adir a cuenta abierta‚Äù usando el nombre del campo Cliente.</span>
        </div>
        <div id="cuentasLista"></div>
      </section>
    </div>
  </div>
</section>

<!-- TAB: PRODUCTOS (editor) -->
<section id="tabProductos" class="tab-content" style="display:none;">
  <div class="productos-editor">
    <h2 style="margin:0 0 10px 0; text-align:center;">Editor de productos</h2>
    <p class="help" style="text-align:center;">Puedes a√±adir <strong>variantes</strong> separadas por comas (p. ej. ‚ÄúQueso, Frijol, Mixta‚Äù). Pulsaci√≥n larga en el producto abre el men√∫ radial.</p>

    <div class="editor-actions">
      <button onclick="agregarFilaProducto()">A√±adir fila</button>
      <button onclick="guardarProductosDesdeTabla()">Guardar cambios</button>
      <button onclick="restablecerProductos()">Restablecer por defecto</button>
      <span class="small" id="estadoGuardado"></span>
    </div>

    <table id="tablaProductos">
      <thead>
        <tr>
          <th style="width:24%;">Nombre</th>
          <th style="width:14%;">Precio (‚Ç°)</th>
          <th style="width:14%;">Tipo</th>
          <th style="width:14%;">Icono(s)</th>
          <th style="width:30%;">Variantes (coma)</th>
          <th style="width:4%;">Borrar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="help" style="text-align:center;">Los cambios guardados aparecen en la pesta√±a ‚ÄúPedidos‚Äù.</div>
  </div>
</section>

<!-- EmailJS -->
<div id="warningEliminarTodos" class="warning-overlay" role="alertdialog" aria-modal="true"
     aria-labelledby="warningEliminarTitulo" aria-describedby="warningEliminarDescripcion">
  <div class="warning-dialog">
    <h2 id="warningEliminarTitulo">¬°Advertencia!</h2>
    <p id="warningEliminarDescripcion">Esta acci√≥n eliminar√° <strong>todo</strong> el historial de √≥rdenes. No se podr√° recuperar la informaci√≥n.</p>
    <div class="warning-actions">
      <button class="confirm" type="button" onclick="confirmarEliminarTodos()">S√≠, eliminar todo</button>
      <button class="cancel" type="button" onclick="cancelarEliminarTodos()">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>(function(){ emailjs.init({ publicKey: "rzMljmZB066lvsYyE" }); })();</script>

<script>
/* =================== CONFIG / ALMACEN =================== */
const STORAGE_KEYS = {
  productos: 'ignis_productos_v2', // v2 por variantes
  ordenes: 'ordenes_v2',
  cuentas: 'cuentas_abiertas_v2'
};

const PRECIO_COMBO = 999999; // tu valor actual
const CAMBIOS_SUGERIDOS = [1000, 2000, 5000, 10000];

const PRODUCTOS_POR_DEFECTO = [
  { nombre: 'Caf√©', precio: 500, tipo: 'bebida', icono: '‚òï', variantes: [] },
  { nombre: 'Fresco', precio: 500, tipo: 'bebida', icono: 'ü•§', variantes: [] },
  { nombre: 'Helado', precio: 700, tipo: 'bebida', icono: 'üçß', variantes: [] },
  { nombre: 'Chocolate Mr. B', precio: 600, tipo: 'bebida', icono: 'üç´', variantes: [] },
  { nombre: 'Galletas', precio: 300, tipo: 'comida', icono: 'üç™', variantes: [] },
  { nombre: 'Crepa', precio: 1000, tipo: 'comida', icono: 'ü•û', variantes: [] },
  // Empanada unificada con variantes
  { nombre: 'Empanada', precio: 700, tipo: 'comida', icono: 'ü•ü', variantes: ['Queso', 'Frijol', 'Mixta'] },
  { nombre: 'Empanada de pizza', precio: 1000, tipo: 'comida', icono: 'üçï', variantes: [] },
  { nombre: 'Gallo', precio: 1000, tipo: 'comida', icono: 'üå≠', variantes: [] }
];

function cargarProductos() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.productos);
    if (!raw) return PRODUCTOS_POR_DEFECTO.slice();
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr) || arr.length === 0) return PRODUCTOS_POR_DEFECTO.slice();
    return arr.map(p => ({
      nombre: String(p.nombre ?? '').trim() || 'Sin nombre',
      precio: Number(p.precio ?? 0) || 0,
      tipo: (p.tipo === 'bebida' || p.tipo === 'comida') ? p.tipo : 'comida',
      icono: String(p.icono ?? ''),
      variantes: Array.isArray(p.variantes)
        ? p.variantes.map(v => String(v).trim()).filter(Boolean)
        : String(p.variantes || '').split(',').map(v => v.trim()).filter(Boolean)
    }));
  } catch { return PRODUCTOS_POR_DEFECTO.slice(); }
}
function guardarProductos(arr) {
  localStorage.setItem(STORAGE_KEYS.productos, JSON.stringify(arr));
}

/* =================== TABS =================== */
function mostrarTab(nombre) {
  const productosTab = document.getElementById('tabProductos');
  const pedidosTab = document.getElementById('tabPedidos');
  const btnProd = document.getElementById('tabProductosBtn');
  const btnPed = document.getElementById('tabPedidosBtn');
  if (nombre === 'productos') {
    productosTab.style.display = '';
    pedidosTab.style.display = 'none';
    btnProd.classList.add('active'); btnPed.classList.remove('active');
    renderEditorProductos();
  } else {
    productosTab.style.display = 'none';
    pedidosTab.style.display = '';
    btnProd.classList.remove('active'); btnPed.classList.add('active');
    crearProductos();
    actualizarResumen();
    actualizarTabla();
    renderCuentas();
  }
}

/* =================== EDITOR DE PRODUCTOS =================== */
function renderEditorProductos() {
  const tbody = document.querySelector('#tablaProductos tbody');
  tbody.innerHTML = '';
  const datos = cargarProductos();
  datos.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="nombre-input" type="text" value="${html(p.nombre)}" placeholder="Nombre"></td>
      <td><input class="number" type="number" min="0" step="1" value="${Number(p.precio)}"></td>
      <td>
        <select class="tipo-select">
          <option value="bebida" ${p.tipo === 'bebida' ? 'selected' : ''}>bebida</option>
          <option value="comida" ${p.tipo === 'comida' ? 'selected' : ''}>comida</option>
        </select>
      </td>
      <td><input class="icono-input" type="text" value="${html(p.icono)}" placeholder="‚òï"></td>
      <td><input class="variantes-input" type="text" value="${html(p.variantes.join(', '))}" placeholder="Queso, Frijol, Mixta"></td>
      <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });
  setEstadoGuardado('');
}
function agregarFilaProducto() {
  const tbody = document.querySelector('#tablaProductos tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="nombre-input" type="text" value="" placeholder="Nombre"></td>
    <td><input class="number" type="number" min="0" step="1" value="0"></td>
    <td>
      <select class="tipo-select">
        <option value="bebida">bebida</option>
        <option value="comida" selected>comida</option>
      </select>
    </td>
    <td><input class="icono-input" type="text" value="" placeholder="üç™"></td>
    <td><input class="variantes-input" type="text" value="" placeholder="Queso, Frijol"></td>
    <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(tr);
}
function borrarFilaProducto(btn) { btn.closest('tr')?.remove(); }

function guardarProductosDesdeTabla() {
  const rows = Array.from(document.querySelectorAll('#tablaProductos tbody tr'));
  const nuevos = [];
  const nombres = new Set();
  for (const r of rows) {
    const nombre = (r.querySelector('.nombre-input')?.value || '').trim();
    const precio = Number(r.querySelector('.number')?.value || 0);
    const tipo = r.querySelector('.tipo-select')?.value === 'bebida' ? 'bebida' : 'comida';
    const icono = (r.querySelector('.icono-input')?.value || '').trim();
    const variantesStr = (r.querySelector('.variantes-input')?.value || '').trim();
    const variantes = variantesStr ? variantesStr.split(',').map(v => v.trim()).filter(Boolean) : [];

    if (!nombre) continue;
    if (nombres.has(nombre)) { alert(`Nombre duplicado: "${nombre}". Cambia alguno antes de guardar.`); return; }
    nombres.add(nombre);

    nuevos.push({ nombre, precio: Math.max(0, Math.floor(precio)), tipo, icono, variantes });
  }
  guardarProductos(nuevos);
  setEstadoGuardado('Cambios guardados.');
}
function restablecerProductos() {
  if (!confirm('¬øRestablecer el listado por defecto?')) return;
  guardarProductos(PRODUCTOS_POR_DEFECTO.slice());
  renderEditorProductos();
  setEstadoGuardado('Restablecido a valores por defecto.');
}
function setEstadoGuardado(txt) { document.getElementById('estadoGuardado').textContent = txt || ''; }
function html(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function formatearColones(valor) {
  const numero = Number(valor || 0);
  return Number.isFinite(numero) ? numero.toLocaleString('es-CR') : '0';
}

/* =================== PEDIDOS: selecci√≥n con variantes =================== */
let productosNodos = [];              // nodos de la grilla
let seleccionActual = {};             // { [producto]: { total:number, variantes: { [var]: number } } }

function crearProductos() {
  const grid = document.getElementById('productosGrid');
  grid.innerHTML = '';
  const PRODS = cargarProductos();

  PRODS.forEach((prod) => {
    const div = document.createElement('div');
    div.className = 'producto';
    div.dataset.nombre = prod.nombre;
    div.dataset.precio = prod.precio;
    div.dataset.tipo = prod.tipo;
    div.dataset.variantes = JSON.stringify(prod.variantes || []);
    div.innerHTML = `<span class="icono">${html(prod.icono)}</span><span>${html(prod.nombre)} (${prod.precio})</span><span class="contador"></span><span class="restar">-</span>`;
    grid.appendChild(div);
  });

  productosNodos = Array.from(document.querySelectorAll('.producto'));
  productosNodos.forEach(p => configurarHandlersProducto(p));
}

function configurarHandlersProducto(p) {
  const nombre = p.dataset.nombre;
  const contador = p.querySelector('.contador');
  const restar = p.querySelector('.restar');
  let pressTimer = null, longFired = false, pressPoint = null;

  function getPointFromEvent(e) {
    if (e.touches && e.touches[0]) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
    return { x: e.clientX, y: e.clientY };
  }

  function esDesdeRestar(evt) {
    return evt.target instanceof Element && evt.target.closest('.restar');
  }

  function startPress(e) {
    if (esDesdeRestar(e)) return;
    e.preventDefault();
    longFired = false;
    pressPoint = getPointFromEvent(e);

    pressTimer = setTimeout(() => {
      longFired = true;
      abrirRadial(nombre, pressPoint, p);
    }, 225); // umbral pulsaci√≥n larga
  }
  function endPress(e) {
    if (esDesdeRestar(e)) return;
    if (pressTimer) clearTimeout(pressTimer);
    if (!longFired) incProducto(nombre, null); // clic corto
  }

  p.addEventListener('mousedown', startPress);
  p.addEventListener('touchstart', startPress, {passive:false});
  p.addEventListener('mouseup', endPress);
  p.addEventListener('mouseleave', ()=> pressTimer && clearTimeout(pressTimer));
  p.addEventListener('touchend', endPress);
  p.addEventListener('touchcancel', ()=> pressTimer && clearTimeout(pressTimer));

  restar.onclick = (e) => {
    e.stopPropagation();
    decProducto(nombre);
  };

  // render contador por si hay selecci√≥n previa
  renderContador(nombre, contador, restar);
}

function incProducto(nombre, variante) {
  if (!seleccionActual[nombre]) seleccionActual[nombre] = { total:0, variantes:{} };
  seleccionActual[nombre].total += 1;
  if (variante) {
    seleccionActual[nombre].variantes[variante] = (seleccionActual[nombre].variantes[variante] || 0) + 1;
  }
  renderContadorNombre(nombre);
  actualizarResumen();
}
function decProducto(nombre) {
  const obj = seleccionActual[nombre];
  if (!obj || obj.total <= 0) return;
  const totalVariantes = Object.values(obj.variantes).reduce((a,b)=>a+b,0);
  const sinEspecificar = obj.total - totalVariantes;
  if (sinEspecificar > 0) {
    obj.total -= 1;
  } else {
    const vNames = Object.keys(obj.variantes).filter(v => obj.variantes[v] > 0);
    if (vNames.length) {
      const v = vNames[vNames.length-1];
      obj.variantes[v] -= 1;
      obj.total -= 1;
      if (obj.variantes[v] === 0) delete obj.variantes[v];
    } else {
      obj.total -= 1;
    }
  }
  if (obj.total <= 0) delete seleccionActual[nombre];
  renderContadorNombre(nombre);
  actualizarResumen();
}
function renderContadorNombre(nombre) {
  const p = productosNodos.find(n=>n.dataset.nombre===nombre);
  if (!p) return;
  renderContador(nombre, p.querySelector('.contador'), p.querySelector('.restar'));
}
function renderContador(nombre, contador, restar) {
  const total = seleccionActual[nombre]?.total || 0;
  contador.textContent = total ? String(total) : '';
  contador.style.display = total ? 'inline-block' : 'none';
  restar.style.display = total ? 'inline-block' : 'none';
}

/* Men√∫ radial (columna a la izquierda con selecci√≥n por arrastre) */
function abrirRadial(nombre, punto, anchorEl) {
  const PRODS = cargarProductos();
  const prod = PRODS.find(p=>p.nombre===nombre);
  const variantes = (prod?.variantes)||[];
  if (!variantes.length) { incProducto(nombre, null); return; }

  // Determinar punto (si no viene, usar centro del producto)
  let cx, cy;
  if (punto && typeof punto.x === 'number' && typeof punto.y === 'number') {
    cx = punto.x; cy = punto.y;
  } else if (anchorEl) {
    const rect = anchorEl.getBoundingClientRect();
    cx = rect.left + rect.width/2;
    cy = rect.top + rect.height/2;
  } else {
    cx = window.innerWidth/2; cy = window.innerHeight/2;
  }

  const overlay = document.createElement('div');
  overlay.className = 'radial-overlay';
  overlay.addEventListener('contextmenu', (e)=> e.preventDefault());

  let overlayActivo = true;
  const cerrarOverlay = () => {
    if (!overlayActivo) return;
    overlayActivo = false;
    if (overlay.parentNode) overlay.parentNode.removeChild(overlay);
  };

  // Punto centro
  const center = document.createElement('div');
  center.className = 'radial-center';
  center.style.left = cx + 'px';
  center.style.top = cy + 'px';
  center.style.position = 'absolute';

  const N = variantes.length;
  const OFFSET_X = 55;
  const OFFSET_Y = 48;
  const itemsMeta = [];

  variantes.forEach((v, i) => {
    const idxOffset = i - (N - 1) / 2;
    const x = cx - OFFSET_X;
    const y = cy + idxOffset * OFFSET_Y;
    const item = document.createElement('div');
    item.className = 'rad-item';
    item.dataset.variante = v;
    item.style.left = x + 'px';
    item.style.top = y + 'px';
    item.textContent = v;
    overlay.appendChild(item);
    itemsMeta.push({ el:item, cx:x, cy:y, variante:v });
  });

  overlay.appendChild(center);
  document.body.appendChild(overlay);

  let activo = null;
  const setActivo = (item) => {
    if (activo === item) return;
    if (activo) activo.classList.remove('active');
    activo = item;
    if (activo) activo.classList.add('active');
  };

  const puntoDesdeEvento = (e) => {
    if (!e) return null;
    if (e.touches && e.touches[0]) return { x:e.touches[0].clientX, y:e.touches[0].clientY };
    if (e.changedTouches && e.changedTouches[0]) return { x:e.changedTouches[0].clientX, y:e.changedTouches[0].clientY };
    if (typeof e.clientX === 'number' && typeof e.clientY === 'number') return { x:e.clientX, y:e.clientY };
    return null;
  };

  const actualizarDesdePunto = (pt) => {
    if (!pt) return;
    let cercano = null;
    let distanciaMin = Infinity;
    for (const meta of itemsMeta) {
      const dx = pt.x - meta.cx;
      const dy = pt.y - meta.cy;
      const dist = Math.hypot(dx, dy);
      if (dist < distanciaMin) {
        distanciaMin = dist;
        cercano = meta;
      }
    }
    const UMBRAL = Math.min(OFFSET_X * 0.8, 50);
    setActivo(cercano && distanciaMin <= UMBRAL ? cercano.el : null);
  };

  const moverHandler = (e) => {
    if (e.type === 'mousemove' && e.buttons === 0) return;
    const pt = puntoDesdeEvento(e);
    if (pt) actualizarDesdePunto(pt);
    if (e.cancelable) e.preventDefault();
  };

  const finalizarHandler = (e) => {
    const pt = puntoDesdeEvento(e);
    if (pt) actualizarDesdePunto(pt);
    if (activo) {
      const variante = activo.dataset.variante;
      incProducto(nombre, variante);
    }
    if (e.cancelable) e.preventDefault();
    cerrarOverlay();
  };

  const cancelarHandler = (e) => {
    if (e && e.cancelable) e.preventDefault();
    cerrarOverlay();
  };

  overlay.addEventListener('touchmove', moverHandler, { passive:false });
  overlay.addEventListener('mousemove', moverHandler);
  overlay.addEventListener('touchend', finalizarHandler);
  overlay.addEventListener('mouseup', finalizarHandler);
  overlay.addEventListener('touchcancel', cancelarHandler);
  overlay.addEventListener('click', (e)=>{ if (e.target === overlay) cerrarOverlay(); });
}

/* Pago UI */
document.addEventListener('click', (ev) => {
  const lbl = ev.target.closest('#metodoPago .pago-label');
  if (!lbl) return;
  document.querySelectorAll('#metodoPago .pago-label').forEach(l => l.classList.remove('active'));
  lbl.classList.add('active');
  const inp = lbl.querySelector('input'); if (inp) inp.checked = true;
});

/* Resumen de pedido (incluye variantes) */
function actualizarResumen() {
  const PRODS = cargarProductos();
  let resumen = document.getElementById('resumenOrden');
  let totalNodo = document.getElementById('total');
  let sugerenciaCambio = document.getElementById('sugerenciaCambio');
  let total = 0;

  // Mapa de cantidades por producto base para combos y precio
  const mapaBase = {};
  Object.keys(seleccionActual).forEach(nombre => mapaBase[nombre] = (mapaBase[nombre] || 0) + (seleccionActual[nombre].total || 0));

  const calc = calcularTotalDesdeMapa(mapaBase, PRODS);
  const lineasResumen = [];
  for (let combo in calc.comboCantidades) {
    lineasResumen.push(`${calc.comboCantidades[combo]} Combo - ${formatearColones(calc.comboCantidades[combo] * PRECIO_COMBO)}‚Ç°<br>`);
    lineasResumen.push(`<div class='indentado'>- ${html(combo)}</div>`);
  }

  for (let p in calc.individuales) {
    const cantidadIndiv = calc.individuales[p];
    if ((cantidadIndiv || 0) > 0) {
      const precioUnitario = (PRODS.find(x=>x.nombre===p)||{}).precio || 0;
      const precio = cantidadIndiv * precioUnitario;
      lineasResumen.push(`${cantidadIndiv} ${html(p)} - ${formatearColones(precio)}‚Ç°<br>`);
      const varsObj = (seleccionActual[p]?.variantes)||{};
      const nombresVar = Object.keys(varsObj);
      if (nombresVar.length) {
        const detalle = nombresVar.map(v=>`${html(v)}: ${varsObj[v]}`).join(' ¬∑ ');
        lineasResumen.push(`<div class="indentado">${detalle}</div>`);
      }
    }
  }

  total = calc.total;
  resumen.innerHTML = lineasResumen.length ? lineasResumen.join('') : '<span class="muted">Sin productos seleccionados</span>';
  totalNodo.innerHTML = `<strong>Total: ${formatearColones(total)}‚Ç°</strong>`;

  if (total <= 0) {
    sugerenciaCambio.innerHTML = '<strong>Cambio sugerido</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span>';
  } else {
    const opciones = CAMBIOS_SUGERIDOS.filter(monto => monto >= total);
    if (!opciones.length) {
      sugerenciaCambio.innerHTML = '<strong>Cambio sugerido</strong><br><span class="muted">Sin opciones disponibles.</span>';
    } else {
      const items = opciones.map(monto => {
        const cambio = monto - total;
        return `<li>${formatearColones(monto)}‚Ç° ‚Üí ${formatearColones(cambio)}‚Ç°</li>`;
      }).join('');
      sugerenciaCambio.innerHTML = `<strong>Cambio sugerido</strong><ul>${items}</ul>`;
    }
  }
}

/* Tabla de historial y resumen global (acumula variantes) */
function cargarTabla() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.ordenes) || '[]'); }
function guardarTabla(data) { localStorage.setItem(STORAGE_KEYS.ordenes, JSON.stringify(data)); }

function construirLineasPorProducto(o) {
  const PRODS = cargarProductos();
  const lineas = [];
  for (let nombre in o.productos) {
    const prod = PRODS.find(p => p.nombre === nombre);
    const cant = o.productos[nombre];
    const icono = prod?.icono || '';
    const iconos = icono ? `${icono}√ó${cant}` : `${cant}x`;
    const vars = (o.variantes && o.variantes[nombre]) ? o.variantes[nombre] : null;
    lineas.push({ nombre, cantidad: cant, iconos, variantes: vars, tieneIcono: !!icono });
  }
  lineas.sort((a,b) => a.nombre.localeCompare(b.nombre));
  return lineas;
}
function toggleEntrega(fecha, nombreProducto) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  if (!ordenes[i].entregas) ordenes[i].entregas = {};
  ordenes[i].entregas[nombreProducto] = !ordenes[i].entregas[nombreProducto];
  guardarTabla(ordenes);
  actualizarTabla();
}
function toggleEntregaMaestro(fecha) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  const o = ordenes[i];
  const lineas = construirLineasPorProducto(o);
  if (!o.entregas) o.entregas = {};
  const allServed = lineas.length > 0 && lineas.every(l => !!o.entregas[l.nombre]);
  const target = !allServed;
  lineas.forEach(l => { o.entregas[l.nombre] = target; });
  guardarTabla(ordenes);
  actualizarTabla();
}

function actualizarTabla() {
  const PRODS = cargarProductos();
  let ordenes = cargarTabla();
  let tbody = document.querySelector('#tabla tbody');
  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  tbody.innerHTML = '';

  ordenes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(o => {
    const lineas = construirLineasPorProducto(o);
    o.entregas = o.entregas || {};
    lineas.forEach(l => { if (!(l.nombre in o.entregas)) o.entregas[l.nombre] = false; });

    const allServed = lineas.length > 0 && lineas.every(l => !!o.entregas[l.nombre]);
    const masterChecked = allServed ? 'checked' : '';
    let productosHTML = `
      <div class="productos-maestro">
        <input type="checkbox" class="master-checkbox" ${masterChecked}
              title="Marcar todo el pedido"
              onclick="toggleEntregaMaestro('${o.fecha}')">
        <span class="master-label">Pedido completo</span>
      </div>
    `;
    if (lineas.length >= 1) {
      lineas.forEach(l => {
        const checked = o.entregas[l.nombre] ? 'checked' : '';
        const desglose = l.variantes
          ? `<div class="productos-nombre indentado">${
              Object.keys(l.variantes).map(v=>`${html(v)}: ${l.variantes[v]}`).join(' ¬∑ ')
            }</div>` : '';
        const nombreProducto = l.tieneIcono
          ? ''
          : `<span class="productos-nombre">${html(l.nombre)}</span>`;
        productosHTML += `
          <div class="productos-linea">
            <input type="checkbox" class="pendiente-checkbox" ${checked}
              onclick="toggleEntrega('${o.fecha}','${jsEsc(l.nombre)}')">
            <span>${html(l.iconos)}</span>
            ${nombreProducto}
            ${desglose}
          </div>
        `;
      });
    }

    const fila = document.createElement('tr');
    if (allServed) fila.classList.add('servido');

    fila.innerHTML = `
      <td>${html(o.fecha)}</td>
      <td>${html(o.cliente || '')}</td>
      <td>${o.cantidad}‚Ç°</td>
      <td>${html(o.metodo)}</td>
      <td>${productosHTML}</td>
      <td><button onclick="eliminarOrden('${jsEsc(o.fecha)}')">‚ùå</button></td>
    `;
    tbody.appendChild(fila);

    resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
    resumen.total += o.cantidad;
    for (let p in o.productos) {
      resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
    }
    const vars = o.variantes || {};
    Object.keys(vars).forEach(base=>{
      resumen.variantes[base] = resumen.variantes[base] || {};
      Object.keys(vars[base]).forEach(vn=>{
        resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
      });
    });
  });

  let resumenTbody = document.querySelector('#tablaResumen tbody');
  resumenTbody.innerHTML = '';
  resumenTbody.innerHTML += `<tr><td>Total Recaudado</td><td>${resumen.total}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Efectivo</td><td>${resumen.efectivo || 0}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Sinpe</td><td>${resumen.sinpe || 0}‚Ç°</td></tr>`;
  for (let p in resumen.productos) {
    resumenTbody.innerHTML += `<tr><td>Ventas de ${html(p)}</td><td>${resumen.productos[p]}</td></tr>`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      const detalle = Object.keys(vars).map(v=>`${html(v)}: ${vars[v]}`).join(' ¬∑ ');
      resumenTbody.innerHTML += `<tr><td class="indentado">‚Äî ${html(p)} (variantes)</td><td>${detalle}</td></tr>`;
    }
  }
}

function eliminarOrden(fecha) {
  if (!confirm('¬øEst√°s seguro de eliminar esta orden?')) return;
  let ordenes = cargarTabla();
  ordenes = ordenes.filter(o => o.fecha !== fecha);
  guardarTabla(ordenes);
  actualizarTabla();
}

function eliminarTodasOrdenes() {
  guardarTabla([]);
  actualizarTabla();
}

function mostrarWarningEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.add('active');
  setTimeout(() => {
    const confirmBtn = overlay.querySelector('.confirm');
    if (confirmBtn) confirmBtn.focus();
  }, 0);
}

function cancelarEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.remove('active');
}

function confirmarEliminarTodos() {
  eliminarTodasOrdenes();
  cancelarEliminarTodos();
}

/* Enviar / recoger selecci√≥n */
function recogerSeleccionProductosBase() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => out[nombre] = seleccionActual[nombre].total || 0);
  return out;
}
function recogerSeleccionVariantes() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => {
    const vars = seleccionActual[nombre].variantes || {};
    if (Object.keys(vars).length) out[nombre] = {...vars};
  });
  return out;
}
function enviar() {
  const PRODS = cargarProductos();
  const totalNum = +document.getElementById('total').innerText.replace(/[^\d]/g, '');
  if (totalNum == 0) { alert('A√±ade productos'); return; }

  const metodo = document.querySelector('input[name="pago"]:checked').value;
  const productosVendidos = recogerSeleccionProductosBase();
  const variantesVendidas = recogerSeleccionVariantes();
  const cliente = (document.getElementById('cliente').value || '').trim();

  let ordenes = cargarTabla();
  const entregas = {};
  for (let nombre in productosVendidos) entregas[nombre] = false;

  ordenes.push({
    fecha: new Date().toLocaleString(),
    cliente,
    cantidad: calcularTotalDesdeMapa(productosVendidos, PRODS).total,
    metodo,
    productos: productosVendidos,
    variantes: variantesVendidas,
    entregas
  });

  guardarTabla(ordenes);
  actualizarTabla();
  borrar();
}

/* Limpiar selecci√≥n */
function borrar() {
  seleccionActual = {};
  productosNodos.forEach(p => {
    const c = p.querySelector('.contador'), r = p.querySelector('.restar');
    if (c) { c.textContent = ''; c.style.display = 'none'; }
    if (r) { r.style.display = 'none'; }
  });
  const clienteInput = document.getElementById('cliente');
  if (clienteInput) clienteInput.value = '';
  actualizarResumen();
}

/* =================== CUENTAS ABIERTAS (con variantes) =================== */
function cargarCuentas() {
  return JSON.parse(localStorage.getItem(STORAGE_KEYS.cuentas) || '{}'); // { nombre: {productos:{}, variantes:{}, creado:ts} }
}
function guardarCuentas(obj) { localStorage.setItem(STORAGE_KEYS.cuentas, JSON.stringify(obj)); }

function anadirACuentaAbierta() {
  const base = recogerSeleccionProductosBase();
  const vars = recogerSeleccionVariantes();
  const hayAlgo = Object.values(base).some(v => v > 0);
  if (!hayAlgo) { alert('A√±ade productos para pasar a la cuenta abierta'); return; }

  let nombre = (document.getElementById('cliente').value || '').trim();
  if (!nombre) nombre = nombreSugerido();

  const cuentas = cargarCuentas();
  if (!cuentas[nombre]) cuentas[nombre] = { productos:{}, variantes:{}, creado: Date.now() };

  for (let n in base) cuentas[nombre].productos[n] = (cuentas[nombre].productos[n] || 0) + base[n];
  Object.keys(vars).forEach(p=>{
    cuentas[nombre].variantes[p] = cuentas[nombre].variantes[p] || {};
    Object.keys(vars[p]).forEach(vn=>{
      cuentas[nombre].variantes[p][vn] = (cuentas[nombre].variantes[p][vn] || 0) + vars[p][vn];
    });
  });

  guardarCuentas(cuentas);
  renderCuentas();
  borrar();
}
function nombreSugerido() {
  const base = 'Misionero';
  const cuentas = cargarCuentas();
  if (!cuentas[base]) return base;
  let i = 2;
  while (cuentas[`${base} ${i}`]) i++;
  return `${base} ${i}`;
}

function resumenLineaProductosCuenta(productosMapa, variantesMapa) {
  const PRODS = cargarProductos();
  const partes = [];
  const nombres = Object.keys(productosMapa).sort((a,b)=>a.localeCompare(b));
  nombres.forEach(nombre => {
    const prod = PRODS.find(p => p.nombre === nombre);
    const cant = productosMapa[nombre];
    const icono = prod?.icono || '';
    const vars = variantesMapa?.[nombre];
    const varTxt = vars ? ' [' + Object.keys(vars).map(v=>`${v}:${vars[v]}`).join(' ¬∑ ') + ']' : '';
    partes.push(`${icono ? html(icono) : ''}√ó${cant} (${html(nombre)})${varTxt}`);
  });
  return partes.join(' ¬∑ ');
}

function renderCuentas() {
  const cont = document.getElementById('cuentasLista');
  const panel = document.getElementById('cuentasPanel');
  const cuentas = cargarCuentas();
  const entries = Object.entries(cuentas).sort((a,b)=>a[1].creado - b[1].creado);
  cont.innerHTML = '';

  if (entries.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';

  entries.forEach(([nombre, data]) => {
    const total = calcularTotalDesdeMapa(data.productos, cargarProductos()).total;
    const card = document.createElement('div');
    card.className = 'cta-card';
    const idMet = idFromName(nombre) + '-metodo';

    card.innerHTML = `
      <div class="cta-top">
        <span>${escapeHtml(nombre)}</span>
        <span>${total}‚Ç°</span>
      </div>
      <div class="cta-sub">${resumenLineaProductosCuenta(data.productos, data.variantes) || '<span class="muted">Vac√≠a</span>'}</div>
      <div class="cta-actions">
        <button onclick="anadirSeleccionA('${jsEsc(nombre)}')">A√±adir selecci√≥n</button>
        <select id="${idMet}">
          <option value="efectivo">Efectivo</option>
          <option value="sinpe">Sinpe</option>
        </select>
        <button onclick="cerrarCuenta('${jsEsc(nombre)}')">Cobrar y cerrar</button>
        <button onclick="eliminarCuenta('${jsEsc(nombre)}')">Eliminar</button>
      </div>
    `;
    cont.appendChild(card);
  });
}

function anadirSeleccionA(nombre) {
  const base = recogerSeleccionProductosBase();
  const vars = recogerSeleccionVariantes();
  const hayAlgo = Object.values(base).some(v => v > 0);
  if (!hayAlgo) { alert('A√±ade productos para sumarlos a la cuenta'); return; }

  const cuentas = cargarCuentas();
  if (!cuentas[nombre]) cuentas[nombre] = { productos:{}, variantes:{}, creado: Date.now() };

  for (let n in base) cuentas[nombre].productos[n] = (cuentas[nombre].productos[n] || 0) + base[n];
  Object.keys(vars).forEach(p=>{
    cuentas[nombre].variantes[p] = cuentas[nombre].variantes[p] || {};
    Object.keys(vars[p]).forEach(vn=>{
      cuentas[nombre].variantes[p][vn] = (cuentas[nombre].variantes[p][vn] || 0) + vars[p][vn];
    });
  });

  guardarCuentas(cuentas);
  renderCuentas();
  borrar();
}

function cerrarCuenta(nombre) {
  const cuentas = cargarCuentas();
  const data = cuentas[nombre];
  if (!data || !data.productos || Object.keys(data.productos).length === 0) {
    alert('La cuenta est√° vac√≠a.');
    return;
  }
  const idMet = idFromName(nombre) + '-metodo';
  const metodo = (document.getElementById(idMet)?.value) || 'efectivo';

  const productosMap = data.productos;
  const variantesMap = data.variantes || {};
  const entregas = {};
  Object.keys(productosMap).forEach(n => entregas[n] = true); // todo servido

  const ordenes = cargarTabla();
  ordenes.push({
    fecha: new Date().toLocaleString(),
    cliente: nombre,
    cantidad: calcularTotalDesdeMapa(productosMap, cargarProductos()).total,
    metodo,
    productos: productosMap,
    variantes: variantesMap,
    entregas
  });
  guardarTabla(ordenes);

  delete cuentas[nombre];
  guardarCuentas(cuentas);

  renderCuentas();
  actualizarTabla();
}

function eliminarCuenta(nombre) {
  if (!confirm(`¬øEliminar la cuenta abierta "${nombre}"?`)) return;
  const cuentas = cargarCuentas();
  delete cuentas[nombre];
  guardarCuentas(cuentas);
  renderCuentas();
}

/* Helpers */
function idFromName(name) { return 'cta_' + name.replace(/[^a-z0-9_-]/gi, '_'); }
function jsEsc(s){ return String(s).replace(/'/g, "\\'"); }
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* =================== PRECIO COMBO =================== */
function calcularTotalDesdeMapa(mapa, PRODS=null) {
  const PRODUCTOS = PRODS || cargarProductos();
  let total = 0;
  let individuales = { ...mapa };
  const combos = [];
  let cambios;
  do {
    cambios = false;
    const posiblesBebidas = PRODUCTOS.filter(p => p.tipo === 'bebida' && (individuales[p.nombre] || 0) > 0);
    const posiblesComidas = PRODUCTOS.filter(p => p.tipo === 'comida' && (individuales[p.nombre] || 0) > 0);
    for (let bebida of posiblesBebidas) {
      for (let comida of posiblesComidas) {
        if ((individuales[bebida.nombre] || 0) > 0 &&
            (individuales[comida.nombre] || 0) > 0 &&
            (Number(bebida.precio) + Number(comida.precio)) > Number(PRECIO_COMBO)) {
          combos.push([bebida.nombre, comida.nombre]);
          individuales[bebida.nombre]--;
          individuales[comida.nombre]--;
          cambios = true;
          break;
        }
      }
      if (cambios) break;
    }
  } while (cambios);

  const comboCantidades = {};
  combos.forEach(c => {
    const clave = c.join(' + ');
    comboCantidades[clave] = (comboCantidades[clave] || 0) + 1;
  });

  for (let combo in comboCantidades) total += comboCantidades[combo] * PRECIO_COMBO;
  for (let p in individuales) {
    const cant = individuales[p] || 0;
    if (cant > 0) {
      const precioUnitario = PRODUCTOS.find(x => x.nombre === p)?.precio || 0;
      total += cant * precioUnitario;
    }
  }
  return { total, comboCantidades, individuales };
}

/* =================== CIERRE DE CAJA (incluye variantes en resumen CSV) =================== */
function cerrarCaja() {
  if (!confirm("¬øSeguro que quieres cerrar la caja? Se enviar√° un resumen al correo y se eliminar√°n los datos actuales (las Cuentas abiertas no se tocan).")) return;

  const ordenes = cargarTabla();
  const fecha = new Date().toISOString().split('T')[0];
  const subject = `Ignis Latte - Cierre de caja ${fecha}`;
  const message = `Cierre autom√°tico generado el ${fecha}`;

  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  ordenes.forEach(o => {
    resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
    resumen.total += o.cantidad;
    for (let p in o.productos) {
      resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
    }
    const vars = o.variantes || {};
    Object.keys(vars).forEach(base=>{
      resumen.variantes[base] = resumen.variantes[base] || {};
      Object.keys(vars[base]).forEach(vn=>{
        resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
      });
    });
  });

  let tablaResumenTexto = "Resumen;Valor\n";
  tablaResumenTexto += `Total Recaudado;${resumen.total}‚Ç°\n`;
  tablaResumenTexto += `Total Efectivo;${resumen.efectivo || 0}‚Ç°\n`;
  tablaResumenTexto += `Total Sinpe;${resumen.sinpe || 0}‚Ç°\n`;
  for (let p in resumen.productos) {
    tablaResumenTexto += `Ventas de ${p};${resumen.productos[p]}\n`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      tablaResumenTexto += `Variantes de ${p};${Object.keys(vars).map(v=>`${v}:${vars[v]}`).join(' | ')}\n`;
    }
  }

  let tablaHistoricaTexto = "Fecha;Cliente;Cantidad;M√©todo\n";
  ordenes.forEach(o => {
    tablaHistoricaTexto += `${o.fecha};${o.cliente || ''};${o.cantidad}‚Ç°;${o.metodo}\n`;
  });

  emailjs.send("service_kmko3hp", "template_7xn4zvs", {
    subject, message,
    tabla_resumen: tablaResumenTexto,
    tabla_historica: tablaHistoricaTexto,
    name: "Ignis Latte",
    email: "info@ignismundi.org"
  }).then(() => {
    alert("Correo enviado con √©xito.");
    localStorage.removeItem(STORAGE_KEYS.ordenes);
    actualizarTabla();
  }, (error) => {
    console.error(error);
    alert("Error al enviar el correo: " + JSON.stringify(error));
  });
}

document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') cancelarEliminarTodos();
});

const overlayEliminarTodos = document.getElementById('warningEliminarTodos');
if (overlayEliminarTodos) {
  overlayEliminarTodos.addEventListener('click', (event) => {
    if (event.target === overlayEliminarTodos) cancelarEliminarTodos();
  });
}

/* =================== ARRANQUE (Pedidos por defecto) =================== */
crearProductos();
actualizarResumen();
actualizarTabla();
renderCuentas();
</script>
</body>
</html>
