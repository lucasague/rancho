<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ignis Latte</title>
<style>
  /* Base m√≠nimo; puedes sobreescribir desde fuera */
  body {
    font-family: Arial, sans-serif;
    --main-offset: 20%;
    --main-width: 80%;
  }
  body[data-active-tab="apertura"] {
    --main-offset: 30%;
    --main-width: 70%;
  }
  body[data-active-tab="pedidos"] {
    --main-offset: 12.5%;
    --main-width: 87.5%;
  }

  .pendientes-btn {
    position:fixed;
    top:16px;
    right:16px;
    z-index:2200;
    padding:10px 18px;
    margin:0;
    border-radius:999px;
    background:#3949ab;
    color:#fff;
    border:none;
    font-weight:bold;
    box-shadow:0 4px 14px rgba(0,0,0,0.25);
    cursor:pointer;
  }
  .pendientes-btn:hover { background:#283593; }

  .pendientes-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:flex-start;
    justify-content:flex-end;
    padding:24px;
    z-index:3000;
  }
  .pendientes-overlay.active { display:flex; }
  .pendientes-dialog {
    width:min(420px, 90vw);
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 32px rgba(0,0,0,0.35);
    padding:18px;
    max-height:80vh;
    overflow:hidden;
  }
  .pendientes-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:12px;
  }
  .pendientes-close {
    background:none;
    border:none;
    font-size:22px;
    cursor:pointer;
    line-height:1;
    color:#555;
  }
  .pendientes-tabs {
    display:flex;
    gap:8px;
    margin-bottom:14px;
  }
  .pendientes-tab {
    flex:1;
    padding:8px 12px;
    border:1px solid #c5cae9;
    border-radius:8px;
    background:#e8eaf6;
    cursor:pointer;
    font-weight:bold;
  }
  .pendientes-tab.active {
    background:#3949ab;
    color:#fff;
    border-color:#3949ab;
  }
  .pendientes-panes {
    overflow-y:auto;
    max-height:calc(80vh - 110px);
  }
  .pendientes-pane[hidden] { display:none; }
  .pendiente-card {
    border:1px solid #e0e0e0;
    border-radius:10px;
    padding:10px 12px;
    background:#fafafa;
    margin-bottom:10px;
  }
  .pendiente-card-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:6px;
  }
  .pendiente-card-header .header-left {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .pendientes-icono {
    font-size:24px;
    line-height:1;
  }
  .pendientes-total {
    font-size:13px;
    color:#3949ab;
    font-weight:bold;
  }
  .pendientes-list {
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .pendientes-list li {
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:13px;
  }
  .pendientes-list li .fila-principal {
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .pendiente-completar {
    margin-left:auto;
    background:#2e7d32;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:4px 10px;
    font-size:12px;
    cursor:pointer;
    transition:background 0.2s ease;
  }
  .pendiente-completar:hover { background:#1b5e20; }

  .sinpe-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.45);
    display:none;
    align-items:center;
    justify-content:center;
    padding:20px;
    z-index:10000;
  }
  .sinpe-overlay.active {
    display:flex;
  }
  .sinpe-dialog {
    background:#fff;
    border-radius:12px;
    box-shadow:0 15px 40px rgba(0,0,0,0.25);
    width:min(960px, 100%);
    max-height:90vh;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .sinpe-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:16px 20px;
    border-bottom:1px solid #e0e0e0;
    background:#0d47a1;
    color:#fff;
  }
  .sinpe-header h2 {
    margin:0;
    font-size:20px;
  }
  .sinpe-close {
    background:transparent;
    border:none;
    font-size:26px;
    color:#fff;
    cursor:pointer;
  }
  .sinpe-body {
    padding:20px;
    overflow:auto;
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .sinpe-grid {
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
    gap:20px;
  }
  .sinpe-column {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .sinpe-column textarea {
    min-height:160px;
    resize:vertical;
    padding:12px;
    border-radius:8px;
    border:1px solid #b0bec5;
    font-family:inherit;
  }
  .sinpe-column button {
    align-self:flex-start;
    padding:8px 16px;
    border:none;
    border-radius:20px;
    background:#0d47a1;
    color:#fff;
    font-weight:600;
    cursor:pointer;
  }
  .sinpe-column button:hover {
    background:#1565c0;
  }
  .sinpe-ayuda {
    font-size:13px;
    color:#455a64;
  }
  .sinpe-lista {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .sinpe-ordenes {
    list-style:none;
    margin:0;
    padding:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .sinpe-ordenes li {
    font-size:13px;
    color:#37474f;
    padding:4px 0;
    border-bottom:1px dashed #c5cae9;
  }
  .sinpe-ordenes li:last-child {
    border-bottom:none;
  }
  .sinpe-card {
    border:1px solid #cfd8dc;
    border-radius:10px;
    padding:14px;
    display:flex;
    flex-direction:column;
    gap:10px;
    background:#fafbff;
  }
  .sinpe-card header {
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:12px;
    flex-wrap:wrap;
  }
  .sinpe-card h3 {
    margin:0;
    font-size:18px;
  }
  .sinpe-detalle {
    font-size:13px;
    color:#455a64;
  }
  .sinpe-mensaje {
    font-size:14px;
    background:#fff;
    border-radius:8px;
    border:1px solid #eceff1;
    padding:10px;
    white-space:pre-wrap;
  }
  .sinpe-card-actions {
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
  }
  .sinpe-card-actions select {
    min-width:200px;
    padding:6px 10px;
    border-radius:6px;
    border:1px solid #b0bec5;
  }
  .sinpe-card-actions button {
    padding:6px 12px;
    border-radius:16px;
    border:1px solid #b0bec5;
    background:#eceff1;
    cursor:pointer;
  }
  .sinpe-card-actions button.confirmar {
    background:#2e7d32;
    border-color:#2e7d32;
    color:#fff;
  }
  .sinpe-card-actions button.peligro {
    background:#c62828;
    border-color:#c62828;
    color:#fff;
  }
  .sinpe-card-actions button:hover {
    filter:brightness(1.05);
  }
  .sinpe-badge {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    font-size:12px;
    font-weight:600;
    text-transform:uppercase;
  }
  .sinpe-badge--pendiente {
    background:#fff3cd;
    color:#795548;
  }
  .sinpe-badge--confirmado {
    background:#c8e6c9;
    color:#1b5e20;
  }
  .sinpe-card footer {
    font-size:12px;
    color:#607d8b;
  }
  .sinpe-coincidencias {
    font-size:13px;
    color:#2e7d32;
  }
  .sinpe-orden-pendiente {
    color:#d84315;
  }
  @media (max-width: 600px) {
    .sinpe-card-actions select {
      min-width:unset;
      flex:1 1 100%;
    }
    .sinpe-card-actions {
      flex-direction:column;
      align-items:stretch;
    }
    .sinpe-card-actions button {
      width:100%;
      justify-content:center;
    }
  }
  .pendientes-variantes {
    font-size:12px;
    color:#555;
    margin-left:4px;
  }
  .pendientes-variante {
    font-size:12px;
    color:#3949ab;
    background:#e8eaf6;
    border-radius:10px;
    padding:2px 8px;
    margin-left:4px;
  }
  .pendientes-fecha {
    font-size:11px;
    color:#888;
    display:none;
  }

  #tabla .col-fecha {
    display:none;
  }
  .pendientes-vacio {
    text-align:center;
    color:#666;
    padding:24px 0;
  }

  /* Inputs/controles con fondo transparente */
  input, select, textarea {
    background: transparent;
  }

  /* Tabs */
  .tabs {
    position:fixed;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    margin:0;
    width:auto;
  }
  .tab-content { width:100%; margin:10px 0; }

  /* Distribuci√≥n especial para pedidos en tablet horizontal */
  .pedidos-layout {
    display:flex;
    gap:20px;
    align-items:flex-start;
    margin-left:var(--main-offset);
    width:var(--main-width);
  }
  .pedidos-left,
  .pedidos-right {
    flex:1;
    min-width:0;
  }
  .pedidos-left {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .pedidos-right {
    display:flex;
    flex-direction:column;
    gap:12px;
    padding-right:4px;
  }

  .panel-nuevo-pedido {
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* Grid productos */
  .productos-grid-wrapper {
    position:relative;
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-start;
  }
  .variantes-overlay {
    position:absolute;
    left:0;
    top:0;
    width:0;
    height:0;
    pointer-events:none;
    z-index:2050;
    opacity:0;
    transition:opacity 0.18s ease;
  }
  .variantes-overlay.visible {
    opacity:1;
  }
  .variante-bubble {
    position:absolute;
    min-width:64px;
    max-width:140px;
    padding:6px 12px;
    border-radius:8px;
    border:2px solid #9fa8da;
    background:#f5f6fe;
    color:#1a237e;
    font-weight:600;
    font-size:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    box-shadow:0 6px 18px rgba(57,73,171,0.22);
    cursor:pointer;
    pointer-events:auto;
    transform:translate(-50%, -50%);
    transition:transform 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease, border-color 0.18s ease;
    white-space:nowrap;
  }
  .variante-bubble:hover {
    transform:translate(-50%, -50%) scale(1.04);
    box-shadow:0 10px 22px rgba(57,73,171,0.28);
    background-color:#eef0ff;
    border-color:#7986cb;
  }
  .grid {
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
    flex:1 1 360px;
  }
  .producto {
    border:1px solid #999; padding:9px; position:relative; font-weight:bold; font-size:14px; border-radius:6px;
    display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; /* centrado */
    min-height:60px;
    user-select:none;
    transition:box-shadow 0.2s ease, transform 0.2s ease;
  }
  .producto.activo {
    box-shadow:0 0 0 3px rgba(46,125,50,0.45);
    transform:translateY(-2px);
    z-index:50;
  }
  .icono { display:block; font-size:30px; margin-bottom:4px; line-height:1; text-align:center; }
  .contador {
    position:absolute; top:6px; right:6px; background:#000; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    display:none; text-align:center; font-size:12px;
  }
  .restar {
    position:absolute; bottom:6px; right:6px; background:#c00; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    text-align:center; cursor:pointer; display:none; font-size:14px;
  }

  button { padding:8px 14px; margin:6px; cursor:pointer; }
  .eliminar-todos-btn {
    background:#d32f2f;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:6px 12px;
    font-weight:bold;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    transition:background 0.2s ease;
  }
  .eliminar-todos-btn:hover { background:#b71c1c; }
  .limpiar-btn {
    width:108px;
    height:108px;
    border-radius:50%;
    border:none;
    background:#e0e0e0;
    color:#424242;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:6px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
    margin:0;
    padding:0;
    transition:transform 0.2s ease, box-shadow 0.2s ease;
  }
  .limpiar-btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,0.2); }
  .limpiar-btn:active { transform:translateY(0); box-shadow:0 2px 6px rgba(0,0,0,0.18); }
  .limpiar-icono {
    font-size:36px;
    line-height:1;
  }
  .limpiar-texto {
    font-size:14px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  table { margin:16px auto; width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; vertical-align: middle; text-align:left; }
  .resumen-panel {
    display:grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap:12px;
    width:100%;
    align-items:flex-start;
  }
  .resumen-panel > div {
    background:#f9f9f9;
    border:1px solid #ddd;
    border-radius:6px;
    padding:10px;
  }
  #resumenOrden,
  #total,
  #sugerenciaCambio {
    text-align:left;
    width:100%;
  }
  #sugerenciaCambio ul {
    list-style:none;
    padding:0;
    margin:8px 0 0 0;
  }
  #sugerenciaCambio li { margin-bottom:4px; }
  .indentado { padding-left:20px; color:#555; font-size:90%; text-align:left; }

  .warning-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:20px;
  }
  .warning-overlay.active { display:flex; }
  .warning-dialog {
    background:#fff8e1;
    border:4px solid #ff6f00;
    padding:30px 26px;
    max-width:520px;
    width:100%;
    text-align:center;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,0.45);
    animation:warning-pop 0.25s ease-out;
  }
  .warning-dialog h2 {
    margin:0 0 18px 0;
    color:#d84315;
    font-size:30px;
    text-transform:uppercase;
    letter-spacing:1px;
  }
  .warning-dialog p {
    margin:0 0 24px 0;
    color:#5d4037;
    font-size:18px;
    line-height:1.5;
  }
  .warning-actions {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    justify-content:center;
  }
  .warning-actions button {
    border:none;
    border-radius:8px;
    padding:10px 20px;
    font-weight:bold;
    cursor:pointer;
    font-size:16px;
  }
  .warning-actions .confirm { background:#d32f2f; color:#fff; }
  .warning-actions .confirm:hover { background:#b71c1c; }
  .warning-actions .cancel { background:#eceff1; color:#37474f; }
  .warning-actions .cancel:hover { background:#cfd8dc; }

  @keyframes warning-pop {
    from { transform:scale(0.8); opacity:0; }
    to { transform:scale(1); opacity:1; }
  }

  .pendiente-checkbox { width:16px; height:16px; cursor:pointer; vertical-align:middle; margin-right:6px; }

  tr.servido { opacity:0.35; }
  tr.cuenta-abierta { background:#fff9e6; }

  #cliente {
    padding:7px 10px; width:min(520px, 100%); margin:10px 0 0 0; display:block;
    border:1px solid #ccc; border-radius:6px; font-size:14px;
  }

  .productos-linea {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:8px;
    margin-bottom:6px;
    flex-wrap:wrap;
    text-align:right;
  }
  .productos-nombre { font-size:12px; color:#666; margin-left:6px; }
  .productos-linea .productos-nombre.indentado {
    width:100%;
    margin-left:0;
    text-align:right;
  }
  .productos-maestro {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:10px;
    margin-bottom:8px;
    text-align:right;
  }
  .master-checkbox { width:20px; height:20px; cursor:pointer; transform:scale(1.2); transform-origin:left center; }
  .master-label { font-weight:bold; font-size:14px; color:#333; }

  .metodos-acciones {
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .metodo-toggle {
    display:flex;
    gap:6px;
    background:#e5e5e5;
    border-radius:999px;
    padding:6px;
    box-shadow:inset 0 1px 3px rgba(0,0,0,0.08);
    flex:1 1 220px;
    max-width:320px;
  }
  .metodo-toggle input[type="radio"] {
    display:none;
  }
  .metodo-toggle label {
    flex:1;
    text-align:center;
    padding:10px 0;
    border-radius:999px;
    font-weight:600;
    letter-spacing:0.4px;
    cursor:pointer;
    color:#555;
    transition:background 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
  }
  .botones-acciones {
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
  }
  .sinpe-sync {
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:10px 12px;
    border:1px dashed #0d47a1;
    border-radius:8px;
    background:#eef4ff;
  }
  .sinpe-sync button {
    align-self:flex-start;
    padding:6px 12px;
    border-radius:16px;
    border:1px solid #0d47a1;
    background:#0d47a1;
    color:#fff;
    font-weight:600;
    cursor:pointer;
  }
  .sinpe-sync button:hover {
    background:#1565c0;
    border-color:#1565c0;
  }
  .sinpe-sync .muted {
    font-size:13px;
  }
  #pagoEfectivo:checked + label {
    background:#d9f2d9;
    color:#1b5e20;
    box-shadow:0 4px 12px rgba(27,94,32,0.25);
  }
  #pagoSinpe:checked + label {
    background:#e0ebff;
    color:#1b3c8a;
    box-shadow:0 4px 12px rgba(27,60,138,0.25);
  }
  .accion-redonda {
    width:60px;
    height:60px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:11px;
    line-height:1.1;
    text-align:center;
    word-break:break-word;
    padding:0 8px;
    border:none;
    margin:0;
    box-shadow:0 6px 20px rgba(0,0,0,0.18);
    transition:transform 0.2s ease, box-shadow 0.2s ease;
  }
  .accion-redonda:active { transform:scale(0.96); }
  .accion-redonda:hover { box-shadow:0 8px 24px rgba(0,0,0,0.22); }
  .accion-redonda:focus-visible {
    outline:3px solid #fff;
    outline-offset:2px;
    box-shadow:0 0 0 4px rgba(57,73,171,0.45);
  }

  .boton-enviar {
    border:3px solid #2e7d32;
    background-color:#2e7d32;
    color:#fff;
  }
  .boton-pendiente {
    border:3px solid #fbc02d;
    background:#fbc02d;
    color:#4e342e;
    font-weight:700;
  }

  @media (max-width: 1024px) {
    .accion-redonda {
      width:54px;
      height:54px;
      font-size:10px;
    }
    .botones-acciones { justify-content:flex-start; }
    .variantes-panel {
      min-width:100%;
      max-width:none;
      order:-1;
    }
  }
  @media (max-width: 640px) {
    .grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
  @media (max-width: 420px) {
    .grid {
      grid-template-columns:1fr;
    }
    .accion-redonda {
      width:50px;
      height:50px;
      font-size:9px;
    }
  }
  .btn-cierre-caja {
    background:#fdeaea;
    border:2px solid #d64b4b;
    color:#8a1e1e;
  }
  .btn-cierre-caja:hover {
    background:#f8d0d0;
    border-color:#c03a3a;
  }

  @media (max-width: 1024px) {
    .pedidos-layout { flex-direction:column; }
  }

  @media (max-width: 900px) {
    .productos-editor {
      margin-left:0;
      width:100%;
    }
    .pedidos-layout {
      margin-left:0;
      width:100%;
    }
    .tab-content {
      width:95%;
      margin:10px auto;
    }
    .tabs {
      margin:10px auto;
      width:95%;
      justify-content:center;
    }
    .productos-grid-wrapper {
      justify-content:center;
    }
    .variantes-panel {
      order:-1;
      width:100%;
      max-width:none;
    }
    .grid {
      flex:1 1 260px;
    }
    .limpiar-btn {
      align-self:center;
    }
  }

  @media (max-width: 768px) {
    .resumen-panel {
      grid-template-columns:1fr;
    }
  }

  /* Cuentas abiertas */
  #cuentasPanel { display:none; width:100%; margin:16px 0 8px 0; text-align:left; }
  #cuentasHeader { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; }
  #cuentasLista { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:8px; }
  .cta-card { border:1px solid #ddd; border-radius:8px; padding:8px 10px; background:#fafafa; line-height:1.2; }
  .cta-top { display:flex; align-items:center; justify-content:space-between; margin-bottom:6px; font-size:14px; font-weight:bold; }
  .cta-sub { font-size:12px; color:#555; margin-bottom:6px; }
  .cta-actions { display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
  .cta-actions button { padding:6px 10px; margin:0; font-size:12px; }
  .cta-actions select { padding:4px 6px; font-size:12px; }
  .muted { color:#666; font-size:12px; }

  /* Editor de productos */
  #tabProductos {
    position:relative;
  }
  .productos-editor {
    margin-left:var(--main-offset);
    width:var(--main-width);
  }
  .editor-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:8px 0; }
  .small { font-size:12px; color:#555; }
  .number { width:110px; }
  .tipo-select { width:130px; }
  .icono-input { width:100px; }
  .nombre-input { width:100%; }
  .variantes-input {
    width:100%;
  }
  .variantes-input::placeholder {
    color:rgba(57,73,171,0.35);
  }
  .help { font-size:12px; color:#666; margin-top:-4px; }

  /* Paneles con tercio en blanco */
  .panel-tercio {
    margin-left:var(--main-offset);
    width:var(--main-width);
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .apertura-card,
  .cierre-card {
    background:#f9f9f9;
    border:1px solid #ddd;
    border-radius:10px;
    padding:18px;
    box-shadow:0 4px 10px rgba(0,0,0,0.04);
  }
  .apertura-card h2,
  .cierre-card h2 {
    margin-top:0;
  }

  .tabla-responsables {
    width:100%;
    border-collapse:collapse;
  }
  .tabla-responsables td {
    border:1px solid #ddd;
    padding:10px;
  }
  .responsable-label {
    display:flex;
    align-items:center;
    gap:12px;
    cursor:pointer;
    font-weight:600;
  }
  .responsable-label input {
    width:18px;
    height:18px;
  }
  .responsable-icon {
    font-size:28px;
  }
  .apertura-resumen {
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:15px;
  }

  .fondo-input-group {
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
  }
  .fondo-input-group input[type="text"] {
    padding:8px 10px;
    border:1px solid #ccc;
    border-radius:6px;
    min-width:160px;
  }
  .toggle-breakdown {
    padding:8px 14px;
    border:1px solid #999;
    border-radius:6px;
    background:#fff;
    cursor:pointer;
  }
  .toggle-breakdown[aria-expanded="true"] {
    background:#e0f0ff;
    border-color:#007bff;
    font-weight:bold;
  }

  .cash-breakdown {
    display:none;
    margin-top:12px;
  }
  .cash-breakdown.open {
    display:block;
  }
  .cash-breakdown table {
    width:100%;
    border-collapse:collapse;
  }
  .cash-breakdown th,
  .cash-breakdown td {
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
  }
  .den-label {
    font-weight:bold;
  }
  .billete-1000 { background:#ffe0e0; }
  .billete-2000 { background:#e0ecff; }
  .billete-5000 { background:#fff9db; }
  .billete-10000 { background:#e0ffe0; }
  .billete-20000 { background:#ffe9d6; }
  .cash-total {
    margin-top:10px;
    text-align:right;
    font-weight:bold;
  }
  .cash-count {
    width:80px;
    padding:6px;
    border:1px solid #ccc;
    border-radius:6px;
  }
  .cash-breakdown caption {
    caption-side:top;
    text-align:left;
    font-weight:bold;
    padding-bottom:6px;
  }

  .cierre-layout {
    display:flex;
    flex-wrap:wrap;
    gap:20px;
  }
  .cierre-left,
  .cierre-right {
    flex:1 1 320px;
  }
  .cierre-datos {
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:16px;
    font-size:15px;
  }
  .diferencia {
    font-weight:bold;
  }
  .diferencia-positivo { color:#2e7d32; }
  .diferencia-negativo { color:#c62828; }
  .diferencia-neutro { color:#37474f; }

  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance:none;
    margin:0;
  }
  input[type=number] {
    -moz-appearance:textfield;
  }

  @media (max-width: 768px) {
    .panel-tercio {
      margin-left:0;
      width:100%;
    }
  }
</style>
</head>
<body>

<button type="button" id="verPendientesBtn" class="pendientes-btn">Pendientes</button>

<div id="pendientesOverlay" class="pendientes-overlay" aria-hidden="true">
  <div class="pendientes-dialog" role="dialog" aria-modal="true" aria-labelledby="pendientesTitulo">
    <div class="pendientes-header">
      <h2 id="pendientesTitulo" style="margin:0; font-size:20px;">Pendientes por servir</h2>
      <button type="button" class="pendientes-close" aria-label="Cerrar ventana de pendientes">√ó</button>
    </div>
    <div class="pendientes-tabs" role="tablist">
      <button type="button" id="pendientes-tab-cliente" class="pendientes-tab active" data-tab="cliente" role="tab" aria-selected="true" aria-controls="pendientesPorCliente">Por cliente</button>
      <button type="button" id="pendientes-tab-producto" class="pendientes-tab" data-tab="producto" role="tab" aria-selected="false" aria-controls="pendientesPorProducto">Por producto</button>
    </div>
    <div class="pendientes-panes">
      <div id="pendientesPorCliente" class="pendientes-pane" role="tabpanel" aria-labelledby="pendientes-tab-cliente"></div>
      <div id="pendientesPorProducto" class="pendientes-pane" role="tabpanel" aria-labelledby="pendientes-tab-producto" hidden></div>
    </div>
  </div>
</div>

<div id="sinpeOverlay" class="sinpe-overlay" aria-hidden="true">
  <div class="sinpe-dialog" role="dialog" aria-modal="true" aria-labelledby="sinpeTitulo">
    <div class="sinpe-header">
      <h2 id="sinpeTitulo" style="margin:0;">Conciliaci√≥n de pagos Sinpe</h2>
      <button type="button" class="sinpe-close" aria-label="Cerrar conciliador de Sinpe" onclick="cerrarSinpeOverlay()">√ó</button>
    </div>
    <div class="sinpe-body">
      <div class="sinpe-grid">
        <div class="sinpe-column">
          <label for="sinpeMensajes" class="sinpe-ayuda"><strong>Pega aqu√≠ los SMS recibidos</strong> (uno por l√≠nea o separados por un espacio en blanco).</label>
          <textarea id="sinpeMensajes" placeholder="SINPE M√ìVIL: Has recibido 5 000,00 CRC de..."></textarea>
          <button type="button" onclick="procesarMensajesSinpe()">Guardar SMS</button>
          <p class="sinpe-ayuda">Los mensajes se guardan localmente. Se extraen montos, referencias y remitentes cuando es posible.</p>
        </div>
        <div class="sinpe-column">
          <div class="sinpe-ayuda"><strong>√ìrdenes con m√©todo Sinpe pendientes:</strong></div>
          <ul id="sinpeOrdenesPendientes" class="sinpe-ordenes"></ul>
          <p class="sinpe-ayuda">Si se detecta una coincidencia √∫nica por monto, el sistema la vincula autom√°ticamente.</p>
        </div>
      </div>
      <div class="sinpe-ayuda"><strong>Pagos registrados</strong></div>
      <div id="sinpePagosLista" class="sinpe-lista"></div>
    </div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <button id="tabAperturaBtn" class="tab-btn active" onclick="mostrarTab('apertura')">Apertura</button>
  <button id="tabProductosBtn" class="tab-btn" onclick="mostrarTab('productos')">Productos</button>
  <button id="tabPedidosBtn" class="tab-btn" onclick="mostrarTab('pedidos')">Pedidos</button>
  <button id="tabCierreBtn" class="tab-btn" onclick="mostrarTab('cierre')">Cierre</button>
</div>

<!-- TAB: APERTURA -->
<section id="tabApertura" class="tab-content">
  <div class="panel-tercio">
    <div class="apertura-card">
      <h2>Apertura de caja</h2>
      <p>Selecciona el responsable de hoy:</p>
      <table class="tabla-responsables">
        <tbody>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Marijuan">
                <span class="responsable-icon">üíë</span>
                <span>Marijuan</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Gabymario">
                <span class="responsable-icon">üíë</span>
                <span>Gabymario</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Glorilucas" checked>
                <span class="responsable-icon">üíë</span>
                <span>Glorilucas</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Edurrosa">
                <span class="responsable-icon">üíë</span>
                <span>Edurrosa</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Coridaniel">
                <span class="responsable-icon">üíë</span>
                <span>Coridaniel</span>
              </label>
            </td>
          </tr>
          <tr>
            <td>
              <label class="responsable-label">
                <input type="radio" name="responsableHoy" value="Mausicaco">
                <span class="responsable-icon">üíë</span>
                <span>Mausicaco</span>
              </label>
            </td>
          </tr>
        </tbody>
      </table>
      <div class="apertura-resumen">
        <span>Responsable seleccionado: <strong id="aperturaResponsableActual">Glorilucas</strong></span>
      </div>
    </div>

    <div class="apertura-card">
      <h3>Fondo de caja</h3>
      <p>Introduce el fondo inicial manualmente o detallando billetes y monedas.</p>
      <div class="fondo-input-group">
        <input id="fondoCajaInput" type="text" inputmode="numeric" value="10000" placeholder="‚Ç°" aria-label="Fondo de caja">
        <button type="button" class="toggle-breakdown" data-target="aperturaBreakdown" aria-expanded="false">Introducir billetes y monedas</button>
      </div>
      <div id="aperturaBreakdown" class="cash-breakdown" data-context="apertura">
        <table>
          <thead>
            <tr>
              <th>Denominaci√≥n</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody data-breakdown-body="apertura"></tbody>
        </table>
        <div class="cash-total">Total contado: <span data-breakdown-total="apertura">0‚Ç°</span></div>
      </div>
      <div class="apertura-resumen">
        <span>Fondo configurado: <strong id="aperturaFondoActual">10¬†000‚Ç°</strong></span>
      </div>
    </div>
  </div>
</section>

<!-- TAB: PEDIDOS -->
<section id="tabPedidos" class="tab-content" style="display:none;">
  <div class="pedidos-layout">
    <div class="pedidos-left">
      <table id="tabla">
        <thead>
          <tr>
            <th class="col-fecha">Fecha</th>
            <th>Cliente</th>
            <th>Importe</th>
            <th>M√©todo</th>
            <th>Productos</th>
            <th><button type="button" class="eliminar-todos-btn" onclick="mostrarWarningEliminarTodos()">Eliminar</button></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>

    <div class="pedidos-right">
      <div class="panel-nuevo-pedido">
        <div class="productos-grid-wrapper">
          <div class="grid" id="productosGrid"></div>
          <div id="variantesOverlay" class="variantes-overlay" hidden></div>
          <button type="button" class="limpiar-btn" onclick="borrar()">
            <span class="limpiar-icono" aria-hidden="true">üóëÔ∏è</span>
            <span class="limpiar-texto">Borrar</span>
          </button>
        </div>

        <input id="cliente" type="text" placeholder="Nombre del cliente (opcional)">
        <div class="metodos-acciones">
          <div class="botones-acciones">
            <div class="metodo-toggle" role="radiogroup" aria-label="M√©todo de pago">
              <input type="radio" id="pagoEfectivo" name="pago" value="efectivo" checked>
              <label for="pagoEfectivo">Efectivo</label>
              <input type="radio" id="pagoSinpe" name="pago" value="sinpe">
              <label for="pagoSinpe">Sinpe</label>
            </div>
            <button class="accion-redonda boton-enviar" onclick="enviar()">Enviar</button>
            <button class="accion-redonda boton-pendiente" onclick="anadirACuentaAbierta()">Pendiente</button>
          </div>
          <div class="sinpe-sync">
            <button type="button" onclick="abrirSinpeOverlay()">Conciliar pagos Sinpe</button>
            <span class="muted">Pega los SMS recibidos para asociarlos con las √≥rdenes Sinpe y marcar los pagos como confirmados.</span>
          </div>
        </div>

        <div class="resumen-panel">
          <div id="resumenOrden"><span class="muted">Sin productos seleccionados</span></div>
          <div id="total"><strong>Total: 0‚Ç°</strong></div>
          <div id="sugerenciaCambio"><strong>Cambio</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span></div>
        </div>
      </div>
      <section id="cuentasPanel">
        <div id="cuentasHeader">
          <h2 style="margin:0;font-size:16px;">Cuentas abiertas</h2>
          <span class="muted">Crea cuentas con ‚ÄúA√±adir a cuenta abierta‚Äù usando el nombre del campo Cliente.</span>
        </div>
        <div id="cuentasLista"></div>
      </section>
    </div>
  </div>
</section>

<!-- TAB: CIERRE -->
<section id="tabCierre" class="tab-content" style="display:none;">
  <div class="panel-tercio">
    <div class="cierre-layout">
      <div class="cierre-left cierre-card">
        <h2>Resumen del d√≠a</h2>
        <table id="tablaResumen">
          <thead><tr><th>Resumen</th><th>Valor</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="cierre-datos">
          <span>Responsable: <strong id="cierreResponsable">Glorilucas</strong></span>
          <span>Fondo inicial: <strong id="cierreFondoInicial">10¬†000‚Ç°</strong></span>
          <span>Efectivo esperado en caja: <strong id="cierreEsperado">10¬†000‚Ç°</strong></span>
        </div>
      </div>
      <div class="cierre-right cierre-card">
        <h2>Conteo de caja</h2>
        <p>Ingresa el efectivo contado directamente o det√°llalo por denominaciones.</p>
        <div class="fondo-input-group">
          <input id="cierreEfectivoInput" type="text" inputmode="numeric" placeholder="‚Ç°" aria-label="Efectivo contado">
          <button type="button" class="toggle-breakdown" data-target="cierreBreakdown" aria-expanded="false">Introducir billetes y monedas</button>
        </div>
        <div id="cierreBreakdown" class="cash-breakdown" data-context="cierre">
          <table>
            <thead>
              <tr>
                <th>Denominaci√≥n</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody data-breakdown-body="cierre"></tbody>
          </table>
          <div class="cash-total">Total contado: <span data-breakdown-total="cierre">0‚Ç°</span></div>
        </div>
        <div class="cierre-datos">
          <span>Efectivo contado: <strong id="cierreEfectivoContado">0‚Ç°</strong></span>
          <span>Diferencia con fondo inicial: <strong id="cierreNeto">0‚Ç°</strong></span>
          <span>Ventas en efectivo registradas: <strong id="cierreVentasEfectivo">0‚Ç°</strong></span>
          <span class="diferencia diferencia-neutro" id="cierreDiferencia">Cuadra (0‚Ç°)</span>
        </div>
        <button class="btn-cierre-caja" onclick="cerrarCaja()">Cierre de caja</button>
      </div>
    </div>
  </div>
</section>

<!-- TAB: PRODUCTOS (editor) -->
<section id="tabProductos" class="tab-content" style="display:none;">
  <div class="productos-editor">
    <h2 style="margin:0 0 10px 0; text-align:center;">Editor de productos</h2>
    <p class="help" style="text-align:center;">Puedes a√±adir <strong>variantes</strong> separadas por comas (p. ej. ‚ÄúVariante A, Variante B, Variante C‚Äù). Toca un producto con variantes para ver el men√∫ flotante alrededor de √©l.</p>

    <div class="editor-actions">
      <button onclick="agregarFilaProducto()">A√±adir fila</button>
      <button onclick="guardarProductosDesdeTabla()">Guardar cambios</button>
      <button onclick="restablecerProductos()">Restablecer por defecto</button>
      <span class="small" id="estadoGuardado"></span>
    </div>

    <table id="tablaProductos">
      <thead>
        <tr>
          <th style="width:24%;">Nombre</th>
          <th style="width:14%;">Precio (‚Ç°)</th>
          <th style="width:14%;">Tipo</th>
          <th style="width:14%;">Icono(s)</th>
          <th style="width:30%;">Variantes (coma)</th>
          <th style="width:4%;">Borrar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="help" style="text-align:center;">Los cambios guardados aparecen en la pesta√±a ‚ÄúPedidos‚Äù.</div>
  </div>
</section>

<!-- EmailJS -->
<div id="warningEliminarTodos" class="warning-overlay" role="alertdialog" aria-modal="true"
     aria-labelledby="warningEliminarTitulo" aria-describedby="warningEliminarDescripcion">
  <div class="warning-dialog">
    <h2 id="warningEliminarTitulo">¬°Advertencia!</h2>
    <p id="warningEliminarDescripcion">Esta acci√≥n eliminar√° <strong>todo</strong> el historial de √≥rdenes. No se podr√° recuperar la informaci√≥n.</p>
    <div class="warning-actions">
      <button class="confirm" type="button" onclick="confirmarEliminarTodos()">S√≠, eliminar todo</button>
      <button class="cancel" type="button" onclick="cancelarEliminarTodos()">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>(function(){ emailjs.init({ publicKey: "rzMljmZB066lvsYyE" }); })();</script>

<script>
/* =================== CONFIG / ALMACEN =================== */
const STORAGE_KEYS = {
  productos: 'ignis_productos_v2', // v2 por variantes
  ordenes: 'ordenes_v2',
  cuentas: 'cuentas_abiertas_v2',
  apertura: 'config_apertura_caja_v1',
  sinpe: 'sinpe_pagos_v1'
};

const PRECIO_COMBO = 999999; // tu valor actual
const CAMBIOS_SUGERIDOS = [1000, 2000, 5000, 10000];

const PRODUCTOS_POR_DEFECTO = [
  { nombre: 'Caf√©', precio: 500, tipo: 'bebida', icono: '‚òï', variantes: [] },
  { nombre: 'Fresco', precio: 500, tipo: 'bebida', icono: 'ü•§', variantes: [] },
  { nombre: 'Helado', precio: 700, tipo: 'bebida', icono: 'üçß', variantes: [] },
  { nombre: 'Mr Beast', precio: 600, tipo: 'bebida', icono: 'üç´', variantes: [] },
  { nombre: 'Galletas', precio: 300, tipo: 'comida', icono: 'üç™', variantes: [] },
  { nombre: 'Crepa', precio: 1000, tipo: 'comida', icono: 'ü•û', variantes: [] },
  // Empanada unificada con variantes
  { nombre: 'Empanada', precio: 700, tipo: 'comida', icono: 'ü•ü', variantes: ['Queso', 'Frijol', 'Mixta'] },
  { nombre: 'Emp. pizza', precio: 1000, tipo: 'comida', icono: 'üçï', variantes: [] },
  { nombre: 'Gallo', precio: 1000, tipo: 'comida', icono: 'üå≠', variantes: [] }
];

const RESPONSABLES = ['Marijuan', 'Gabymario', 'Glorilucas', 'Edurrosa', 'Coridaniel', 'Mausicaco'];
const DENOMINACIONES = [
  { valor: 20000, tipo: 'billete', clase: 'billete-20000' },
  { valor: 10000, tipo: 'billete', clase: 'billete-10000' },
  { valor: 5000, tipo: 'billete', clase: 'billete-5000' },
  { valor: 2000, tipo: 'billete', clase: 'billete-2000' },
  { valor: 1000, tipo: 'billete', clase: 'billete-1000' },
  { valor: 500, tipo: 'moneda', clase: '' },
  { valor: 100, tipo: 'moneda', clase: '' },
  { valor: 50, tipo: 'moneda', clase: '' },
  { valor: 25, tipo: 'moneda', clase: '' },
  { valor: 10, tipo: 'moneda', clase: '' }
];

let configApertura = cargarConfigApertura();
let ultimoResumen = { efectivo: 0, sinpe: 0, total: 0 };

function cargarConfigApertura() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.apertura);
    if (!raw) return { responsable: 'Glorilucas', fondo: 10000 };
    const data = JSON.parse(raw);
    const responsable = RESPONSABLES.includes(data?.responsable) ? data.responsable : 'Glorilucas';
    const fondo = Number.parseInt(data?.fondo, 10);
    return {
      responsable,
      fondo: Number.isFinite(fondo) && fondo >= 0 ? fondo : 10000
    };
  } catch {
    return { responsable: 'Glorilucas', fondo: 10000 };
  }
}
function guardarConfigApertura() {
  localStorage.setItem(STORAGE_KEYS.apertura, JSON.stringify({
    responsable: configApertura.responsable,
    fondo: configApertura.fondo
  }));
}

function cargarPagosSinpe() {
  try {
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEYS.sinpe) || '[]');
    if (!Array.isArray(raw)) return [];
    return raw.map(pago => ({
      id: pago.id || generarIdSinpe(),
      monto: Number.parseInt(pago.monto, 10) || 0,
      referencia: pago.referencia ? String(pago.referencia).toUpperCase() : null,
      remitente: pago.remitente ? String(pago.remitente) : null,
      mensaje: pago.mensaje ? String(pago.mensaje) : '',
      creadoEn: Number.isFinite(pago.creadoEn) ? Number(pago.creadoEn) : Date.now(),
      ordenFecha: pago.ordenFecha ? String(pago.ordenFecha) : null
    })).filter(p => p.monto > 0 && p.mensaje);
  } catch {
    return [];
  }
}

function guardarPagosSinpe(pagos) {
  if (!Array.isArray(pagos)) return;
  localStorage.setItem(STORAGE_KEYS.sinpe, JSON.stringify(pagos));
}

function generarIdSinpe() {
  return `sinpe_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;
}

function normalizarMensajeSinpe(texto) {
  return String(texto || '').replace(/\s+/g, ' ').trim();
}

function extraerDatosSinpeDesdeMensaje(texto) {
  const limpio = normalizarMensajeSinpe(texto);
  if (!limpio) return null;

  const montos = [];
  const montoRegex = /(?:‚Ç°|¬¢|CRC|COL|colones?)?\s*([\d.]{1,3}(?:[.,]\d{3})*(?:[.,]\d{2})?|\d{3,})/gi;
  let match;
  while ((match = montoRegex.exec(limpio)) !== null) {
    const valor = parseColones(match[1]);
    if (valor > 0) montos.push(valor);
  }
  const monto = montos.length ? Math.max(...montos) : 0;
  if (!monto) return null;

  const referenciaMatch = limpio.match(/ref(?:erencia)?[:\s-]*([A-Za-z0-9]+)/i);
  const referencia = referenciaMatch ? referenciaMatch[1].toUpperCase() : null;

  const remitenteMatch = limpio.match(/de\s+([A-Za-z√Å√â√ç√ì√ö√ú√ë√°√©√≠√≥√∫√º√±\s]{3,40})/i);
  let remitente = remitenteMatch ? remitenteMatch[1].trim() : null;
  if (remitente) {
    remitente = remitente.replace(/(colones?|crc|‚Ç°|ref.*)$/i, '').trim();
    if (!remitente) remitente = null;
  }

  return {
    monto,
    referencia,
    remitente,
    mensaje: limpio
  };
}

function dividirMensajesSinpe(raw) {
  if (!raw) return [];
  const texto = String(raw).trim();
  if (!texto) return [];
  let bloques = texto.split(/(?:\r?\n){2,}/).map(b => b.trim()).filter(Boolean);
  if (bloques.length <= 1) {
    bloques = texto.split(/\r?\n/).map(b => b.trim()).filter(Boolean);
  }
  if (bloques.length <= 1) {
    bloques = texto.split(/\s{3,}/).map(b => b.trim()).filter(Boolean);
  }
  return bloques;
}
function parseColones(valor) {
  if (valor === null || valor === undefined) return 0;
  const limpio = String(valor).replace(/[^\d]/g, '');
  return limpio ? Number.parseInt(limpio, 10) : 0;
}
function obtenerFondoInicial() {
  return Number.isFinite(configApertura?.fondo) ? Number(configApertura.fondo) : 0;
}
function etiquetaDenominacion(den) {
  const prefijo = den.tipo === 'billete' ? 'Billete' : 'Moneda';
  return `${prefijo} ‚Ç°${formatearColones(den.valor)}`;
}
function aplicarConfigApertura() {
  const fondoInput = document.getElementById('fondoCajaInput');
  if (fondoInput) fondoInput.value = obtenerFondoInicial().toString();
  const radios = document.querySelectorAll('input[name="responsableHoy"]');
  radios.forEach(radio => {
    radio.checked = radio.value === configApertura.responsable;
  });
}
function actualizarResumenApertura() {
  const responsableActual = configApertura.responsable || 'Glorilucas';
  const fondo = obtenerFondoInicial();
  const respSpan = document.getElementById('aperturaResponsableActual');
  if (respSpan) respSpan.textContent = responsableActual;
  const fondoSpan = document.getElementById('aperturaFondoActual');
  if (fondoSpan) fondoSpan.textContent = `${formatearColones(fondo)}‚Ç°`;
  actualizarPanelCierre();
}
function inicializarBreakdown(contexto) {
  const tbody = document.querySelector(`tbody[data-breakdown-body="${contexto}"]`);
  if (!tbody) return;
  tbody.innerHTML = '';
  DENOMINACIONES.forEach(den => {
    const tr = document.createElement('tr');
    const claseExtra = den.clase ? ` ${den.clase}` : '';
    tr.innerHTML = `
      <td class="den-label${claseExtra}">${etiquetaDenominacion(den)}</td>
      <td><input type="number" min="0" step="1" class="cash-count" data-context="${contexto}" data-valor="${den.valor}"></td>
      <td class="cash-subtotal">0‚Ç°</td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(`.cash-count[data-context="${contexto}"]`).forEach(input => {
    input.addEventListener('input', () => actualizarBreakdown(contexto));
  });
}
function actualizarBreakdown(contexto) {
  const inputs = Array.from(document.querySelectorAll(`.cash-count[data-context="${contexto}"]`));
  if (inputs.length === 0) return;
  let total = 0;
  let hayValores = false;
  inputs.forEach(input => {
    const cantidadStr = (input.value || '').trim();
    const cantidad = Number.parseInt(cantidadStr, 10);
    if (cantidadStr !== '') hayValores = true;
    const valor = Number(input.dataset.valor || 0);
    const subtotal = Number.isFinite(cantidad) && cantidad > 0 ? cantidad * valor : 0;
    total += subtotal;
    const celda = input.closest('tr')?.querySelector('.cash-subtotal');
    if (celda) celda.textContent = `${formatearColones(subtotal)}‚Ç°`;
  });
  const totalSpan = document.querySelector(`[data-breakdown-total="${contexto}"]`);
  if (totalSpan) totalSpan.textContent = `${formatearColones(total)}‚Ç°`;
  if (!hayValores) {
    if (contexto === 'apertura') {
      actualizarResumenApertura();
    } else {
      actualizarPanelCierre();
    }
    return;
  }
  const targetInputId = contexto === 'apertura' ? 'fondoCajaInput' : 'cierreEfectivoInput';
  const targetInput = document.getElementById(targetInputId);
  if (targetInput) targetInput.value = total.toString();
  if (contexto === 'apertura') {
    configApertura.fondo = total;
    guardarConfigApertura();
    actualizarResumenApertura();
  } else {
    actualizarPanelCierre();
  }
}
function toggleBreakdownById(id, boton) {
  const panel = document.getElementById(id);
  if (!panel) return;
  const activo = !panel.classList.contains('open');
  panel.classList.toggle('open', activo);
  if (boton) boton.setAttribute('aria-expanded', activo ? 'true' : 'false');
  if (activo) {
    const primerInput = panel.querySelector('input.cash-count');
    if (primerInput) primerInput.focus();
  }
}
function actualizarPanelCierre() {
  const fondo = obtenerFondoInicial();
  const ventasEfectivo = Number(ultimoResumen.efectivo || 0);
  const cierreInput = document.getElementById('cierreEfectivoInput');
  const contado = cierreInput ? parseColones(cierreInput.value) : 0;
  const neto = contado - fondo;
  const esperado = fondo + ventasEfectivo;
  const diferencia = contado - esperado;

  const responsableSpan = document.getElementById('cierreResponsable');
  if (responsableSpan) responsableSpan.textContent = configApertura.responsable || 'Glorilucas';
  const fondoSpan = document.getElementById('cierreFondoInicial');
  if (fondoSpan) fondoSpan.textContent = `${formatearColones(fondo)}‚Ç°`;
  const esperadoSpan = document.getElementById('cierreEsperado');
  if (esperadoSpan) esperadoSpan.textContent = `${formatearColones(esperado)}‚Ç°`;
  const contadoSpan = document.getElementById('cierreEfectivoContado');
  if (contadoSpan) contadoSpan.textContent = `${formatearColones(contado)}‚Ç°`;
  const netoSpan = document.getElementById('cierreNeto');
  if (netoSpan) netoSpan.textContent = `${formatearColones(neto)}‚Ç°`;
  const ventasSpan = document.getElementById('cierreVentasEfectivo');
  if (ventasSpan) ventasSpan.textContent = `${formatearColones(ventasEfectivo)}‚Ç°`;

  const diffSpan = document.getElementById('cierreDiferencia');
  if (diffSpan) {
    diffSpan.classList.remove('diferencia-positivo', 'diferencia-negativo', 'diferencia-neutro');
    if (diferencia === 0) {
      diffSpan.textContent = 'Cuadra (0‚Ç°)';
      diffSpan.classList.add('diferencia-neutro');
    } else if (diferencia > 0) {
      diffSpan.textContent = `Sobra ${formatearColones(diferencia)}‚Ç°`;
      diffSpan.classList.add('diferencia-positivo');
    } else {
      diffSpan.textContent = `Faltan ${formatearColones(Math.abs(diferencia))}‚Ç°`;
      diffSpan.classList.add('diferencia-negativo');
    }
  }
}

function cargarProductos() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.productos);
    if (!raw) return PRODUCTOS_POR_DEFECTO.slice();
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr) || arr.length === 0) return PRODUCTOS_POR_DEFECTO.slice();
    return arr.map(p => ({
      nombre: String(p.nombre ?? '').trim() || 'Sin nombre',
      precio: Number(p.precio ?? 0) || 0,
      tipo: (p.tipo === 'bebida' || p.tipo === 'comida') ? p.tipo : 'comida',
      icono: String(p.icono ?? ''),
      variantes: Array.isArray(p.variantes)
        ? p.variantes.map(v => String(v).trim()).filter(Boolean)
        : String(p.variantes || '').split(',').map(v => v.trim()).filter(Boolean)
    }));
  } catch { return PRODUCTOS_POR_DEFECTO.slice(); }
}
function guardarProductos(arr) {
  localStorage.setItem(STORAGE_KEYS.productos, JSON.stringify(arr));
}

/* =================== TABS =================== */
const TAB_INFOS = [
  { name: 'apertura', contentId: 'tabApertura', buttonId: 'tabAperturaBtn', onShow: () => actualizarResumenApertura() },
  { name: 'productos', contentId: 'tabProductos', buttonId: 'tabProductosBtn', onShow: () => renderEditorProductos() },
  {
    name: 'pedidos',
    contentId: 'tabPedidos',
    buttonId: 'tabPedidosBtn',
    onShow: () => {
      crearProductos();
      actualizarResumen();
      actualizarTabla();
      renderCuentas();
    }
  },
  { name: 'cierre', contentId: 'tabCierre', buttonId: 'tabCierreBtn', onShow: () => actualizarPanelCierre() }
];
function mostrarTab(nombre) {
  const objetivo = nombre || 'apertura';
  document.body.dataset.activeTab = objetivo;
  TAB_INFOS.forEach(tab => {
    const activo = tab.name === objetivo;
    const contenido = document.getElementById(tab.contentId);
    if (contenido) contenido.style.display = activo ? '' : 'none';
    const boton = document.getElementById(tab.buttonId);
    if (boton) boton.classList.toggle('active', activo);
    if (activo && typeof tab.onShow === 'function') tab.onShow();
    if (!activo && tab.name === 'pedidos') ocultarPanelVariantes();
  });
}

/* =================== EDITOR DE PRODUCTOS =================== */
function renderEditorProductos() {
  const tbody = document.querySelector('#tablaProductos tbody');
  tbody.innerHTML = '';
  const datos = cargarProductos();
  datos.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="nombre-input" type="text" value="${html(p.nombre)}" placeholder="Nombre"></td>
      <td><input class="number" type="number" min="0" step="1" value="${Number(p.precio)}"></td>
      <td>
        <select class="tipo-select">
          <option value="bebida" ${p.tipo === 'bebida' ? 'selected' : ''}>bebida</option>
          <option value="comida" ${p.tipo === 'comida' ? 'selected' : ''}>comida</option>
        </select>
      </td>
      <td><input class="icono-input" type="text" value="${html(p.icono)}" placeholder="‚òï"></td>
      <td><input class="variantes-input" type="text" value="${html(p.variantes.join(', '))}" placeholder="Variante A, Variante B, Variante C"></td>
      <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });
  setEstadoGuardado('');
}
function agregarFilaProducto() {
  const tbody = document.querySelector('#tablaProductos tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="nombre-input" type="text" value="" placeholder="Nombre"></td>
    <td><input class="number" type="number" min="0" step="1" value="0"></td>
    <td>
      <select class="tipo-select">
        <option value="bebida">bebida</option>
        <option value="comida" selected>comida</option>
      </select>
    </td>
    <td><input class="icono-input" type="text" value="" placeholder="üç™"></td>
    <td><input class="variantes-input" type="text" value="" placeholder="Variante A, Variante B"></td>
    <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(tr);
}
function borrarFilaProducto(btn) { btn.closest('tr')?.remove(); }

function guardarProductosDesdeTabla() {
  const rows = Array.from(document.querySelectorAll('#tablaProductos tbody tr'));
  const nuevos = [];
  const nombres = new Set();
  for (const r of rows) {
    const nombre = (r.querySelector('.nombre-input')?.value || '').trim();
    const precio = Number(r.querySelector('.number')?.value || 0);
    const tipo = r.querySelector('.tipo-select')?.value === 'bebida' ? 'bebida' : 'comida';
    const icono = (r.querySelector('.icono-input')?.value || '').trim();
    const variantesStr = (r.querySelector('.variantes-input')?.value || '').trim();
    const variantes = variantesStr ? variantesStr.split(',').map(v => v.trim()).filter(Boolean) : [];

    if (!nombre) continue;
    if (nombres.has(nombre)) { alert(`Nombre duplicado: "${nombre}". Cambia alguno antes de guardar.`); return; }
    nombres.add(nombre);

    nuevos.push({ nombre, precio: Math.max(0, Math.floor(precio)), tipo, icono, variantes });
  }
  guardarProductos(nuevos);
  setEstadoGuardado('Cambios guardados.');
}
function restablecerProductos() {
  if (!confirm('¬øRestablecer el listado por defecto?')) return;
  guardarProductos(PRODUCTOS_POR_DEFECTO.slice());
  renderEditorProductos();
  setEstadoGuardado('Restablecido a valores por defecto.');
}
function setEstadoGuardado(txt) { document.getElementById('estadoGuardado').textContent = txt || ''; }
function html(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function fechaTextoToMs(texto) {
  const ms = new Date(texto).getTime();
  return Number.isFinite(ms) ? ms : Date.now();
}
function formatearColones(valor) {
  const numero = Number(valor || 0);
  return Number.isFinite(numero) ? numero.toLocaleString('es-CR') : '0';
}

/* =================== PEDIDOS: selecci√≥n con variantes =================== */
let productosNodos = [];              // nodos de la grilla
let seleccionActual = {};             // { [producto]: { total:number, variantes: { [var]: number } } }
let pendientesData = { porCliente: [], porProducto: [] };

function crearProductos() {
  const grid = document.getElementById('productosGrid');
  grid.innerHTML = '';
  const PRODS = cargarProductos();

  PRODS.forEach((prod) => {
    const div = document.createElement('div');
    div.className = 'producto';
    div.dataset.nombre = prod.nombre;
    div.dataset.precio = prod.precio;
    div.dataset.tipo = prod.tipo;
    div.dataset.variantes = JSON.stringify(prod.variantes || []);
    div.innerHTML = `<span class="icono">${html(prod.icono)}</span><span>${html(prod.nombre)} (${prod.precio})</span><span class="contador"></span><span class="restar">-</span>`;
    grid.appendChild(div);
  });

  productosNodos = Array.from(document.querySelectorAll('.producto'));
  productosNodos.forEach(p => configurarHandlersProducto(p));

  if (overlayVariantes && !overlayVariantes.hidden && productoVariantesActivo) {
    const prodActual = PRODS.find(prod => prod.nombre === productoVariantesActivo);
    if (prodActual && Array.isArray(prodActual.variantes) && prodActual.variantes.length) {
      mostrarPanelVariantes(productoVariantesActivo, prodActual.variantes);
    } else {
      ocultarPanelVariantes();
    }
  } else if (productoVariantesActivo) {
    marcarProductoActivo(productoVariantesActivo);
  }
}

function configurarHandlersProducto(p) {
  const nombre = p.dataset.nombre;
  const contador = p.querySelector('.contador');
  const restar = p.querySelector('.restar');

  const obtenerVariantes = () => {
    try {
      const parsed = JSON.parse(p.dataset.variantes || '[]');
      return Array.isArray(parsed)
        ? parsed.map(v => String(v).trim()).filter(Boolean)
        : [];
    } catch {
      return [];
    }
  };

  p.addEventListener('click', (e) => {
    if (e.target instanceof Element && e.target.closest('.restar')) return;
    const variantes = obtenerVariantes();
    if (variantes.length) {
      if (productoVariantesActivo === nombre && overlayVariantes && !overlayVariantes.hidden) {
        ocultarPanelVariantes();
        return;
      }
      mostrarPanelVariantes(nombre, variantes);
    } else {
      ocultarPanelVariantes();
      incProducto(nombre, null);
    }
  });

  if (restar) {
    restar.addEventListener('click', (e) => {
      e.stopPropagation();
      decProducto(nombre);
    });
  }

  // render contador por si hay selecci√≥n previa
  renderContador(nombre, contador, restar);
}

function incProducto(nombre, variante) {
  if (!seleccionActual[nombre]) seleccionActual[nombre] = { total:0, variantes:{} };
  seleccionActual[nombre].total += 1;
  if (variante) {
    seleccionActual[nombre].variantes[variante] = (seleccionActual[nombre].variantes[variante] || 0) + 1;
  }
  renderContadorNombre(nombre);
  actualizarResumen();
}
function decProducto(nombre) {
  const obj = seleccionActual[nombre];
  if (!obj || obj.total <= 0) return;
  const totalVariantes = Object.values(obj.variantes).reduce((a,b)=>a+b,0);
  const sinEspecificar = obj.total - totalVariantes;
  if (sinEspecificar > 0) {
    obj.total -= 1;
  } else {
    const vNames = Object.keys(obj.variantes).filter(v => obj.variantes[v] > 0);
    if (vNames.length) {
      const v = vNames[vNames.length-1];
      obj.variantes[v] -= 1;
      obj.total -= 1;
      if (obj.variantes[v] === 0) delete obj.variantes[v];
    } else {
      obj.total -= 1;
    }
  }
  if (obj.total <= 0) delete seleccionActual[nombre];
  renderContadorNombre(nombre);
  actualizarResumen();
}
function renderContadorNombre(nombre) {
  const p = productosNodos.find(n=>n.dataset.nombre===nombre);
  if (!p) return;
  renderContador(nombre, p.querySelector('.contador'), p.querySelector('.restar'));
}
function renderContador(nombre, contador, restar) {
  const total = seleccionActual[nombre]?.total || 0;
  contador.textContent = total ? String(total) : '';
  contador.style.display = total ? 'inline-block' : 'none';
  restar.style.display = total ? 'inline-block' : 'none';
}

/* Men√∫ flotante de variantes */
const overlayVariantes = document.getElementById('variantesOverlay');
const gridWrapper = document.querySelector('.productos-grid-wrapper');
let productoVariantesActivo = null;

function marcarProductoActivo(nombre) {
  productosNodos.forEach(nodo => {
    const coincide = nombre && nodo.dataset.nombre === nombre;
    nodo.classList.toggle('activo', Boolean(coincide));
  });
}

function ocultarPanelVariantes() {
  if (!overlayVariantes) return;
  overlayVariantes.classList.remove('visible');
  overlayVariantes.innerHTML = '';
  overlayVariantes.hidden = true;
  productoVariantesActivo = null;
  marcarProductoActivo(null);
}

function mostrarPanelVariantes(nombre, variantes) {
  if (!overlayVariantes || !gridWrapper) {
    incProducto(nombre, null);
    return;
  }
  const lista = Array.isArray(variantes)
    ? variantes.map(v => String(v).trim()).filter(Boolean)
    : [];
  if (!lista.length) {
    ocultarPanelVariantes();
    incProducto(nombre, null);
    return;
  }

  const nodoProducto = productosNodos.find(nodo => nodo.dataset.nombre === nombre);
  if (!nodoProducto) {
    incProducto(nombre, null);
    return;
  }

  const wrapperRect = gridWrapper.getBoundingClientRect();
  const rect = nodoProducto.getBoundingClientRect();
  const centroX = rect.left - wrapperRect.left + rect.width / 2;
  const centroY = rect.top - wrapperRect.top + rect.height * 0.65;

  productoVariantesActivo = nombre;
  overlayVariantes.classList.remove('visible');
  overlayVariantes.innerHTML = '';
  overlayVariantes.style.left = `${centroX}px`;
  overlayVariantes.style.top = `${centroY}px`;
  overlayVariantes.hidden = false;

  const radioBase = Math.max(rect.width, rect.height) * 0.35 + 28;
  const inicioDeg = 150;
  const finDeg = 210;
  const paso = lista.length > 1 ? (finDeg - inicioDeg) / (lista.length - 1) : 0;

  lista.forEach((variante, index) => {
    const anguloDeg = lista.length === 1 ? 180 : inicioDeg + paso * index;
    const anguloRad = anguloDeg * Math.PI / 180;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'variante-bubble';
    btn.textContent = variante;
    btn.style.left = `${Math.cos(anguloRad) * radioBase}px`;
    btn.style.top = `${Math.sin(anguloRad) * radioBase}px`;
    btn.addEventListener('click', (event) => {
      event.stopPropagation();
      incProducto(nombre, variante);
    });
    overlayVariantes.appendChild(btn);
  });

  requestAnimationFrame(() => overlayVariantes.classList.add('visible'));

  marcarProductoActivo(nombre);
}

/* Resumen de pedido (incluye variantes) */
function actualizarResumen() {
  const PRODS = cargarProductos();
  let resumen = document.getElementById('resumenOrden');
  let totalNodo = document.getElementById('total');
  let sugerenciaCambio = document.getElementById('sugerenciaCambio');
  let total = 0;

  // Mapa de cantidades por producto base para combos y precio
  const mapaBase = {};
  Object.keys(seleccionActual).forEach(nombre => mapaBase[nombre] = (mapaBase[nombre] || 0) + (seleccionActual[nombre].total || 0));

  const calc = calcularTotalDesdeMapa(mapaBase, PRODS);
  const lineasResumen = [];
  for (let combo in calc.comboCantidades) {
    lineasResumen.push(`${calc.comboCantidades[combo]} Combo - ${formatearColones(calc.comboCantidades[combo] * PRECIO_COMBO)}‚Ç°<br>`);
    lineasResumen.push(`<div class='indentado'>- ${html(combo)}</div>`);
  }

  for (let p in calc.individuales) {
    const cantidadIndiv = calc.individuales[p];
    if ((cantidadIndiv || 0) > 0) {
      const precioUnitario = (PRODS.find(x=>x.nombre===p)||{}).precio || 0;
      const precio = cantidadIndiv * precioUnitario;
      lineasResumen.push(`${cantidadIndiv} ${html(p)} - ${formatearColones(precio)}‚Ç°<br>`);
      const varsObj = (seleccionActual[p]?.variantes)||{};
      const nombresVar = Object.keys(varsObj);
      if (nombresVar.length) {
        const detalle = nombresVar.map(v=>`${html(v)}: ${varsObj[v]}`).join(' ¬∑ ');
        lineasResumen.push(`<div class="indentado">${detalle}</div>`);
      }
    }
  }

  total = calc.total;
  resumen.innerHTML = lineasResumen.length ? lineasResumen.join('') : '<span class="muted">Sin productos seleccionados</span>';
  totalNodo.innerHTML = `<strong>Total: ${formatearColones(total)}‚Ç°</strong>`;

  if (total <= 0) {
    sugerenciaCambio.innerHTML = '<strong>Cambio</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span>';
  } else {
    const opciones = CAMBIOS_SUGERIDOS.filter(monto => monto >= total);
    if (!opciones.length) {
      sugerenciaCambio.innerHTML = '<strong>Cambio</strong><br><span class="muted">Sin opciones disponibles.</span>';
    } else {
      const items = opciones.map(monto => {
        const cambio = monto - total;
        return `<li>${formatearColones(monto)}‚Ç° ‚Üí ${formatearColones(cambio)}‚Ç°</li>`;
      }).join('');
      sugerenciaCambio.innerHTML = `<strong>Cambio</strong><ul>${items}</ul>`;
    }
  }
}

/* Tabla de historial y resumen global (acumula variantes) */
function cargarTabla() { return JSON.parse(localStorage.getItem(STORAGE_KEYS.ordenes) || '[]'); }
function guardarTabla(data) { localStorage.setItem(STORAGE_KEYS.ordenes, JSON.stringify(data)); }

function clonarMapaProductos(mapa) {
  const copia = {};
  Object.keys(mapa || {}).forEach(nombre => {
    const cantidad = Number(mapa[nombre]) || 0;
    if (cantidad > 0) copia[nombre] = cantidad;
  });
  return copia;
}

function clonarVariantesMapa(vars) {
  const copia = {};
  Object.keys(vars || {}).forEach(base => {
    const variantesBase = vars[base] || {};
    const variantesLimpias = {};
    Object.keys(variantesBase).forEach(nombreVar => {
      const cantidad = Number(variantesBase[nombreVar]) || 0;
      if (cantidad > 0) variantesLimpias[nombreVar] = cantidad;
    });
    if (Object.keys(variantesLimpias).length) copia[base] = variantesLimpias;
  });
  return copia;
}

function crearOrdenRegistro({ cliente = '', productos = {}, variantes = {}, metodo = 'efectivo', estado = 'pagado', cuenta = null, entregasServidas = false, sinpeId = null }) {
  const productosCopia = clonarMapaProductos(productos);
  const variantesCopia = clonarVariantesMapa(variantes);
  const PRODS = cargarProductos();
  const entregas = {};
  Object.keys(productosCopia).forEach(nombre => {
    entregas[nombre] = !!entregasServidas;
  });

  return {
    fecha: new Date().toLocaleString(),
    cliente,
    cantidad: calcularTotalDesdeMapa(productosCopia, PRODS).total,
    metodo,
    productos: productosCopia,
    variantes: variantesCopia,
    entregas,
    estado,
    cuenta,
    sinpeId: sinpeId || null
  };
}

function esCuentaAbiertaOrden(o) {
  return (o?.estado || 'pagado') === 'cuenta_abierta';
}

function construirLineasPorProducto(o) {
  const PRODS = cargarProductos();
  const lineas = [];
  for (let nombre in o.productos) {
    const prod = PRODS.find(p => p.nombre === nombre);
    const cant = o.productos[nombre];
    const icono = prod?.icono || '';
    const iconos = icono ? `${icono}√ó${cant}` : `${cant}x`;
    const vars = (o.variantes && o.variantes[nombre]) ? o.variantes[nombre] : null;
    lineas.push({ nombre, cantidad: cant, iconos, variantes: vars, tieneIcono: !!icono });
  }
  lineas.sort((a,b) => a.nombre.localeCompare(b.nombre));
  return lineas;
}
function toggleEntrega(fecha, nombreProducto) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  if (!ordenes[i].entregas) ordenes[i].entregas = {};
  ordenes[i].entregas[nombreProducto] = !ordenes[i].entregas[nombreProducto];
  guardarTabla(ordenes);
  actualizarTabla();
}
function toggleEntregaMaestro(fecha) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  const o = ordenes[i];
  const lineas = construirLineasPorProducto(o);
  if (!o.entregas) o.entregas = {};
  const allServed = lineas.length > 0 && lineas.every(l => !!o.entregas[l.nombre]);
  const target = !allServed;
  lineas.forEach(l => { o.entregas[l.nombre] = target; });
  guardarTabla(ordenes);
  actualizarTabla();
}

function marcarPendienteComoServido(fecha, nombreProducto) {
  if (!fecha || !nombreProducto) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  if (!orden.entregas) orden.entregas = {};
  if (orden.entregas[nombreProducto]) return;
  orden.entregas[nombreProducto] = true;
  guardarTabla(ordenes);
  actualizarTabla();
}

function actualizarTabla() {
  const PRODS = cargarProductos();
  const prodMap = new Map(PRODS.map(p => [p.nombre, p]));
  const pagosSinpe = cargarPagosSinpe();
  const pagosSinpeMap = new Map(pagosSinpe.map(p => [p.id, p]));
  let ordenes = cargarTabla();
  let tbody = document.querySelector('#tabla tbody');
  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  const pendientesCliente = new Map();
  const pendientesProducto = new Map();
  const registrarPendienteProducto = (productoNombre, varianteNombre, cantidad, icono, clienteNombre, fechaTexto, fechaValor) => {
    if (!cantidad) return;
    const clave = `${productoNombre}__${varianteNombre || ''}`;
    const valorFecha = Number.isFinite(fechaValor) ? fechaValor : fechaTextoToMs(fechaTexto);
    if (!pendientesProducto.has(clave)) {
      pendientesProducto.set(clave, {
        nombre: productoNombre,
        icono,
        total: 0,
        clientes: [],
        variante: varianteNombre || null,
        primeraFecha: valorFecha
      });
    }
    const prodPendiente = pendientesProducto.get(clave);
    prodPendiente.total += cantidad;
    prodPendiente.primeraFecha = Math.min(prodPendiente.primeraFecha, valorFecha);
    const variantesDetalle = varianteNombre ? { [varianteNombre]: cantidad } : null;
    prodPendiente.clientes.push({
      cliente: clienteNombre,
      cantidad,
      fecha: fechaTexto,
      fechaValor: valorFecha,
      variantes: variantesDetalle,
      pedidoFecha: fechaTexto,
      producto: productoNombre
    });
  };

  tbody.innerHTML = '';

  ordenes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(o => {
    const lineas = construirLineasPorProducto(o);
    o.entregas = o.entregas || {};
    lineas.forEach(l => { if (!(l.nombre in o.entregas)) o.entregas[l.nombre] = false; });

    const estadoOrden = o.estado || 'pagado';
    const esCuentaAbierta = estadoOrden === 'cuenta_abierta';
    const metodoMostrar = esCuentaAbierta ? 'Cuenta abierta' : o.metodo;
    let metodoHtml = html(metodoMostrar);
    if (!esCuentaAbierta && o.metodo === 'sinpe') {
      const pagoRelacionado = o.sinpeId ? pagosSinpeMap.get(o.sinpeId) : null;
      const confirmado = pagoRelacionado && pagoRelacionado.ordenFecha === o.fecha;
      const badge = confirmado
        ? '<span class="sinpe-badge sinpe-badge--confirmado">Confirmado</span>'
        : '<span class="sinpe-badge sinpe-badge--pendiente">Sin validar</span>';
      metodoHtml = `Sinpe ${badge}`;
    }

    const allServed = lineas.length > 0 && lineas.every(l => !!o.entregas[l.nombre]);
    const masterChecked = allServed ? 'checked' : '';
    let productosHTML = `
      <div class="productos-maestro">
        <input type="checkbox" class="master-checkbox" ${masterChecked}
              title="Marcar todo el pedido"
              onclick="toggleEntregaMaestro('${o.fecha}')">
        <span class="master-label">Pedido completo</span>
      </div>
    `;
    if (lineas.length >= 1) {
      lineas.forEach(l => {
        const checked = o.entregas[l.nombre] ? 'checked' : '';
        const desglose = l.variantes
          ? `<div class="productos-nombre indentado">${
              Object.keys(l.variantes).map(v=>`${html(v)}: ${l.variantes[v]}`).join(' ¬∑ ')
            }</div>`
          : '';
        const nombreProducto = l.tieneIcono
          ? ''
          : `<span class="productos-nombre">${html(l.nombre)}</span>`;
        const prodInfo = prodMap.get(l.nombre);
        if (!o.entregas[l.nombre]) {
          const clienteNombre = (o.cliente || '').trim() || 'Sin nombre';
          const cantidadPendiente = l.cantidad || 0;
          const iconoProd = prodInfo?.icono || '';
          const variantesPendientes = l.variantes ? { ...l.variantes } : null;
          const fechaTexto = o.fecha;
          const fechaValor = fechaTextoToMs(fechaTexto);

          if (!pendientesCliente.has(clienteNombre)) pendientesCliente.set(clienteNombre, []);
          pendientesCliente.get(clienteNombre).push({
            nombre: l.nombre,
            cantidad: cantidadPendiente,
            icono: iconoProd,
            variantes: variantesPendientes,
            fecha: fechaTexto,
            fechaValor,
            pedidoFecha: o.fecha
          });

          if (variantesPendientes && Object.keys(variantesPendientes).length) {
            let acumulado = 0;
            Object.entries(variantesPendientes).forEach(([varNombre, cantVar]) => {
              const cantNum = Number(cantVar) || 0;
              if (!cantNum) return;
              acumulado += cantNum;
              registrarPendienteProducto(l.nombre, varNombre, cantNum, iconoProd, clienteNombre, fechaTexto, fechaValor);
            });
            const restante = cantidadPendiente - acumulado;
            if (restante > 0) {
              registrarPendienteProducto(l.nombre, null, restante, iconoProd, clienteNombre, fechaTexto, fechaValor);
            }
          } else {
            registrarPendienteProducto(l.nombre, null, cantidadPendiente, iconoProd, clienteNombre, fechaTexto, fechaValor);
          }
        }
        productosHTML += `
          <div class="productos-linea">
            <input type="checkbox" class="pendiente-checkbox" ${checked}
              onclick="toggleEntrega('${o.fecha}','${jsEsc(l.nombre)}')">
            <span>${html(l.iconos)}</span>
            ${nombreProducto}
            ${desglose}
          </div>
        `;
      });
    }

    const fila = document.createElement('tr');
    if (allServed) fila.classList.add('servido');
    if (esCuentaAbierta) fila.classList.add('cuenta-abierta');

    fila.innerHTML = `
      <td class="col-fecha">${html(o.fecha)}</td>
      <td>${html(o.cliente || '')}</td>
      <td>${o.cantidad}‚Ç°</td>
      <td>${metodoHtml}</td>
      <td>${productosHTML}</td>
      <td><button onclick="eliminarOrden('${jsEsc(o.fecha)}')">‚ùå</button></td>
    `;
    tbody.appendChild(fila);

    if (!esCuentaAbierta) {
      resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
      resumen.total += o.cantidad;
      for (let p in o.productos) {
        resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
      }
      const vars = o.variantes || {};
      Object.keys(vars).forEach(base=>{
        resumen.variantes[base] = resumen.variantes[base] || {};
        Object.keys(vars[base]).forEach(vn=>{
          resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
        });
      });
    }
  });

  const pendientesPorCliente = Array.from(pendientesCliente.entries()).map(([cliente, items]) => {
    const itemsOrdenados = items.slice().sort((a, b) => (a.fechaValor - b.fechaValor) || a.nombre.localeCompare(b.nombre));
    const primeraFecha = itemsOrdenados.length ? itemsOrdenados[0].fechaValor : Number.POSITIVE_INFINITY;
    return {
      cliente,
      total: items.reduce((sum, item) => sum + (item.cantidad || 0), 0),
      items: itemsOrdenados,
      primeraFecha
    };
  }).sort((a, b) => (a.primeraFecha - b.primeraFecha) || a.cliente.localeCompare(b.cliente));

  const pendientesPorProducto = Array.from(pendientesProducto.values()).map(entry => {
    const clientesOrdenados = entry.clientes.slice().sort((a, b) => (a.fechaValor - b.fechaValor) || a.cliente.localeCompare(b.cliente));
    const primeraFecha = clientesOrdenados.length ? clientesOrdenados[0].fechaValor : entry.primeraFecha;
    return {
      nombre: entry.nombre,
      icono: entry.icono,
      total: entry.total,
      variante: entry.variante,
      clientes: clientesOrdenados,
      primeraFecha
    };
  }).sort((a, b) => {
    const fechaDiff = a.primeraFecha - b.primeraFecha;
    if (fechaDiff !== 0) return fechaDiff;
    const nombreDiff = a.nombre.localeCompare(b.nombre);
    if (nombreDiff !== 0) return nombreDiff;
    return (a.variante || '').localeCompare(b.variante || '');
  });

  pendientesData = { porCliente: pendientesPorCliente, porProducto: pendientesPorProducto };
  actualizarPendientesUI();

  let resumenTbody = document.querySelector('#tablaResumen tbody');
  resumenTbody.innerHTML = '';
  resumenTbody.innerHTML += `<tr><td>Total Recaudado</td><td>${resumen.total}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Efectivo</td><td>${resumen.efectivo || 0}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Sinpe</td><td>${resumen.sinpe || 0}‚Ç°</td></tr>`;
  for (let p in resumen.productos) {
    resumenTbody.innerHTML += `<tr><td>Ventas de ${html(p)}</td><td>${resumen.productos[p]}</td></tr>`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      const detalle = Object.keys(vars).map(v=>`${html(v)}: ${vars[v]}`).join(' ¬∑ ');
      resumenTbody.innerHTML += `<tr><td class="indentado">‚Äî ${html(p)} (variantes)</td><td>${detalle}</td></tr>`;
    }
  }

  renderPanelSinpe();
}

function eliminarOrden(fecha) {
  if (!confirm('¬øEst√°s seguro de eliminar esta orden?')) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const [eliminada] = ordenes.splice(idx, 1);
  guardarTabla(ordenes);

  if (eliminada && eliminada.sinpeId) {
    const pagos = cargarPagosSinpe();
    const pago = pagos.find(p => p.id === eliminada.sinpeId);
    if (pago) {
      pago.ordenFecha = null;
      guardarPagosSinpe(pagos);
      renderPanelSinpe();
    }
  }

  if (eliminada && esCuentaAbiertaOrden(eliminada) && eliminada.cuenta) {
    const cuentas = cargarCuentas();
    const cuentaData = cuentas[eliminada.cuenta];
    if (cuentaData) {
      cuentaData.productos = cuentaData.productos || {};
      cuentaData.variantes = cuentaData.variantes || {};
      Object.keys(eliminada.productos || {}).forEach(nombre => {
        cuentaData.productos[nombre] = (cuentaData.productos[nombre] || 0) - (eliminada.productos[nombre] || 0);
        if (cuentaData.productos[nombre] <= 0) delete cuentaData.productos[nombre];
      });
      const varsEliminadas = eliminada.variantes || {};
      Object.keys(varsEliminadas).forEach(base => {
        cuentaData.variantes[base] = cuentaData.variantes[base] || {};
        Object.keys(varsEliminadas[base]).forEach(varianteNombre => {
          cuentaData.variantes[base][varianteNombre] = (cuentaData.variantes[base][varianteNombre] || 0) - varsEliminadas[base][varianteNombre];
          if (cuentaData.variantes[base][varianteNombre] <= 0) delete cuentaData.variantes[base][varianteNombre];
        });
        if (Object.keys(cuentaData.variantes[base]).length === 0) delete cuentaData.variantes[base];
      });
      const productosRestantes = Object.keys(cuentaData.productos || {});
      const variantesRestantes = Object.keys(cuentaData.variantes || {});
      if (productosRestantes.length === 0 && variantesRestantes.length === 0) {
        delete cuentas[eliminada.cuenta];
      }
      guardarCuentas(cuentas);
      renderCuentas();
    }
  }
  actualizarTabla();
}

function eliminarTodasOrdenes() {
  const pagos = cargarPagosSinpe();
  let cambio = false;
  pagos.forEach(p => {
    if (p.ordenFecha) {
      p.ordenFecha = null;
      cambio = true;
    }
  });
  if (cambio) {
    guardarPagosSinpe(pagos);
    renderPanelSinpe();
  }
  guardarTabla([]);
  actualizarTabla();
}

function mostrarWarningEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.add('active');
  setTimeout(() => {
    const confirmBtn = overlay.querySelector('.confirm');
    if (confirmBtn) confirmBtn.focus();
  }, 0);
}

function cancelarEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.remove('active');
}

function confirmarEliminarTodos() {
  eliminarTodasOrdenes();
  cancelarEliminarTodos();
}

function mergeVariantes(target, source) {
  if (!target || !source) return;
  Object.keys(source).forEach(nombreVar => {
    const cantidad = Number(source[nombreVar]) || 0;
    if (cantidad > 0) {
      target[nombreVar] = (target[nombreVar] || 0) + cantidad;
    }
  });
}

function normalizarPendientesPorCliente(map) {
  const resultado = [];
  map.forEach((items, cliente) => {
    const agrupados = new Map();
    items.forEach(item => {
      const key = item.nombre;
      if (!agrupados.has(key)) {
        agrupados.set(key, {
          nombre: item.nombre,
          icono: item.icono || '',
          cantidad: 0,
          variantes: {},
          fecha: item.fecha || ''
        });
      }
      const prod = agrupados.get(key);
      prod.cantidad += Number(item.cantidad) || 0;
      mergeVariantes(prod.variantes, item.variantes || {});
      if (!prod.fecha && item.fecha) prod.fecha = item.fecha;
    });

    const itemsOrdenados = Array.from(agrupados.values()).map(prod => {
      if (!prod.variantes || Object.keys(prod.variantes).length === 0) prod.variantes = null;
      return prod;
    }).sort((a, b) => a.nombre.localeCompare(b.nombre));

    const total = itemsOrdenados.reduce((sum, prod) => sum + (Number(prod.cantidad) || 0), 0);
    resultado.push({ cliente, total, items: itemsOrdenados });
  });
  return resultado;
}

function normalizarPendientesPorProducto(map) {
  const resultado = [];
  map.forEach((data, keyNombre) => {
    const clientesAgrupados = new Map();
    (data.clientes || []).forEach(cli => {
      const nombreCliente = (cli.cliente || 'Sin nombre');
      if (!clientesAgrupados.has(nombreCliente)) {
        clientesAgrupados.set(nombreCliente, {
          cliente: nombreCliente,
          cantidad: 0,
          variantes: {},
          fecha: cli.fecha || ''
        });
      }
      const clienteInfo = clientesAgrupados.get(nombreCliente);
      clienteInfo.cantidad += Number(cli.cantidad) || 0;
      mergeVariantes(clienteInfo.variantes, cli.variantes || {});
      if (!clienteInfo.fecha && cli.fecha) clienteInfo.fecha = cli.fecha;
    });

    const clientesOrdenados = Array.from(clientesAgrupados.values()).map(cli => {
      if (!cli.variantes || Object.keys(cli.variantes).length === 0) cli.variantes = null;
      return cli;
    }).sort((a, b) => a.cliente.localeCompare(b.cliente));

    const total = clientesOrdenados.reduce((sum, cli) => sum + (Number(cli.cantidad) || 0), 0);
    resultado.push({
      nombre: data.nombre || keyNombre || '',
      icono: data.icono || '',
      total,
      clientes: clientesOrdenados
    });
  });
  return resultado;
}

function variantesPendientesTexto(vars) {
  if (!vars) return '';
  const claves = Object.keys(vars);
  if (!claves.length) return '';
  const cuerpo = claves.map(v => `${html(v)}: ${vars[v]}`).join(' ¬∑ ');
  return `<span class="pendientes-variantes">[${cuerpo}]</span>`;
}

function actualizarPendientesUI() {
  const contCliente = document.getElementById('pendientesPorCliente');
  const contProducto = document.getElementById('pendientesPorProducto');

  if (contCliente) {
    if (!pendientesData.porCliente.length) {
      contCliente.innerHTML = '<p class="pendientes-vacio">No hay productos pendientes por servir.</p>';
    } else {
      contCliente.innerHTML = pendientesData.porCliente.map(entry => {
        const lista = entry.items.map(item => {
          const icono = item.icono ? `<span class="pendientes-icono">${html(item.icono)}</span>` : '';
          const variantes = variantesPendientesTexto(item.variantes);
          const fecha = item.fecha ? `<span class="pendientes-fecha">Pedido: ${html(item.fecha)}</span>` : '';
          const completar = `<button type="button" class="pendiente-completar" data-fecha="${html(item.pedidoFecha)}" data-producto="${html(item.nombre)}" title="Marcar como completado">Completar</button>`;
          return `<li><div class="fila-principal">${icono}<span><strong>${item.cantidad}</strong> √ó ${html(item.nombre)}</span>${variantes}${completar}</div>${fecha}</li>`;
        }).join('');
        return `
          <article class="pendiente-card">
            <div class="pendiente-card-header">
              <div class="header-left"><span><strong>${html(entry.cliente)}</strong></span></div>
              <span class="pendientes-total">${entry.total} pendiente${entry.total === 1 ? '' : 's'}</span>
            </div>
            <ul class="pendientes-list">${lista}</ul>
          </article>
        `;
      }).join('');
    }
  }

  if (contProducto) {
    if (!pendientesData.porProducto.length) {
      contProducto.innerHTML = '<p class="pendientes-vacio">No hay productos pendientes por servir.</p>';
    } else {
      contProducto.innerHTML = pendientesData.porProducto.map(prod => {
        const icono = prod.icono ? `<span class="pendientes-icono">${html(prod.icono)}</span>` : '';
        const variante = prod.variante ? `<span class="pendientes-variante">${html(prod.variante)}</span>` : '';
        const clientesDetalle = prod.clientes.map(cli => {
          const variantes = variantesPendientesTexto(cli.variantes);
          const fecha = cli.fecha ? `<span class="pendientes-fecha">Pedido: ${html(cli.fecha)}</span>` : '';
          const clienteNombre = (cli.cliente || 'Sin nombre');
          const unidades = cli.cantidad === 1 ? 'unidad' : 'unidades';
          const completar = `<button type="button" class="pendiente-completar" data-fecha="${html(cli.pedidoFecha)}" data-producto="${html(cli.producto)}" title="Marcar como completado">Completar</button>`;
          return `<li><div class="fila-principal"><span><strong>${cli.cantidad}</strong> ${unidades}</span><span>para ${html(clienteNombre)}</span>${variantes}${completar}</div>${fecha}</li>`;
        }).join('');
        return `
          <article class="pendiente-card">
            <div class="pendiente-card-header">
              <div class="header-left">${icono}<span><strong>${html(prod.nombre)}</strong></span>${variante}</div>
              <span class="pendientes-total">${prod.total} pendiente${prod.total === 1 ? '' : 's'}</span>
            </div>
            <ul class="pendientes-list">${clientesDetalle}</ul>
          </article>
        `;
      }).join('');
    }
  }
}

function abrirPendientes(tab = 'cliente') {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay) return;
  actualizarPendientesUI();
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');
  cambiarTabPendientes(tab);
  const closeBtn = overlay.querySelector('.pendientes-close');
  if (closeBtn) closeBtn.focus();
}

function cerrarPendientes() {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay || !overlay.classList.contains('active')) return;
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden', 'true');
  const btn = document.getElementById('verPendientesBtn');
  if (btn) btn.focus();
}

function cambiarTabPendientes(tab) {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay) return;
  const tabs = overlay.querySelectorAll('.pendientes-tab');
  tabs.forEach(btn => {
    const activa = btn.dataset.tab === tab;
    btn.classList.toggle('active', activa);
    btn.setAttribute('aria-selected', activa ? 'true' : 'false');
  });
  const clientePane = document.getElementById('pendientesPorCliente');
  const productoPane = document.getElementById('pendientesPorProducto');
  if (clientePane) clientePane.hidden = tab !== 'cliente';
  if (productoPane) productoPane.hidden = tab !== 'producto';
  overlay.dataset.activeTab = tab;
}

document.addEventListener('click', event => {
  const btn = event.target.closest('.pendiente-completar');
  if (!btn) return;
  const { fecha, producto } = btn.dataset;
  marcarPendienteComoServido(fecha, producto);
});

/* =================== SINPE (pagos desde SMS) =================== */
function intentarConciliarPagosSinpe() {
  let pagos = cargarPagosSinpe();
  let ordenes = cargarTabla();
  let huboCambios = false;

  const pagosPorId = new Map(pagos.map(p => [p.id, p]));
  ordenes.forEach(o => {
    if (esCuentaAbiertaOrden(o) || o.metodo !== 'sinpe') return;
    if (o.sinpeId && pagosPorId.has(o.sinpeId)) return;
    o.sinpeId = null;
  });

  pagos.forEach(pago => {
    if (pago.ordenFecha) {
      const ordenAsociada = ordenes.find(o => o.fecha === pago.ordenFecha);
      if (!ordenAsociada || ordenAsociada.metodo !== 'sinpe') {
        pago.ordenFecha = null;
        huboCambios = true;
      } else if (ordenAsociada.sinpeId !== pago.id) {
        ordenAsociada.sinpeId = pago.id;
        huboCambios = true;
      }
      return;
    }

    const candidatos = ordenes.filter(o => !esCuentaAbiertaOrden(o) && o.metodo === 'sinpe' && !o.sinpeId && o.cantidad === pago.monto);
    if (candidatos.length === 1) {
      const orden = candidatos[0];
      orden.sinpeId = pago.id;
      pago.ordenFecha = orden.fecha;
      huboCambios = true;
    }
  });

  if (huboCambios) {
    guardarPagosSinpe(pagos);
    guardarTabla(ordenes);
    actualizarTabla();
  }
}

function procesarMensajesSinpe() {
  const textarea = document.getElementById('sinpeMensajes');
  if (!textarea) return;
  const bloques = dividirMensajesSinpe(textarea.value || '');
  if (!bloques.length) {
    alert('No se detectaron mensajes v√°lidos.');
    return;
  }

  let pagos = cargarPagosSinpe();
  let nuevos = 0;
  let omitidos = 0;

  bloques.forEach(texto => {
    const datos = extraerDatosSinpeDesdeMensaje(texto);
    if (!datos) {
      omitidos++;
      return;
    }
    const duplicado = pagos.some(p => p.mensaje === datos.mensaje || (datos.referencia && p.referencia && datos.referencia === p.referencia));
    if (duplicado) {
      omitidos++;
      return;
    }
    pagos.push({
      id: generarIdSinpe(),
      monto: datos.monto,
      referencia: datos.referencia,
      remitente: datos.remitente,
      mensaje: datos.mensaje,
      creadoEn: Date.now(),
      ordenFecha: null
    });
    nuevos++;
  });

  if (!nuevos) {
    alert('Los SMS ya estaban registrados o no contienen montos v√°lidos.');
    return;
  }

  guardarPagosSinpe(pagos);
  textarea.value = '';
  intentarConciliarPagosSinpe();
  renderPanelSinpe();

  const mensaje = [`Se guardaron ${nuevos} pago${nuevos === 1 ? '' : 's'} Sinpe.`];
  if (omitidos) mensaje.push(`${omitidos} mensaje${omitidos === 1 ? '' : 's'} se omitieron por duplicados o formato desconocido.`);
  alert(mensaje.join(' '));
}

function actualizarVinculoPagoSinpe(idPago, fechaOrden) {
  let pagos = cargarPagosSinpe();
  let ordenes = cargarTabla();
  const pago = pagos.find(p => p.id === idPago);
  if (!pago) return;

  if (pago.ordenFecha) {
    const ordenPrev = ordenes.find(o => o.fecha === pago.ordenFecha);
    if (ordenPrev) ordenPrev.sinpeId = null;
    pago.ordenFecha = null;
  }

  if (fechaOrden) {
    const orden = ordenes.find(o => o.fecha === fechaOrden);
    if (!orden || orden.metodo !== 'sinpe') {
      guardarPagosSinpe(pagos);
      guardarTabla(ordenes);
      renderPanelSinpe();
      actualizarTabla();
      return;
    }
    if (orden.sinpeId && orden.sinpeId !== idPago) {
      const pagoAnterior = pagos.find(p => p.id === orden.sinpeId);
      if (pagoAnterior) pagoAnterior.ordenFecha = null;
    }
    orden.sinpeId = idPago;
    pago.ordenFecha = fechaOrden;
  }

  guardarPagosSinpe(pagos);
  guardarTabla(ordenes);
  renderPanelSinpe();
  actualizarTabla();
}

function eliminarPagoSinpe(idPago) {
  if (!confirm('¬øEliminar este comprobante Sinpe?')) return;
  let pagos = cargarPagosSinpe();
  let ordenes = cargarTabla();
  const idx = pagos.findIndex(p => p.id === idPago);
  if (idx === -1) return;
  const pago = pagos[idx];
  pagos.splice(idx, 1);
  if (pago && pago.ordenFecha) {
    const orden = ordenes.find(o => o.fecha === pago.ordenFecha);
    if (orden) orden.sinpeId = null;
  }
  guardarPagosSinpe(pagos);
  guardarTabla(ordenes);
  renderPanelSinpe();
  actualizarTabla();
}

function renderPanelSinpe() {
  const lista = document.getElementById('sinpePagosLista');
  const overlay = document.getElementById('sinpeOverlay');
  if (!lista || !overlay || !overlay.classList.contains('active')) return;

  const pagos = cargarPagosSinpe().sort((a, b) => (b.creadoEn - a.creadoEn));
  const ordenes = cargarTabla();
  const sinpeOrdenes = ordenes.filter(o => !esCuentaAbiertaOrden(o) && o.metodo === 'sinpe');
  const ordenesMapa = new Map(sinpeOrdenes.map(o => [o.fecha, o]));

  const pendientesUl = document.getElementById('sinpeOrdenesPendientes');
  if (pendientesUl) {
    const pendientes = sinpeOrdenes.filter(o => !o.sinpeId);
    if (!pendientes.length) {
      pendientesUl.innerHTML = '<li>No hay √≥rdenes pendientes por conciliar.</li>';
    } else {
      pendientesUl.innerHTML = pendientes.map(o => {
        const cliente = o.cliente ? ` ¬∑ ${html(o.cliente)}` : '';
        return `<li>${html(o.fecha)} ¬∑ <strong>${formatearColones(o.cantidad)}‚Ç°</strong>${cliente}</li>`;
      }).join('');
    }
  }

  if (!pagos.length) {
    lista.innerHTML = '<p class="sinpe-ayuda">A√∫n no hay pagos registrados.</p>';
    return;
  }

  lista.innerHTML = pagos.map(pago => {
    const ordenActual = pago.ordenFecha ? ordenesMapa.get(pago.ordenFecha) : null;
    const estadoConfirmado = !!(ordenActual && ordenActual.sinpeId === pago.id);
    const badge = estadoConfirmado
      ? '<span class="sinpe-badge sinpe-badge--confirmado">Confirmado</span>'
      : '<span class="sinpe-badge sinpe-badge--pendiente">Sin vincular</span>';

    const coincidencias = sinpeOrdenes.filter(o => o.cantidad === pago.monto);
    let coincidenciasTexto = '';
    if (coincidencias.length === 1) {
      const c = coincidencias[0];
      const cliente = c.cliente ? ` ¬∑ ${html(c.cliente)}` : '';
      coincidenciasTexto = `<div class="sinpe-coincidencias">Coincidencia por monto: ${html(c.fecha)}${cliente}</div>`;
    } else if (coincidencias.length > 1) {
      const detalle = coincidencias.map(c => `${html(c.fecha)} (${formatearColones(c.cantidad)}‚Ç°${c.cliente ? ' ¬∑ ' + html(c.cliente) : ''})`).join('<br>');
      coincidenciasTexto = `<div class="sinpe-coincidencias sinpe-orden-pendiente">${detalle}</div>`;
    }

    const selectId = `sinpeSelect_${pago.id}`;
    const opciones = ['<option value="">-- Selecciona una orden --</option>']
      .concat(sinpeOrdenes.map(o => {
        const ocupado = o.sinpeId && o.sinpeId !== pago.id;
        const selected = o.sinpeId === pago.id;
        const cliente = o.cliente ? ` ¬∑ ${o.cliente}` : '';
        const texto = `${o.fecha} ¬∑ ${formatearColones(o.cantidad)}‚Ç°${cliente}${ocupado ? ' (ocupada)' : ''}`;
        return `<option value="${html(o.fecha)}"${selected ? ' selected' : ''}${ocupado && !selected ? ' disabled' : ''}>${html(texto)}</option>`;
      }));

    const referencia = pago.referencia ? `<span>Ref: ${html(pago.referencia)}</span>` : '';
    const remitente = pago.remitente ? `<span>De: ${html(pago.remitente)}</span>` : '';
    const fecha = new Date(pago.creadoEn || Date.now()).toLocaleString();

    const ordenTexto = ordenActual
      ? `<div>Vinculado con: <strong>${html(ordenActual.fecha)}</strong>${ordenActual.cliente ? ` ¬∑ ${html(ordenActual.cliente)}` : ''}</div>`
      : '';

    return `
      <article class="sinpe-card">
        <header>
          <h3>‚Ç°${formatearColones(pago.monto)}</h3>
          ${badge}
        </header>
        <div class="sinpe-detalle">${[referencia, remitente].filter(Boolean).join(' ¬∑ ') || 'Sin detalles adicionales'}</div>
        <div class="sinpe-mensaje">${html(pago.mensaje)}</div>
        ${coincidenciasTexto}
        <div class="sinpe-card-actions">
          <select id="${selectId}" onchange="actualizarVinculoPagoSinpe('${pago.id}', this.value)">
            ${opciones.join('')}
          </select>
          <button type="button" class="confirmar" onclick="actualizarVinculoPagoSinpe('${pago.id}', document.getElementById('${selectId}').value)">Guardar v√≠nculo</button>
          <button type="button" class="peligro" onclick="eliminarPagoSinpe('${pago.id}')">Eliminar</button>
        </div>
        ${ordenTexto}
        <footer>Registrado: ${html(fecha)}</footer>
      </article>
    `;
  }).join('');
}

function abrirSinpeOverlay() {
  const overlay = document.getElementById('sinpeOverlay');
  if (!overlay) return;
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');
  renderPanelSinpe();
  setTimeout(() => {
    const textarea = document.getElementById('sinpeMensajes');
    if (textarea) textarea.focus();
  }, 0);
}

function cerrarSinpeOverlay() {
  const overlay = document.getElementById('sinpeOverlay');
  if (!overlay) return;
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden', 'true');
}

/* Enviar / recoger selecci√≥n */
function recogerSeleccionProductosBase() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => out[nombre] = seleccionActual[nombre].total || 0);
  return out;
}
function recogerSeleccionVariantes() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => {
    const vars = seleccionActual[nombre].variantes || {};
    if (Object.keys(vars).length) out[nombre] = {...vars};
  });
  return out;
}
function enviar() {
  const totalNum = +document.getElementById('total').innerText.replace(/[^\d]/g, '');
  if (totalNum == 0) { alert('A√±ade productos'); return; }

  const metodo = document.querySelector('input[name="pago"]:checked').value;
  const productosVendidos = recogerSeleccionProductosBase();
  const variantesVendidas = recogerSeleccionVariantes();
  const cliente = (document.getElementById('cliente').value || '').trim();

  let ordenes = cargarTabla();
  ordenes.push(crearOrdenRegistro({
    cliente,
    productos: productosVendidos,
    variantes: variantesVendidas,
    metodo,
    estado: 'pagado',
    cuenta: null,
    entregasServidas: false
  }));

  guardarTabla(ordenes);
  intentarConciliarPagosSinpe();
  actualizarTabla();
  borrar();
}

/* Limpiar selecci√≥n */
function borrar() {
  seleccionActual = {};
  productosNodos.forEach(p => {
    const c = p.querySelector('.contador'), r = p.querySelector('.restar');
    if (c) { c.textContent = ''; c.style.display = 'none'; }
    if (r) { r.style.display = 'none'; }
  });
  ocultarPanelVariantes();
  const clienteInput = document.getElementById('cliente');
  if (clienteInput) clienteInput.value = '';
  actualizarResumen();
}

/* =================== CUENTAS ABIERTAS (con variantes) =================== */
function cargarCuentas() {
  return JSON.parse(localStorage.getItem(STORAGE_KEYS.cuentas) || '{}'); // { nombre: {productos:{}, variantes:{}, creado:ts} }
}
function guardarCuentas(obj) { localStorage.setItem(STORAGE_KEYS.cuentas, JSON.stringify(obj)); }

function anadirACuentaAbierta() {
  const base = recogerSeleccionProductosBase();
  const vars = recogerSeleccionVariantes();
  const hayAlgo = Object.values(base).some(v => v > 0);
  if (!hayAlgo) { alert('A√±ade productos para pasar a la cuenta abierta'); return; }

  let nombre = (document.getElementById('cliente').value || '').trim();
  if (!nombre) nombre = nombreSugerido();

  const cuentas = cargarCuentas();
  if (!cuentas[nombre]) cuentas[nombre] = { productos:{}, variantes:{}, creado: Date.now() };

  for (let n in base) cuentas[nombre].productos[n] = (cuentas[nombre].productos[n] || 0) + base[n];
  Object.keys(vars).forEach(p=>{
    cuentas[nombre].variantes[p] = cuentas[nombre].variantes[p] || {};
    Object.keys(vars[p]).forEach(vn=>{
      cuentas[nombre].variantes[p][vn] = (cuentas[nombre].variantes[p][vn] || 0) + vars[p][vn];
    });
  });

  guardarCuentas(cuentas);
  let ordenes = cargarTabla();
  ordenes.push(crearOrdenRegistro({
    cliente: nombre,
    productos: base,
    variantes: vars,
    metodo: 'Cuenta abierta',
    estado: 'cuenta_abierta',
    cuenta: nombre,
    entregasServidas: false
  }));
  guardarTabla(ordenes);
  renderCuentas();
  actualizarTabla();
  borrar();
}
function nombreSugerido() {
  const base = 'Misionero';
  const cuentas = cargarCuentas();
  if (!cuentas[base]) return base;
  let i = 2;
  while (cuentas[`${base} ${i}`]) i++;
  return `${base} ${i}`;
}

function resumenLineaProductosCuenta(productosMapa, variantesMapa) {
  const PRODS = cargarProductos();
  const partes = [];
  const nombres = Object.keys(productosMapa).sort((a,b)=>a.localeCompare(b));
  nombres.forEach(nombre => {
    const prod = PRODS.find(p => p.nombre === nombre);
    const cant = productosMapa[nombre];
    const icono = prod?.icono || '';
    const vars = variantesMapa?.[nombre];
    const varTxt = vars ? ' [' + Object.keys(vars).map(v=>`${v}:${vars[v]}`).join(' ¬∑ ') + ']' : '';
    partes.push(`${icono ? html(icono) : ''}√ó${cant} (${html(nombre)})${varTxt}`);
  });
  return partes.join(' ¬∑ ');
}

function renderCuentas() {
  const cont = document.getElementById('cuentasLista');
  const panel = document.getElementById('cuentasPanel');
  const cuentas = cargarCuentas();
  const entries = Object.entries(cuentas).sort((a,b)=>a[1].creado - b[1].creado);
  cont.innerHTML = '';

  if (entries.length === 0) { panel.style.display = 'none'; return; }
  panel.style.display = 'block';

  entries.forEach(([nombre, data]) => {
    const total = calcularTotalDesdeMapa(data.productos, cargarProductos()).total;
    const card = document.createElement('div');
    card.className = 'cta-card';
    const idMet = idFromName(nombre) + '-metodo';

    card.innerHTML = `
      <div class="cta-top">
        <span>${escapeHtml(nombre)}</span>
        <span>${total}‚Ç°</span>
      </div>
      <div class="cta-sub">${resumenLineaProductosCuenta(data.productos, data.variantes) || '<span class="muted">Vac√≠a</span>'}</div>
      <div class="cta-actions">
        <button onclick="anadirSeleccionA('${jsEsc(nombre)}')">A√±adir selecci√≥n</button>
        <select id="${idMet}">
          <option value="efectivo">Efectivo</option>
          <option value="sinpe">Sinpe</option>
        </select>
        <button onclick="cerrarCuenta('${jsEsc(nombre)}')">Cobrar y cerrar</button>
        <button onclick="eliminarCuenta('${jsEsc(nombre)}')">Eliminar</button>
      </div>
    `;
    cont.appendChild(card);
  });
}

function anadirSeleccionA(nombre) {
  const base = recogerSeleccionProductosBase();
  const vars = recogerSeleccionVariantes();
  const hayAlgo = Object.values(base).some(v => v > 0);
  if (!hayAlgo) { alert('A√±ade productos para sumarlos a la cuenta'); return; }

  const cuentas = cargarCuentas();
  if (!cuentas[nombre]) cuentas[nombre] = { productos:{}, variantes:{}, creado: Date.now() };

  for (let n in base) cuentas[nombre].productos[n] = (cuentas[nombre].productos[n] || 0) + base[n];
  Object.keys(vars).forEach(p=>{
    cuentas[nombre].variantes[p] = cuentas[nombre].variantes[p] || {};
    Object.keys(vars[p]).forEach(vn=>{
      cuentas[nombre].variantes[p][vn] = (cuentas[nombre].variantes[p][vn] || 0) + vars[p][vn];
    });
  });

  guardarCuentas(cuentas);
  renderCuentas();
  let ordenes = cargarTabla();
  ordenes.push(crearOrdenRegistro({
    cliente: nombre,
    productos: base,
    variantes: vars,
    metodo: 'Cuenta abierta',
    estado: 'cuenta_abierta',
    cuenta: nombre,
    entregasServidas: false
  }));
  guardarTabla(ordenes);
  actualizarTabla();
  borrar();
}

function cerrarCuenta(nombre) {
  const cuentas = cargarCuentas();
  const data = cuentas[nombre];
  if (!data || !data.productos || Object.keys(data.productos).length === 0) {
    alert('La cuenta est√° vac√≠a.');
    return;
  }
  const idMet = idFromName(nombre) + '-metodo';
  const metodo = (document.getElementById(idMet)?.value) || 'efectivo';

  const productosMap = data.productos;
  const variantesMap = data.variantes || {};

  let ordenes = cargarTabla();
  ordenes = ordenes.filter(o => !(esCuentaAbiertaOrden(o) && o.cuenta === nombre));
  ordenes.push(crearOrdenRegistro({
    cliente: nombre,
    productos: productosMap,
    variantes: variantesMap,
    metodo,
    estado: 'pagado',
    cuenta: null,
    entregasServidas: true
  }));
  guardarTabla(ordenes);
  intentarConciliarPagosSinpe();

  delete cuentas[nombre];
  guardarCuentas(cuentas);

  renderCuentas();
  actualizarTabla();
}

function eliminarCuenta(nombre) {
  if (!confirm(`¬øEliminar la cuenta abierta "${nombre}"?`)) return;
  const cuentas = cargarCuentas();
  delete cuentas[nombre];
  guardarCuentas(cuentas);
  renderCuentas();
}

/* Helpers */
function idFromName(name) { return 'cta_' + name.replace(/[^a-z0-9_-]/gi, '_'); }
function jsEsc(s){ return String(s).replace(/'/g, "\\'"); }
function escapeHtml(s) {
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* =================== PRECIO COMBO =================== */
function calcularTotalDesdeMapa(mapa, PRODS=null) {
  const PRODUCTOS = PRODS || cargarProductos();
  let total = 0;
  let individuales = { ...mapa };
  const combos = [];
  let cambios;
  do {
    cambios = false;
    const posiblesBebidas = PRODUCTOS.filter(p => p.tipo === 'bebida' && (individuales[p.nombre] || 0) > 0);
    const posiblesComidas = PRODUCTOS.filter(p => p.tipo === 'comida' && (individuales[p.nombre] || 0) > 0);
    for (let bebida of posiblesBebidas) {
      for (let comida of posiblesComidas) {
        if ((individuales[bebida.nombre] || 0) > 0 &&
            (individuales[comida.nombre] || 0) > 0 &&
            (Number(bebida.precio) + Number(comida.precio)) > Number(PRECIO_COMBO)) {
          combos.push([bebida.nombre, comida.nombre]);
          individuales[bebida.nombre]--;
          individuales[comida.nombre]--;
          cambios = true;
          break;
        }
      }
      if (cambios) break;
    }
  } while (cambios);

  const comboCantidades = {};
  combos.forEach(c => {
    const clave = c.join(' + ');
    comboCantidades[clave] = (comboCantidades[clave] || 0) + 1;
  });

  for (let combo in comboCantidades) total += comboCantidades[combo] * PRECIO_COMBO;
  for (let p in individuales) {
    const cant = individuales[p] || 0;
    if (cant > 0) {
      const precioUnitario = PRODUCTOS.find(x => x.nombre === p)?.precio || 0;
      total += cant * precioUnitario;
    }
  }
  return { total, comboCantidades, individuales };
}

/* =================== CIERRE DE CAJA (incluye variantes en resumen CSV) =================== */
function cerrarCaja() {
  if (!confirm("¬øSeguro que quieres cerrar la caja? Se enviar√° un resumen al correo y se eliminar√°n los datos actuales (las Cuentas abiertas no se tocan).")) return;

  const ordenes = cargarTabla();
  const pagadas = ordenes.filter(o => !esCuentaAbiertaOrden(o));
  const pendientes = ordenes.filter(o => esCuentaAbiertaOrden(o));
  const fecha = new Date().toISOString().split('T')[0];
  const subject = `Ignis Latte - Cierre de caja ${fecha}`;
  const message = `Cierre autom√°tico generado el ${fecha}`;

  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  pagadas.forEach(o => {
    resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
    resumen.total += o.cantidad;
    for (let p in o.productos) {
      resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
    }
    const vars = o.variantes || {};
    Object.keys(vars).forEach(base=>{
      resumen.variantes[base] = resumen.variantes[base] || {};
      Object.keys(vars[base]).forEach(vn=>{
        resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
      });
    });
  });

  let tablaResumenTexto = "Resumen;Valor\n";
  tablaResumenTexto += `Total Recaudado;${resumen.total}‚Ç°\n`;
  tablaResumenTexto += `Total Efectivo;${resumen.efectivo || 0}‚Ç°\n`;
  tablaResumenTexto += `Total Sinpe;${resumen.sinpe || 0}‚Ç°\n`;
  for (let p in resumen.productos) {
    tablaResumenTexto += `Ventas de ${p};${resumen.productos[p]}\n`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      tablaResumenTexto += `Variantes de ${p};${Object.keys(vars).map(v=>`${v}:${vars[v]}`).join(' | ')}\n`;
    }
  }

  let tablaHistoricaTexto = "Fecha;Cliente;Cantidad;M√©todo\n";
  pagadas.forEach(o => {
    tablaHistoricaTexto += `${o.fecha};${o.cliente || ''};${o.cantidad}‚Ç°;${o.metodo}\n`;
  });

  emailjs.send("service_kmko3hp", "template_7xn4zvs", {
    subject, message,
    tabla_resumen: tablaResumenTexto,
    tabla_historica: tablaHistoricaTexto,
    name: "Ignis Latte",
    email: "info@ignismundi.org"
  }).then(() => {
    alert("Correo enviado con √©xito.");
    if (pendientes.length > 0) {
      guardarTabla(pendientes);
    } else {
      localStorage.removeItem(STORAGE_KEYS.ordenes);
    }
    actualizarTabla();
  }, (error) => {
    console.error(error);
    alert("Error al enviar el correo: " + JSON.stringify(error));
  });
}

const btnPendientes = document.getElementById('verPendientesBtn');
if (btnPendientes) {
  btnPendientes.addEventListener('click', () => abrirPendientes('cliente'));
}

const overlayPendientes = document.getElementById('pendientesOverlay');
if (overlayPendientes) {
  overlayPendientes.addEventListener('click', (event) => {
    if (event.target === overlayPendientes) cerrarPendientes();
  });
  const closeBtn = overlayPendientes.querySelector('.pendientes-close');
  if (closeBtn) closeBtn.addEventListener('click', cerrarPendientes);
  overlayPendientes.querySelectorAll('.pendientes-tab').forEach(tabBtn => {
    tabBtn.addEventListener('click', () => {
      const tab = tabBtn.dataset.tab || 'cliente';
      cambiarTabPendientes(tab);
    });
  });
}

const overlaySinpe = document.getElementById('sinpeOverlay');
if (overlaySinpe) {
  overlaySinpe.addEventListener('click', (event) => {
    if (event.target === overlaySinpe) cerrarSinpeOverlay();
  });
}

document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') {
    cancelarEliminarTodos();
    cerrarPendientes();
    cerrarSinpeOverlay();
    ocultarPanelVariantes();
  }
});

const overlayEliminarTodos = document.getElementById('warningEliminarTodos');
if (overlayEliminarTodos) {
  overlayEliminarTodos.addEventListener('click', (event) => {
    if (event.target === overlayEliminarTodos) cancelarEliminarTodos();
  });
}

aplicarConfigApertura();
inicializarBreakdown('apertura');
inicializarBreakdown('cierre');

document.querySelectorAll('.toggle-breakdown').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.dataset.target;
    if (target) toggleBreakdownById(target, btn);
  });
});

document.querySelectorAll('input[name="responsableHoy"]').forEach(radio => {
  radio.addEventListener('change', () => {
    if (!radio.checked) return;
    configApertura.responsable = radio.value;
    guardarConfigApertura();
    actualizarResumenApertura();
  });
});

const fondoInput = document.getElementById('fondoCajaInput');
if (fondoInput) {
  fondoInput.addEventListener('input', () => {
    configApertura.fondo = parseColones(fondoInput.value);
    guardarConfigApertura();
    actualizarResumenApertura();
  });
}

const cierreInput = document.getElementById('cierreEfectivoInput');
if (cierreInput) {
  cierreInput.addEventListener('input', () => {
    actualizarPanelCierre();
  });
}

actualizarResumenApertura();
actualizarPanelCierre();

/* =================== ARRANQUE (Datos base) =================== */
crearProductos();
actualizarResumen();
actualizarTabla();
intentarConciliarPagosSinpe();
renderCuentas();

mostrarTab('apertura');
</script>
</body>
</html>
