<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ignis Latte</title>
<style>
  /* Base m√≠nimo; puedes sobreescribir desde fuera */
  body {
    font-family: Arial, sans-serif;
    --main-offset: 20%;
    --main-width: 80%;
  }
  body[data-active-tab="apertura"] {
    --main-offset: 30%;
    --main-width: 70%;
  }
  body[data-active-tab="pedidos"] {
    --main-offset: 16%;
    --main-width: 84%;
  }

  .pendientes-btn {
    position:fixed;
    top:16px;
    right:16px;
    z-index:2200;
    padding:10px 18px;
    margin:0;
    border-radius:999px;
    background:#3949ab;
    color:#fff;
    border:none;
    font-weight:bold;
    box-shadow:0 4px 14px rgba(0,0,0,0.25);
    cursor:pointer;
  }
  .pendientes-btn:hover { background:#283593; }

  .pendientes-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.35);
    display:none;
    align-items:flex-start;
    justify-content:flex-end;
    padding:24px;
    z-index:3000;
  }
  .pendientes-overlay.active { display:flex; }
  .pendientes-dialog {
    width:min(420px, 90vw);
    background:#fff;
    border-radius:12px;
    box-shadow:0 12px 32px rgba(0,0,0,0.35);
    padding:18px;
    max-height:80vh;
    overflow:hidden;
  }
  .pendientes-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:12px;
  }
  .pendientes-close {
    background:none;
    border:none;
    font-size:22px;
    cursor:pointer;
    line-height:1;
    color:#555;
  }
  .pendientes-tabs {
    display:flex;
    gap:8px;
    margin-bottom:14px;
  }
  .pendientes-tab {
    flex:1;
    padding:8px 12px;
    border:1px solid #c5cae9;
    border-radius:8px;
    background:#e8eaf6;
    cursor:pointer;
    font-weight:bold;
  }
  .pendientes-tab.active {
    background:#3949ab;
    color:#fff;
    border-color:#3949ab;
  }
  .pendientes-panes {
    overflow-y:auto;
    max-height:calc(80vh - 110px);
  }
  .pendientes-pane[hidden] { display:none; }
  .pendiente-card {
    border:1px solid #e0e0e0;
    border-radius:10px;
    padding:10px 12px;
    background:#fafafa;
    margin-bottom:10px;
  }
  .pendiente-card-header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:6px;
  }
  .pendiente-card-header .header-left {
    display:flex;
    align-items:center;
    gap:8px;
  }
  .pendientes-icono {
    font-size:24px;
    line-height:1;
  }
  .pendientes-total {
    font-size:13px;
    color:#3949ab;
    font-weight:bold;
  }
  .pendientes-list {
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .pendientes-list li {
    display:flex;
    flex-direction:column;
    gap:2px;
    font-size:13px;
  }
  .pendientes-list li .fila-principal {
    display:flex;
    align-items:center;
    gap:8px;
    flex-wrap:wrap;
  }
  .pendiente-completar {
    margin-left:auto;
    background:#2e7d32;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:4px 10px;
    font-size:12px;
    cursor:pointer;
    transition:background 0.2s ease;
  }
  .pendiente-completar:hover { background:#1b5e20; }
  .pendientes-variantes {
    font-size:12px;
    color:#555;
    margin-left:4px;
  }
  .pendientes-variante {
    font-size:12px;
    color:#3949ab;
    background:#e8eaf6;
    border-radius:10px;
    padding:2px 8px;
    margin-left:4px;
  }
  .pendientes-fecha {
    font-size:11px;
    color:#888;
    display:none;
  }

  #tabla .col-fecha {
    display:none;
  }
  #tabla th:nth-child(4) {
    text-align:center;
  }
  #tabla td:nth-child(4) {
    text-align:right;
  }
  .pendientes-vacio {
    text-align:center;
    color:#666;
    padding:24px 0;
  }

  /* Inputs/controles con fondo transparente */
  input, select, textarea {
    background: transparent;
  }

  /* Tabs */
  .tabs {
    position:fixed;
    top:8px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    margin:0;
    width:auto;
  }
  .tab-content { width:100%; margin:10px 0; }

  /* Distribuci√≥n especial para pedidos en tablet horizontal */
  .pedidos-layout {
    display:flex;
    gap:20px;
    align-items:flex-start;
    margin-left:var(--main-offset);
    width:var(--main-width);
  }
  .pedidos-left,
  .pedidos-right {
    flex:1;
    min-width:0;
  }
  .pedidos-left {
    display:flex;
    flex-direction:column;
    gap:16px;
  }
  .pedidos-right {
    display:flex;
    flex-direction:column;
    gap:12px;
    padding-right:4px;
    flex:0 0 35%;
    max-width:35%;
    margin-left:auto;
  }

  .panel-nuevo-pedido {
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  /* Grid productos */
  .productos-grid-wrapper {
    position:relative;
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-start;
  }
  .productos-acciones {
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .productos-acciones .limpiar-btn {
    margin:0;
  }
  .variantes-overlay {
    position:absolute;
    left:0;
    top:0;
    width:0;
    height:0;
    pointer-events:none;
    z-index:2050;
    opacity:0;
    transition:opacity 0.18s ease;
  }
  .variantes-overlay.visible {
    opacity:1;
  }
  .variantes-lista {
    position:absolute;
    left:0;
    top:0;
    transform:translate(-50%, -50%);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
    pointer-events:none;
  }
  .variante-bubble {
    position:relative;
    min-width:64px;
    max-width:140px;
    padding:6px 12px;
    border-radius:8px;
    border:2px solid #9fa8da;
    background:#f5f6fe;
    color:#1a237e;
    font-weight:600;
    font-size:12px;
    display:flex;
    align-items:center;
    justify-content:center;
    text-align:center;
    box-shadow:0 6px 18px rgba(57,73,171,0.22);
    cursor:pointer;
    pointer-events:auto;
    transition:transform 0.18s ease, box-shadow 0.18s ease, background-color 0.18s ease, border-color 0.18s ease;
    white-space:nowrap;
  }
  .variante-bubble:hover {
    transform:scale(1.04);
    box-shadow:0 10px 22px rgba(57,73,171,0.28);
    background-color:#eef0ff;
    border-color:#7986cb;
  }
  .grid {
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:10px;
    flex:1 1 360px;
  }
  .producto {
    border:1px solid #999; padding:9px; position:relative; font-weight:bold; font-size:14px; border-radius:6px;
    display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; /* centrado */
    min-height:60px;
    user-select:none;
    transition:box-shadow 0.2s ease, transform 0.2s ease;
  }
  .producto.activo {
    box-shadow:0 0 0 3px rgba(46,125,50,0.45);
    transform:translateY(-2px);
    z-index:50;
  }
  .icono { display:block; font-size:30px; margin-bottom:4px; line-height:1; text-align:center; }
  .contador {
    position:absolute; top:6px; right:6px; background:#000; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    display:none; text-align:center; font-size:12px;
  }
  .restar {
    position:absolute; bottom:6px; right:6px; background:#c00; color:#fff; border-radius:50%; width:22px; height:22px; line-height:22px;
    text-align:center; cursor:pointer; display:none; font-size:14px;
  }

  button { padding:8px 14px; margin:6px; cursor:pointer; }
  .eliminar-todos-btn {
    background:#d32f2f;
    color:#fff;
    border:none;
    border-radius:6px;
    padding:6px 12px;
    font-weight:bold;
    cursor:pointer;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:6px;
    transition:background 0.2s ease;
  }
  .eliminar-todos-btn:hover { background:#b71c1c; }
  #tabla th.col-eliminar,
  #tabla td.col-eliminar {
    width:32px;
    padding:4px;
    text-align:center;
  }
  .btn-eliminar-orden {
    width:18px;
    height:18px;
    min-width:18px;
    padding:0;
    margin:0;
    border:none;
    border-radius:50%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:10px;
    line-height:1;
    background:transparent;
    color:#c62828;
    cursor:pointer;
    transition:background 0.2s ease, transform 0.2s ease;
  }
  .btn-eliminar-orden:hover {
    background:rgba(198, 40, 40, 0.12);
    transform:scale(1.05);
  }
  .btn-eliminar-orden:focus-visible {
    outline:2px solid rgba(198, 40, 40, 0.4);
    outline-offset:2px;
  }
  .limpiar-btn {
    width:108px;
    height:108px;
    border-radius:50%;
    border:none;
    background:#e0e0e0;
    color:#424242;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:6px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.15);
    margin:0;
    padding:0;
    transition:transform 0.2s ease, box-shadow 0.2s ease;
  }
  .limpiar-btn:hover { transform:translateY(-2px); box-shadow:0 6px 14px rgba(0,0,0,0.2); }
  .limpiar-btn:active { transform:translateY(0); box-shadow:0 2px 6px rgba(0,0,0,0.18); }
  .limpiar-icono {
    font-size:36px;
    line-height:1;
  }
  .limpiar-texto {
    font-size:14px;
    text-transform:uppercase;
    letter-spacing:0.5px;
  }
  table { margin:16px auto; width:100%; border-collapse:collapse; }
  th, td { border:1px solid #ddd; padding:8px; vertical-align: middle; text-align:left; }
  .resumen-panel {
    display:grid;
    grid-template-columns: 1.4fr 1fr 1fr;
    gap:12px;
    width:100%;
    align-items:flex-start;
  }
  .resumen-panel > div {
    background:#f9f9f9;
    border:1px solid #ddd;
    border-radius:6px;
    padding:10px;
  }
  #resumenOrden,
  #total,
  #sugerenciaCambio {
    text-align:left;
    width:100%;
  }
  #sugerenciaCambio ul {
    list-style:none;
    padding:0;
    margin:8px 0 0 0;
  }
  #sugerenciaCambio li { margin-bottom:4px; }
  .indentado { padding-left:20px; color:#555; font-size:90%; text-align:left; }

  .warning-overlay {
    position:fixed;
    inset:0;
    background:rgba(0,0,0,0.7);
    display:none;
    align-items:center;
    justify-content:center;
    z-index:2000;
    padding:20px;
  }
  .warning-overlay.active { display:flex; }
  .warning-dialog {
    background:#fff8e1;
    border:4px solid #ff6f00;
    padding:30px 26px;
    max-width:520px;
    width:100%;
    text-align:center;
    border-radius:14px;
    box-shadow:0 12px 40px rgba(0,0,0,0.45);
    animation:warning-pop 0.25s ease-out;
  }
  .warning-dialog h2 {
    margin:0 0 18px 0;
    color:#d84315;
    font-size:30px;
    text-transform:uppercase;
    letter-spacing:1px;
  }
  .warning-dialog p {
    margin:0 0 24px 0;
    color:#5d4037;
    font-size:18px;
    line-height:1.5;
  }
  .warning-actions {
    display:flex;
    flex-wrap:wrap;
    gap:14px;
    justify-content:center;
  }
  .warning-actions button {
    border:none;
    border-radius:8px;
    padding:10px 20px;
    font-weight:bold;
    cursor:pointer;
    font-size:16px;
  }
  .warning-actions .confirm { background:#d32f2f; color:#fff; }
  .warning-actions .confirm:hover { background:#b71c1c; }
  .warning-actions .cancel { background:#eceff1; color:#37474f; }
  .warning-actions .cancel:hover { background:#cfd8dc; }

  @keyframes warning-pop {
    from { transform:scale(0.8); opacity:0; }
    to { transform:scale(1); opacity:1; }
  }

  .pendiente-checkbox { width:16px; height:16px; cursor:pointer; vertical-align:middle; margin-right:6px; }

  tr.servido { opacity:0.35; }
  tr.orden-casa { background:#fff9e6; }

  #cliente {
    padding:7px 10px; width:min(520px, 100%); margin:10px 0 0 0; display:block;
    border:1px solid #ccc; border-radius:6px; font-size:14px;
  }

  .productos-linea {
    display:flex;
    flex-direction:row;
    align-items:center;
    justify-content:flex-end;
    gap:8px;
    margin-bottom:3px;
    text-align:right;
  }
  .productos-linea:last-child { margin-bottom:0; }
  .entrega-unidades {
    display:flex;
    flex-wrap:nowrap;
    gap:2px;
    justify-content:flex-end;
  }
  .entrega-unidad {
    border:1px solid #c5cae9;
    background:#eef0ff;
    color:#1a237e;
    border-radius:10px;
    min-width:36px;
    min-height:36px;
    padding:6px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
    cursor:pointer;
    font-weight:600;
    transition:transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, background 0.2s ease, border-color 0.2s ease;
  }
  .entrega-unidad:hover {
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(57,73,171,0.2);
  }
  .entrega-unidad.servida {
    opacity:0.35;
    background:#f5f5f5;
    border-color:#b0bec5;
    box-shadow:none;
  }
  .entrega-unidad:focus-visible {
    outline:3px solid #3949ab;
    outline-offset:2px;
  }
  .entrega-unidad .unidad-icono {
    font-size:20px;
    line-height:1;
  }
  .entrega-unidad .unidad-variante {
    font-size:10px;
    line-height:1.1;
    color:#37474f;
    text-align:center;
    font-weight:500;
    max-width:60px;
    word-break:break-word;
  }
  .entrega-unidad.sin-icono .unidad-icono {
    font-size:13px;
    background:#3949ab;
    color:#fff;
    border-radius:999px;
    padding:4px 8px;
    min-width:28px;
  }

  .productos-maestro {
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:6px;
    margin-bottom:6px;
    text-align:right;
  }
  .master-checkbox {
    width:18px;
    height:18px;
    cursor:pointer;
    transform:scale(1.1);
    transform-origin:center;
  }

  .sr-only {
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0, 0, 0, 0);
    white-space:nowrap;
    border:0;
  }

  .acciones-pedido {
    display:flex;
    align-items:center;
    gap:14px;
    flex-wrap:wrap;
    margin-top:16px;
  }
  .accion-redonda {
    width:60px;
    height:60px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    font-weight:700;
    font-size:11px;
    line-height:1.1;
    text-align:center;
    word-break:break-word;
    padding:0 8px;
    border:none;
    margin:0;
    box-shadow:0 6px 20px rgba(0,0,0,0.18);
    transition:transform 0.2s ease, box-shadow 0.2s ease;
  }
  .accion-redonda:active { transform:scale(0.96); }
  .accion-redonda:hover { box-shadow:0 8px 24px rgba(0,0,0,0.22); }
  .accion-redonda:focus-visible {
    outline:3px solid #fff;
    outline-offset:2px;
    box-shadow:0 0 0 4px rgba(57,73,171,0.45);
  }

  .boton-enviar {
    border:3px solid #2e7d32;
    background-color:#2e7d32;
    color:#fff;
  }

  .pago-acciones {
    display:flex;
    flex-wrap:wrap;
    justify-content:flex-end;
    gap:6px;
    align-items:center;
    margin-left:auto;
  }
  .pago-btn {
    border:none;
    border-radius:6px;
    padding:6px 10px;
    font-size:12px;
    cursor:pointer;
    font-weight:600;
    transition:filter 0.2s ease;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:4px;
  }
  .pago-btn:hover { filter:brightness(0.95); }
  .pago-btn.efectivo { background:#d9f2d9; color:#1b5e20; }
  .pago-btn.sinpe { background:#e0ebff; color:#1b3c8a; }
  .pago-btn.casa { background:#fff4d5; color:#8a5a00; }
  .pago-btn.simple { background:#eceff1; color:#37474f; }
  .pago-dropdown {
    position:relative;
  }
  .pago-dropdown::after {
    content:'‚ñæ';
    position:absolute;
    right:10px;
    top:50%;
    transform:translateY(-50%);
    font-size:10px;
    color:#8a5a00;
    pointer-events:none;
  }
  .pago-select {
    appearance:none;
    -webkit-appearance:none;
    -moz-appearance:none;
    border:none;
    border-radius:6px;
    padding:6px 26px 6px 10px;
    font-size:12px;
    font-weight:600;
    cursor:pointer;
    background:#fff4d5;
    color:#8a5a00;
  }
  .pago-select:focus {
    outline:3px solid rgba(138,90,0,0.25);
    outline-offset:1px;
  }
  .pago-badge {
    display:inline-flex;
    align-items:center;
    gap:6px;
    border-radius:999px;
    padding:4px 10px;
    font-weight:600;
    font-size:12px;
  }
  .pago-badge.pago-efectivo { background:#2e7d32; color:#fff; }
  .pago-badge.pago-sinpe { background:#1b3c8a; color:#fff; }
  .pago-badge.pago-pendiente { background:#eceff1; color:#455a64; }
  .pago-badge.pago-casa { background:#fff4d5; color:#8a5a00; }
  .pago-badge button {
    border:none;
    border-radius:999px;
    padding:2px 8px;
    font-size:11px;
    cursor:pointer;
    color:inherit;
    background:rgba(255,255,255,0.2);
  }
  .pago-badge button:hover {
    background:rgba(0,0,0,0.15);
  }

  @media (max-width: 1024px) {
    .accion-redonda {
      width:54px;
      height:54px;
      font-size:10px;
    }
    .acciones-pedido { justify-content:flex-start; }
    .variantes-panel {
      min-width:100%;
      max-width:none;
      order:-1;
    }
    .casas-grid {
      grid-template-columns:repeat(2, minmax(0, 1fr));
    }
  }
  @media (max-width: 640px) {
    .grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .casas-grid {
      grid-template-columns:1fr;
    }
  }
  @media (max-width: 420px) {
    .grid {
      grid-template-columns:1fr;
    }
    .accion-redonda {
      width:50px;
      height:50px;
      font-size:9px;
    }
  }
  .btn-cierre-caja {
    background:#fdeaea;
    border:2px solid #d64b4b;
    color:#8a1e1e;
  }
  .btn-cierre-caja:hover {
    background:#f8d0d0;
    border-color:#c03a3a;
  }

  .cierre-pendientes {
    margin-top:24px;
  }
  #tablaPendientesPago {
    width:100%;
    border-collapse:collapse;
    margin-top:12px;
  }
  #tablaPendientesPago th,
  #tablaPendientesPago td {
    padding:8px;
    border-bottom:1px solid #e0e0e0;
    text-align:left;
    font-size:13px;
  }
  #tablaPendientesPago tbody tr:last-child td { border-bottom:none; }

  .casas-wrapper {
    margin-left:var(--main-offset);
    width:var(--main-width);
    padding:24px 0 40px 0;
  }
  .casas-wrapper h2 {
    margin-top:0;
  }
  .casas-grid {
    display:grid;
    grid-template-columns:repeat(3, minmax(0, 1fr));
    gap:18px;
    margin-top:18px;
  }
  .casa-card {
    background:#fff;
    border-radius:12px;
    box-shadow:0 8px 22px rgba(0,0,0,0.12);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .casa-card h3 {
    margin:0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    font-size:18px;
  }
  .casa-pedidos-list {
    list-style:none;
    padding:0;
    margin:0;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .casa-pedido {
    border:1px solid #e0e0e0;
    border-radius:10px;
    background:#fafafa;
    padding:10px;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .casa-pedido-header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    font-weight:600;
  }
  .casa-pedido-acciones {
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
  }
  .casa-vacia {
    color:#90a4ae;
    font-style:italic;
  }

  @media (max-width: 1024px) {
    .pedidos-layout { flex-direction:column; }
    .pedidos-right {
      flex:unset;
      max-width:none;
      width:100%;
      margin-left:0;
    }
  }

  @media (max-width: 900px) {
    .productos-editor {
      margin-left:0;
      width:100%;
    }
    .pedidos-layout {
      margin-left:0;
      width:100%;
    }
    .tab-content {
      width:95%;
      margin:10px auto;
    }
    .tabs {
      margin:10px auto;
      width:95%;
      justify-content:center;
    }
    .productos-grid-wrapper {
      justify-content:center;
    }
    .variantes-panel {
      order:-1;
      width:100%;
      max-width:none;
    }
    .grid {
      flex:1 1 260px;
    }
    .limpiar-btn {
      align-self:center;
    }
  }

  @media (max-width: 768px) {
    .resumen-panel {
      grid-template-columns:1fr;
    }
  }

  /* Cuentas abiertas */
  .muted { color:#666; font-size:12px; }

  /* Editor de productos */
  #tabProductos {
    position:relative;
  }
  .productos-editor {
    margin-left:var(--main-offset);
    width:var(--main-width);
  }
  .editor-actions { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:8px 0; }
  .small { font-size:12px; color:#555; }
  .number { width:110px; }
  .tipo-select { width:130px; }
  .icono-input { width:100px; }
  .nombre-input { width:100%; }
  .variantes-input {
    width:100%;
  }
  .variantes-input::placeholder {
    color:rgba(57,73,171,0.35);
  }
  .help { font-size:12px; color:#666; margin-top:-4px; }

  /* Paneles con tercio en blanco */
  .panel-tercio {
    margin-left:var(--main-offset);
    width:var(--main-width);
    display:flex;
    flex-direction:column;
    gap:20px;
  }
  .apertura-card,
  .cierre-card {
    background:#f9f9f9;
    border:1px solid #ddd;
    border-radius:10px;
    padding:18px;
    box-shadow:0 4px 10px rgba(0,0,0,0.04);
  }
  .apertura-card h2,
  .cierre-card h2 {
    margin-top:0;
  }

  .apertura-resumen {
    display:flex;
    flex-direction:column;
    gap:6px;
    font-size:15px;
  }

  .fondo-input-group {
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:10px;
  }
  .fondo-input-group input[type="text"] {
    padding:8px 10px;
    border:1px solid #ccc;
    border-radius:6px;
    min-width:160px;
  }
  .toggle-breakdown {
    padding:8px 14px;
    border:1px solid #999;
    border-radius:6px;
    background:#fff;
    cursor:pointer;
  }
  .toggle-breakdown[aria-expanded="true"] {
    background:#e0f0ff;
    border-color:#007bff;
    font-weight:bold;
  }

  .cash-breakdown {
    display:none;
    margin-top:12px;
  }
  .cash-breakdown.open {
    display:block;
  }
  .cash-breakdown table {
    width:100%;
    border-collapse:collapse;
  }
  .cash-breakdown th,
  .cash-breakdown td {
    border:1px solid #ddd;
    padding:8px;
    text-align:center;
  }
  .den-label {
    font-weight:bold;
  }
  .billete-1000 { background:#ffe0e0; }
  .billete-2000 { background:#e0ecff; }
  .billete-5000 { background:#fff9db; }
  .billete-10000 { background:#e0ffe0; }
  .billete-20000 { background:#ffe9d6; }
  .cash-total {
    margin-top:10px;
    text-align:right;
    font-weight:bold;
  }
  .cash-count {
    width:80px;
    padding:6px;
    border:1px solid #ccc;
    border-radius:6px;
  }
  .cash-breakdown caption {
    caption-side:top;
    text-align:left;
    font-weight:bold;
    padding-bottom:6px;
  }

  .cierre-layout {
    display:flex;
    flex-wrap:wrap;
    gap:20px;
  }
  .cierre-left,
  .cierre-right {
    flex:1 1 320px;
  }
  .cierre-datos {
    display:flex;
    flex-direction:column;
    gap:6px;
    margin-top:16px;
    font-size:15px;
  }
  .cierre-datos-conteo {
    gap:10px;
  }
  .cierre-conteo-tabla {
    width:100%;
    border-collapse:collapse;
  }
  .cierre-conteo-tabla th {
    text-align:left;
    font-weight:600;
  }
  .cierre-conteo-tabla td {
    text-align:right;
  }
  .cierre-conteo-tabla th,
  .cierre-conteo-tabla td {
    padding:4px 0;
  }
  .diferencia {
    font-weight:bold;
  }
  .diferencia-positivo { color:#2e7d32; }
  .diferencia-negativo { color:#c62828; }
  .diferencia-neutro { color:#37474f; }

  input[type=number]::-webkit-outer-spin-button,
  input[type=number]::-webkit-inner-spin-button {
    -webkit-appearance:none;
    margin:0;
  }
  input[type=number] {
    -moz-appearance:textfield;
  }

  @media (max-width: 768px) {
    .panel-tercio {
      margin-left:0;
      width:100%;
    }
  }
</style>
</head>
<body>

<button type="button" id="verPendientesBtn" class="pendientes-btn">Pendientes</button>

<div id="pendientesOverlay" class="pendientes-overlay" aria-hidden="true">
  <div class="pendientes-dialog" role="dialog" aria-modal="true" aria-labelledby="pendientesTitulo">
    <div class="pendientes-header">
      <h2 id="pendientesTitulo" style="margin:0; font-size:20px;">Pendientes por servir</h2>
      <button type="button" class="pendientes-close" aria-label="Cerrar ventana de pendientes">√ó</button>
    </div>
    <div class="pendientes-tabs" role="tablist">
      <button type="button" id="pendientes-tab-cliente" class="pendientes-tab active" data-tab="cliente" role="tab" aria-selected="true" aria-controls="pendientesPorCliente">Por cliente</button>
      <button type="button" id="pendientes-tab-producto" class="pendientes-tab" data-tab="producto" role="tab" aria-selected="false" aria-controls="pendientesPorProducto">Por producto</button>
    </div>
    <div class="pendientes-panes">
      <div id="pendientesPorCliente" class="pendientes-pane" role="tabpanel" aria-labelledby="pendientes-tab-cliente"></div>
      <div id="pendientesPorProducto" class="pendientes-pane" role="tabpanel" aria-labelledby="pendientes-tab-producto" hidden></div>
    </div>
  </div>
</div>

<!-- TABS -->
<div class="tabs">
  <button id="tabAperturaBtn" class="tab-btn active" onclick="mostrarTab('apertura')">Apertura</button>
  <button id="tabProductosBtn" class="tab-btn" onclick="mostrarTab('productos')">Productos</button>
  <button id="tabPedidosBtn" class="tab-btn" onclick="mostrarTab('pedidos')">Pedidos</button>
  <button id="tabCierreBtn" class="tab-btn" onclick="mostrarTab('cierre')">Cierre</button>
  <button id="tabCasasBtn" class="tab-btn" onclick="mostrarTab('casas')">Casas</button>
</div>

<!-- TAB: APERTURA -->
<section id="tabApertura" class="tab-content">
  <div class="panel-tercio">
    <div class="apertura-card">
      <h3>Fondo de caja</h3>
      <p>Introduce el fondo inicial manualmente o detallando billetes y monedas.</p>
      <div class="fondo-input-group">
        <input id="fondoCajaInput" type="text" inputmode="numeric" value="10000" placeholder="‚Ç°" aria-label="Fondo de caja">
      </div>
      <div id="aperturaBreakdown" class="cash-breakdown open" data-context="apertura">
        <table>
          <thead>
            <tr>
              <th>Denominaci√≥n</th>
              <th>Cantidad</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody data-breakdown-body="apertura"></tbody>
        </table>
        <div class="cash-total">Total contado: <span data-breakdown-total="apertura">0‚Ç°</span></div>
      </div>
      <div class="apertura-resumen">
        <span>Fondo configurado: <strong id="aperturaFondoActual">10¬†000‚Ç°</strong></span>
      </div>
    </div>
  </div>
</section>

<!-- TAB: PEDIDOS -->
<section id="tabPedidos" class="tab-content" style="display:none;">
  <div class="pedidos-layout">
    <div class="pedidos-left">
      <table id="tabla">
        <thead>
          <tr>
            <th class="col-fecha">Fecha</th>
            <th>Cliente</th>
            <th>Importe</th>
            <th>Pago</th>
            <th>Productos</th>
            <th class="col-eliminar" aria-label="Eliminar orden"></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

    </div>

    <div class="pedidos-right">
      <div class="panel-nuevo-pedido">
        <div class="productos-grid-wrapper">
          <div class="grid" id="productosGrid"></div>
          <div id="variantesOverlay" class="variantes-overlay" hidden></div>
          <div class="productos-acciones">
            <button type="button" class="limpiar-btn" onclick="borrar()">
              <span class="limpiar-icono" aria-hidden="true">üóëÔ∏è</span>
              <span class="limpiar-texto">Borrar</span>
            </button>
            <button type="button" class="limpiar-btn registrar-btn" onclick="enviar()">
              <span class="limpiar-icono" aria-hidden="true">‚úÖ</span>
              <span class="limpiar-texto">Registrar</span>
            </button>
          </div>
        </div>

        <input id="cliente" type="text" placeholder="Nombre del cliente (opcional)">

        <div class="resumen-panel">
          <div id="resumenOrden"><span class="muted">Sin productos seleccionados</span></div>
          <div id="total"><strong>Total: 0‚Ç°</strong></div>
          <div id="sugerenciaCambio"><strong>Cambio</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- TAB: CIERRE -->
<section id="tabCierre" class="tab-content" style="display:none;">
  <div class="panel-tercio">
    <div class="cierre-card cierre-pendientes">
      <h2>Pedidos sin pagar</h2>
      <p class="help" style="margin:0 0 12px 0;">Marca el pago recibido o env√≠a la orden a una casa.</p>
      <table id="tablaPendientesPago">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Productos</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="cierre-layout">
      <div class="cierre-left cierre-card">
        <h2>Resumen del d√≠a</h2>
        <table id="tablaResumen">
          <thead><tr><th>Resumen</th><th>Valor</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="cierre-right cierre-card">
        <h2>Conteo de caja</h2>
        <p>Ingresa el efectivo contado directamente o det√°llalo por denominaciones.</p>
        <div class="fondo-input-group">
          <input id="cierreEfectivoInput" type="text" inputmode="numeric" placeholder="‚Ç°" aria-label="Efectivo contado">
          <button type="button" class="toggle-breakdown" data-target="cierreBreakdown" aria-expanded="false">Introducir billetes y monedas</button>
        </div>
        <div id="cierreBreakdown" class="cash-breakdown" data-context="cierre">
          <table>
            <thead>
              <tr>
                <th>Denominaci√≥n</th>
                <th>Cantidad</th>
                <th>Subtotal</th>
              </tr>
            </thead>
            <tbody data-breakdown-body="cierre"></tbody>
          </table>
          <div class="cash-total">Total contado: <span data-breakdown-total="cierre">0‚Ç°</span></div>
        </div>
        <div class="cierre-datos cierre-datos-conteo">
          <table class="cierre-conteo-tabla">
            <tbody>
              <tr>
                <th>Fondo de caja</th>
                <td><strong id="cierreFondoInicial">10¬†000‚Ç°</strong></td>
              </tr>
              <tr>
                <th>Efectivo recaudado</th>
                <td><strong id="cierreEfectivoContado">0‚Ç°</strong></td>
              </tr>
              <tr>
                <th>Efectivo esperado</th>
                <td><strong id="cierreEsperado">10¬†000‚Ç°</strong></td>
              </tr>
              <tr>
                <th>Diferencia</th>
                <td><strong id="cierreDiferenciaValor">0‚Ç°</strong></td>
              </tr>
            </tbody>
          </table>
          <span>Ventas en efectivo registradas: <strong id="cierreVentasEfectivo">0‚Ç°</strong></span>
          <span class="diferencia diferencia-neutro" id="cierreDiferencia">Cuadra (0‚Ç°)</span>
        </div>
        <button class="btn-cierre-caja" onclick="cerrarCaja()">Cierre de caja</button>
      </div>
    </div>
  </div>
</section>

<!-- TAB: PRODUCTOS (editor) -->
<section id="tabProductos" class="tab-content" style="display:none;">
  <div class="productos-editor">
    <h2 style="margin:0 0 10px 0; text-align:center;">Editor de productos</h2>
    <p class="help" style="text-align:center;">Puedes a√±adir <strong>variantes</strong> separadas por comas (p. ej. ‚ÄúVariante A, Variante B, Variante C‚Äù). Toca un producto con variantes para ver el men√∫ flotante alrededor de √©l.</p>

    <div class="editor-actions">
      <button onclick="agregarFilaProducto()">A√±adir fila</button>
      <button onclick="guardarProductosDesdeTabla()">Guardar cambios</button>
      <button onclick="restablecerProductos()">Restablecer por defecto</button>
      <span class="small" id="estadoGuardado"></span>
    </div>

    <table id="tablaProductos">
      <thead>
        <tr>
          <th style="width:24%;">Nombre</th>
          <th style="width:14%;">Precio (‚Ç°)</th>
          <th style="width:14%;">Tipo</th>
          <th style="width:14%;">Icono(s)</th>
          <th style="width:30%;">Variantes (coma)</th>
          <th style="width:4%;">Borrar</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="help" style="text-align:center;">Los cambios guardados aparecen en la pesta√±a ‚ÄúPedidos‚Äù.</div>
  </div>
</section>

<!-- TAB: CASAS -->
<section id="tabCasas" class="tab-content" style="display:none;">
  <div class="casas-wrapper">
    <h2>Casas abiertas</h2>
    <p class="help">Env√≠a pedidos pendientes a cada casa o reg√≠stralos como pagados directamente desde esta vista.</p>
    <div class="casas-grid" id="casasGrid"></div>
  </div>
</section>

<!-- EmailJS -->
<div id="warningEliminarTodos" class="warning-overlay" role="alertdialog" aria-modal="true"
     aria-labelledby="warningEliminarTitulo" aria-describedby="warningEliminarDescripcion">
  <div class="warning-dialog">
    <h2 id="warningEliminarTitulo">¬°Advertencia!</h2>
    <p id="warningEliminarDescripcion">Esta acci√≥n eliminar√° <strong>todo</strong> el historial de √≥rdenes. No se podr√° recuperar la informaci√≥n.</p>
    <div class="warning-actions">
      <button class="confirm" type="button" onclick="confirmarEliminarTodos()">S√≠, eliminar todo</button>
      <button class="cancel" type="button" onclick="cancelarEliminarTodos()">Cancelar</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
<script>(function(){ emailjs.init({ publicKey: "rzMljmZB066lvsYyE" }); })();</script>

<script>
/* =================== CONFIG / ALMACEN =================== */
const STORAGE_KEYS = {
  productos: 'ignis_productos_v2', // v2 por variantes
  ordenes: 'ordenes_v2',
  apertura: 'config_apertura_caja_v1'
};

const PRECIO_COMBO = 999999; // tu valor actual
const CAMBIOS_SUGERIDOS = [1000, 2000, 5000, 10000];

const PRODUCTOS_POR_DEFECTO = [
  { nombre: 'Caf√©', precio: 500, tipo: 'bebida', icono: '‚òï', variantes: [] },
  { nombre: 'Fresco', precio: 500, tipo: 'bebida', icono: 'ü•§', variantes: [] },
  { nombre: 'Helado', precio: 700, tipo: 'bebida', icono: 'üçß', variantes: [] },
  { nombre: 'Mr Beast', precio: 600, tipo: 'bebida', icono: 'üç´', variantes: [] },
  { nombre: 'Galletas', precio: 300, tipo: 'comida', icono: 'üç™', variantes: [] },
  { nombre: 'Crepa', precio: 1000, tipo: 'comida', icono: 'ü•û', variantes: [] },
  // Empanada unificada con variantes
  { nombre: 'Empanada', precio: 700, tipo: 'comida', icono: 'ü•ü', variantes: ['Queso', 'Frijol', 'Mixta'] },
  { nombre: 'Emp. pizza', precio: 1000, tipo: 'comida', icono: 'üçï', variantes: [] },
  { nombre: 'Gallo', precio: 1000, tipo: 'comida', icono: 'üå≠', variantes: [] }
];

const DENOMINACIONES = [
  { valor: 20000, tipo: 'billete', clase: 'billete-20000' },
  { valor: 10000, tipo: 'billete', clase: 'billete-10000' },
  { valor: 5000, tipo: 'billete', clase: 'billete-5000' },
  { valor: 2000, tipo: 'billete', clase: 'billete-2000' },
  { valor: 1000, tipo: 'billete', clase: 'billete-1000' },
  { valor: 500, tipo: 'moneda', clase: '' },
  { valor: 100, tipo: 'moneda', clase: '' },
  { valor: 50, tipo: 'moneda', clase: '' },
  { valor: 25, tipo: 'moneda', clase: '' },
  { valor: 10, tipo: 'moneda', clase: '' }
];

let configApertura = cargarConfigApertura();
let ultimoResumen = { efectivo: 0, sinpe: 0, total: 0 };

function cargarConfigApertura() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.apertura);
    if (!raw) return { fondo: 10000 };
    const data = JSON.parse(raw);
    const fondo = Number.parseInt(data?.fondo, 10);
    return {
      fondo: Number.isFinite(fondo) && fondo >= 0 ? fondo : 10000
    };
  } catch {
    return { fondo: 10000 };
  }
}
function guardarConfigApertura() {
  localStorage.setItem(STORAGE_KEYS.apertura, JSON.stringify({
    fondo: configApertura.fondo
  }));
}
function parseColones(valor) {
  if (valor === null || valor === undefined) return 0;
  const limpio = String(valor).replace(/[^\d]/g, '');
  return limpio ? Number.parseInt(limpio, 10) : 0;
}
function obtenerFondoInicial() {
  return Number.isFinite(configApertura?.fondo) ? Number(configApertura.fondo) : 0;
}
function etiquetaDenominacion(den) {
  const prefijo = den.tipo === 'billete' ? 'Billete' : 'Moneda';
  return `${prefijo} ‚Ç°${formatearColones(den.valor)}`;
}
function aplicarConfigApertura() {
  const fondoInput = document.getElementById('fondoCajaInput');
  if (fondoInput) fondoInput.value = obtenerFondoInicial().toString();
}
function actualizarResumenApertura() {
  const fondo = obtenerFondoInicial();
  const fondoSpan = document.getElementById('aperturaFondoActual');
  if (fondoSpan) fondoSpan.textContent = `${formatearColones(fondo)}‚Ç°`;
  actualizarPanelCierre();
}
function inicializarBreakdown(contexto) {
  const tbody = document.querySelector(`tbody[data-breakdown-body="${contexto}"]`);
  if (!tbody) return;
  tbody.innerHTML = '';
  DENOMINACIONES.forEach(den => {
    const tr = document.createElement('tr');
    const claseExtra = den.clase ? ` ${den.clase}` : '';
    tr.innerHTML = `
      <td class="den-label${claseExtra}">${etiquetaDenominacion(den)}</td>
      <td><input type="number" min="0" step="1" class="cash-count" data-context="${contexto}" data-valor="${den.valor}"></td>
      <td class="cash-subtotal">0‚Ç°</td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll(`.cash-count[data-context="${contexto}"]`).forEach(input => {
    input.addEventListener('input', () => actualizarBreakdown(contexto));
  });
}
function limpiarBreakdown(contexto) {
  const inputs = document.querySelectorAll(`.cash-count[data-context="${contexto}"]`);
  const cero = `${formatearColones(0)}‚Ç°`;
  inputs.forEach(input => {
    input.value = '';
    const celda = input.closest('tr')?.querySelector('.cash-subtotal');
    if (celda) celda.textContent = cero;
  });
  const totalSpan = document.querySelector(`[data-breakdown-total="${contexto}"]`);
  if (totalSpan) totalSpan.textContent = cero;
}
function actualizarBreakdown(contexto) {
  const inputs = Array.from(document.querySelectorAll(`.cash-count[data-context="${contexto}"]`));
  if (inputs.length === 0) return;
  let total = 0;
  let hayValores = false;
  inputs.forEach(input => {
    const cantidadStr = (input.value || '').trim();
    const cantidad = Number.parseInt(cantidadStr, 10);
    if (cantidadStr !== '') hayValores = true;
    const valor = Number(input.dataset.valor || 0);
    const subtotal = Number.isFinite(cantidad) && cantidad > 0 ? cantidad * valor : 0;
    total += subtotal;
    const celda = input.closest('tr')?.querySelector('.cash-subtotal');
    if (celda) celda.textContent = `${formatearColones(subtotal)}‚Ç°`;
  });
  const totalSpan = document.querySelector(`[data-breakdown-total="${contexto}"]`);
  if (totalSpan) totalSpan.textContent = `${formatearColones(total)}‚Ç°`;
  if (!hayValores) {
    if (contexto === 'apertura') {
      actualizarResumenApertura();
    } else {
      actualizarPanelCierre();
    }
    return;
  }
  const targetInputId = contexto === 'apertura' ? 'fondoCajaInput' : 'cierreEfectivoInput';
  const targetInput = document.getElementById(targetInputId);
  if (targetInput) targetInput.value = total.toString();
  if (contexto === 'apertura') {
    configApertura.fondo = total;
    guardarConfigApertura();
    actualizarResumenApertura();
  } else {
    actualizarPanelCierre();
  }
}
function toggleBreakdownById(id, boton) {
  const panel = document.getElementById(id);
  if (!panel) return;
  const activo = !panel.classList.contains('open');
  panel.classList.toggle('open', activo);
  if (boton) boton.setAttribute('aria-expanded', activo ? 'true' : 'false');
  if (activo) {
    const primerInput = panel.querySelector('input.cash-count');
    if (primerInput) primerInput.focus();
  }
}
function actualizarPanelCierre() {
  const fondo = obtenerFondoInicial();
  const ventasEfectivo = Number(ultimoResumen.efectivo || 0);
  const cierreInput = document.getElementById('cierreEfectivoInput');
  const contado = cierreInput ? parseColones(cierreInput.value) : 0;
  const esperado = fondo + ventasEfectivo;
  const diferencia = contado - esperado;

  const fondoSpan = document.getElementById('cierreFondoInicial');
  if (fondoSpan) fondoSpan.textContent = `${formatearColones(fondo)}‚Ç°`;
  const esperadoSpan = document.getElementById('cierreEsperado');
  if (esperadoSpan) esperadoSpan.textContent = `${formatearColones(esperado)}‚Ç°`;
  const contadoSpan = document.getElementById('cierreEfectivoContado');
  if (contadoSpan) contadoSpan.textContent = `${formatearColones(contado)}‚Ç°`;
  const ventasSpan = document.getElementById('cierreVentasEfectivo');
  if (ventasSpan) ventasSpan.textContent = `${formatearColones(ventasEfectivo)}‚Ç°`;
  const diferenciaValorSpan = document.getElementById('cierreDiferenciaValor');
  if (diferenciaValorSpan) diferenciaValorSpan.textContent = `${formatearColones(diferencia)}‚Ç°`;

  const diffSpan = document.getElementById('cierreDiferencia');
  if (diffSpan) {
    diffSpan.classList.remove('diferencia-positivo', 'diferencia-negativo', 'diferencia-neutro');
    if (diferencia === 0) {
      diffSpan.textContent = 'Cuadra (0‚Ç°)';
      diffSpan.classList.add('diferencia-neutro');
    } else if (diferencia > 0) {
      diffSpan.textContent = `Sobra ${formatearColones(diferencia)}‚Ç°`;
      diffSpan.classList.add('diferencia-positivo');
    } else {
      diffSpan.textContent = `Faltan ${formatearColones(Math.abs(diferencia))}‚Ç°`;
      diffSpan.classList.add('diferencia-negativo');
    }
  }
}

function cargarProductos() {
  try {
    const raw = localStorage.getItem(STORAGE_KEYS.productos);
    if (!raw) return PRODUCTOS_POR_DEFECTO.slice();
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr) || arr.length === 0) return PRODUCTOS_POR_DEFECTO.slice();
    return arr.map(p => ({
      nombre: String(p.nombre ?? '').trim() || 'Sin nombre',
      precio: Number(p.precio ?? 0) || 0,
      tipo: (p.tipo === 'bebida' || p.tipo === 'comida') ? p.tipo : 'comida',
      icono: String(p.icono ?? ''),
      variantes: Array.isArray(p.variantes)
        ? p.variantes.map(v => String(v).trim()).filter(Boolean)
        : String(p.variantes || '').split(',').map(v => v.trim()).filter(Boolean)
    }));
  } catch { return PRODUCTOS_POR_DEFECTO.slice(); }
}
function guardarProductos(arr) {
  localStorage.setItem(STORAGE_KEYS.productos, JSON.stringify(arr));
}

/* =================== TABS =================== */
const TAB_INFOS = [
  { name: 'apertura', contentId: 'tabApertura', buttonId: 'tabAperturaBtn', onShow: () => actualizarResumenApertura() },
  { name: 'productos', contentId: 'tabProductos', buttonId: 'tabProductosBtn', onShow: () => renderEditorProductos() },
  {
    name: 'pedidos',
    contentId: 'tabPedidos',
    buttonId: 'tabPedidosBtn',
    onShow: () => {
      crearProductos();
      actualizarResumen();
      actualizarTabla();
    }
  },
  {
    name: 'cierre',
    contentId: 'tabCierre',
    buttonId: 'tabCierreBtn',
    onShow: () => {
      actualizarPanelCierre();
      renderPendientesPago();
    }
  },
  { name: 'casas', contentId: 'tabCasas', buttonId: 'tabCasasBtn', onShow: () => renderCasas() }
];
function mostrarTab(nombre) {
  const objetivo = nombre || 'apertura';
  document.body.dataset.activeTab = objetivo;
  TAB_INFOS.forEach(tab => {
    const activo = tab.name === objetivo;
    const contenido = document.getElementById(tab.contentId);
    if (contenido) contenido.style.display = activo ? '' : 'none';
    const boton = document.getElementById(tab.buttonId);
    if (boton) boton.classList.toggle('active', activo);
    if (activo && typeof tab.onShow === 'function') tab.onShow();
    if (!activo && tab.name === 'pedidos') ocultarPanelVariantes();
  });
}

/* =================== EDITOR DE PRODUCTOS =================== */
function renderEditorProductos() {
  const tbody = document.querySelector('#tablaProductos tbody');
  tbody.innerHTML = '';
  const datos = cargarProductos();
  datos.forEach(p => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="nombre-input" type="text" value="${html(p.nombre)}" placeholder="Nombre"></td>
      <td><input class="number" type="number" min="0" step="1" value="${Number(p.precio)}"></td>
      <td>
        <select class="tipo-select">
          <option value="bebida" ${p.tipo === 'bebida' ? 'selected' : ''}>bebida</option>
          <option value="comida" ${p.tipo === 'comida' ? 'selected' : ''}>comida</option>
        </select>
      </td>
      <td><input class="icono-input" type="text" value="${html(p.icono)}" placeholder="‚òï"></td>
      <td><input class="variantes-input" type="text" value="${html(p.variantes.join(', '))}" placeholder="Variante A, Variante B, Variante C"></td>
      <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
    `;
    tbody.appendChild(tr);
  });
  setEstadoGuardado('');
}
function agregarFilaProducto() {
  const tbody = document.querySelector('#tablaProductos tbody');
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input class="nombre-input" type="text" value="" placeholder="Nombre"></td>
    <td><input class="number" type="number" min="0" step="1" value="0"></td>
    <td>
      <select class="tipo-select">
        <option value="bebida">bebida</option>
        <option value="comida" selected>comida</option>
      </select>
    </td>
    <td><input class="icono-input" type="text" value="" placeholder="üç™"></td>
    <td><input class="variantes-input" type="text" value="" placeholder="Variante A, Variante B"></td>
    <td style="text-align:center;"><button onclick="borrarFilaProducto(this)">üóëÔ∏è</button></td>
  `;
  tbody.appendChild(tr);
}
function borrarFilaProducto(btn) { btn.closest('tr')?.remove(); }

function guardarProductosDesdeTabla() {
  const rows = Array.from(document.querySelectorAll('#tablaProductos tbody tr'));
  const nuevos = [];
  const nombres = new Set();
  for (const r of rows) {
    const nombre = (r.querySelector('.nombre-input')?.value || '').trim();
    const precio = Number(r.querySelector('.number')?.value || 0);
    const tipo = r.querySelector('.tipo-select')?.value === 'bebida' ? 'bebida' : 'comida';
    const icono = (r.querySelector('.icono-input')?.value || '').trim();
    const variantesStr = (r.querySelector('.variantes-input')?.value || '').trim();
    const variantes = variantesStr ? variantesStr.split(',').map(v => v.trim()).filter(Boolean) : [];

    if (!nombre) continue;
    if (nombres.has(nombre)) { alert(`Nombre duplicado: "${nombre}". Cambia alguno antes de guardar.`); return; }
    nombres.add(nombre);

    nuevos.push({ nombre, precio: Math.max(0, Math.floor(precio)), tipo, icono, variantes });
  }
  guardarProductos(nuevos);
  setEstadoGuardado('Cambios guardados.');
}
function restablecerProductos() {
  if (!confirm('¬øRestablecer el listado por defecto?')) return;
  guardarProductos(PRODUCTOS_POR_DEFECTO.slice());
  renderEditorProductos();
  setEstadoGuardado('Restablecido a valores por defecto.');
}
function setEstadoGuardado(txt) { document.getElementById('estadoGuardado').textContent = txt || ''; }
function html(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function jsEsc(s){
  return String(s).replace(/[\\'"\n\r]/g, c => ({
    '\\': '\\\\',
    "'": "\\'",
    '"': '\\"',
    '\n': '\\n',
    '\r': '\\r'
  }[c] || c));
}
function fechaTextoToMs(texto) {
  const ms = new Date(texto).getTime();
  return Number.isFinite(ms) ? ms : Date.now();
}
function formatearColones(valor) {
  const numero = Number(valor || 0);
  return Number.isFinite(numero) ? numero.toLocaleString('es-CR') : '0';
}

/* =================== PEDIDOS: selecci√≥n con variantes =================== */
let productosNodos = [];              // nodos de la grilla
let seleccionActual = {};             // { [producto]: { total:number, variantes: { [var]: number } } }
let pendientesData = { porCliente: [], porProducto: [] };

function crearProductos() {
  const grid = document.getElementById('productosGrid');
  grid.innerHTML = '';
  const PRODS = cargarProductos();

  PRODS.forEach((prod) => {
    const div = document.createElement('div');
    div.className = 'producto';
    div.dataset.nombre = prod.nombre;
    div.dataset.precio = prod.precio;
    div.dataset.tipo = prod.tipo;
    div.dataset.variantes = JSON.stringify(prod.variantes || []);
    div.innerHTML = `<span class="icono">${html(prod.icono)}</span><span>${html(prod.nombre)} (${prod.precio})</span><span class="contador"></span><span class="restar">-</span>`;
    grid.appendChild(div);
  });

  productosNodos = Array.from(document.querySelectorAll('.producto'));
  productosNodos.forEach(p => configurarHandlersProducto(p));

  if (overlayVariantes && !overlayVariantes.hidden && productoVariantesActivo) {
    const prodActual = PRODS.find(prod => prod.nombre === productoVariantesActivo);
    if (prodActual && Array.isArray(prodActual.variantes) && prodActual.variantes.length) {
      mostrarPanelVariantes(productoVariantesActivo, prodActual.variantes);
    } else {
      ocultarPanelVariantes();
    }
  } else if (productoVariantesActivo) {
    marcarProductoActivo(productoVariantesActivo);
  }
}

function configurarHandlersProducto(p) {
  const nombre = p.dataset.nombre;
  const contador = p.querySelector('.contador');
  const restar = p.querySelector('.restar');

  const obtenerVariantes = () => {
    try {
      const parsed = JSON.parse(p.dataset.variantes || '[]');
      return Array.isArray(parsed)
        ? parsed.map(v => String(v).trim()).filter(Boolean)
        : [];
    } catch {
      return [];
    }
  };

  p.addEventListener('click', (e) => {
    if (e.target instanceof Element && e.target.closest('.restar')) return;
    const variantes = obtenerVariantes();
    if (variantes.length) {
      if (productoVariantesActivo === nombre && overlayVariantes && !overlayVariantes.hidden) {
        ocultarPanelVariantes();
        return;
      }
      mostrarPanelVariantes(nombre, variantes);
    } else {
      ocultarPanelVariantes();
      incProducto(nombre, null);
    }
  });

  if (restar) {
    restar.addEventListener('click', (e) => {
      e.stopPropagation();
      decProducto(nombre);
    });
  }

  // render contador por si hay selecci√≥n previa
  renderContador(nombre, contador, restar);
}

function incProducto(nombre, variante) {
  if (!seleccionActual[nombre]) seleccionActual[nombre] = { total:0, variantes:{} };
  seleccionActual[nombre].total += 1;
  if (variante) {
    seleccionActual[nombre].variantes[variante] = (seleccionActual[nombre].variantes[variante] || 0) + 1;
  }
  renderContadorNombre(nombre);
  actualizarResumen();
}
function decProducto(nombre) {
  const obj = seleccionActual[nombre];
  if (!obj || obj.total <= 0) return;
  const totalVariantes = Object.values(obj.variantes).reduce((a,b)=>a+b,0);
  const sinEspecificar = obj.total - totalVariantes;
  if (sinEspecificar > 0) {
    obj.total -= 1;
  } else {
    const vNames = Object.keys(obj.variantes).filter(v => obj.variantes[v] > 0);
    if (vNames.length) {
      const v = vNames[vNames.length-1];
      obj.variantes[v] -= 1;
      obj.total -= 1;
      if (obj.variantes[v] === 0) delete obj.variantes[v];
    } else {
      obj.total -= 1;
    }
  }
  if (obj.total <= 0) delete seleccionActual[nombre];
  renderContadorNombre(nombre);
  actualizarResumen();
}
function renderContadorNombre(nombre) {
  const p = productosNodos.find(n=>n.dataset.nombre===nombre);
  if (!p) return;
  renderContador(nombre, p.querySelector('.contador'), p.querySelector('.restar'));
}
function renderContador(nombre, contador, restar) {
  const total = seleccionActual[nombre]?.total || 0;
  contador.textContent = total ? String(total) : '';
  contador.style.display = total ? 'inline-block' : 'none';
  restar.style.display = total ? 'inline-block' : 'none';
}

/* Men√∫ flotante de variantes */
const overlayVariantes = document.getElementById('variantesOverlay');
const gridWrapper = document.querySelector('.productos-grid-wrapper');
let productoVariantesActivo = null;

function marcarProductoActivo(nombre) {
  productosNodos.forEach(nodo => {
    const coincide = nombre && nodo.dataset.nombre === nombre;
    nodo.classList.toggle('activo', Boolean(coincide));
  });
}

function ocultarPanelVariantes() {
  if (!overlayVariantes) return;
  overlayVariantes.classList.remove('visible');
  overlayVariantes.innerHTML = '';
  overlayVariantes.hidden = true;
  productoVariantesActivo = null;
  marcarProductoActivo(null);
}

function mostrarPanelVariantes(nombre, variantes) {
  if (!overlayVariantes || !gridWrapper) {
    incProducto(nombre, null);
    return;
  }
  const lista = Array.isArray(variantes)
    ? variantes.map(v => String(v).trim()).filter(Boolean)
    : [];
  if (!lista.length) {
    ocultarPanelVariantes();
    incProducto(nombre, null);
    return;
  }

  const nodoProducto = productosNodos.find(nodo => nodo.dataset.nombre === nombre);
  if (!nodoProducto) {
    incProducto(nombre, null);
    return;
  }

  const wrapperRect = gridWrapper.getBoundingClientRect();
  const rect = nodoProducto.getBoundingClientRect();
  const centroX = rect.left - wrapperRect.left + rect.width / 2;
  const centroY = rect.top - wrapperRect.top + rect.height * 0.65;

  productoVariantesActivo = nombre;
  overlayVariantes.classList.remove('visible');
  overlayVariantes.innerHTML = '';
  overlayVariantes.style.left = `${centroX}px`;
  overlayVariantes.style.top = `${centroY}px`;
  overlayVariantes.hidden = false;

  const contenedorVariantes = document.createElement('div');
  contenedorVariantes.className = 'variantes-lista';

  lista.forEach((variante) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'variante-bubble';
    btn.textContent = variante;
    btn.addEventListener('click', (event) => {
      event.stopPropagation();
      incProducto(nombre, variante);
      ocultarPanelVariantes();
    });
    contenedorVariantes.appendChild(btn);
  });

  overlayVariantes.appendChild(contenedorVariantes);

  requestAnimationFrame(() => overlayVariantes.classList.add('visible'));

  marcarProductoActivo(nombre);
}

document.addEventListener('click', (event) => {
  if (!overlayVariantes || overlayVariantes.hidden) return;
  const target = event.target;
  if (!(target instanceof Element)) return;
  if (target.closest('.variantes-lista')) return;
  if (target.closest('.producto')) return;
  ocultarPanelVariantes();
});

/* Resumen de pedido (incluye variantes) */
function actualizarResumen() {
  const PRODS = cargarProductos();
  let resumen = document.getElementById('resumenOrden');
  let totalNodo = document.getElementById('total');
  let sugerenciaCambio = document.getElementById('sugerenciaCambio');
  let total = 0;

  // Mapa de cantidades por producto base para combos y precio
  const mapaBase = {};
  Object.keys(seleccionActual).forEach(nombre => mapaBase[nombre] = (mapaBase[nombre] || 0) + (seleccionActual[nombre].total || 0));

  const calc = calcularTotalDesdeMapa(mapaBase, PRODS);
  const lineasResumen = [];
  for (let combo in calc.comboCantidades) {
    lineasResumen.push(`${calc.comboCantidades[combo]} Combo - ${formatearColones(calc.comboCantidades[combo] * PRECIO_COMBO)}‚Ç°<br>`);
    lineasResumen.push(`<div class='indentado'>- ${html(combo)}</div>`);
  }

  for (let p in calc.individuales) {
    const cantidadIndiv = calc.individuales[p];
    if ((cantidadIndiv || 0) > 0) {
      const precioUnitario = (PRODS.find(x=>x.nombre===p)||{}).precio || 0;
      const precio = cantidadIndiv * precioUnitario;
      lineasResumen.push(`${cantidadIndiv} ${html(p)} - ${formatearColones(precio)}‚Ç°<br>`);
      const varsObj = (seleccionActual[p]?.variantes)||{};
      const nombresVar = Object.keys(varsObj);
      if (nombresVar.length) {
        const detalle = nombresVar.map(v=>`${html(v)}: ${varsObj[v]}`).join(' ¬∑ ');
        lineasResumen.push(`<div class="indentado">${detalle}</div>`);
      }
    }
  }

  total = calc.total;
  resumen.innerHTML = lineasResumen.length ? lineasResumen.join('') : '<span class="muted">Sin productos seleccionados</span>';
  totalNodo.innerHTML = `<strong>Total: ${formatearColones(total)}‚Ç°</strong>`;

  if (total <= 0) {
    sugerenciaCambio.innerHTML = '<strong>Cambio</strong><br><span class="muted">A√±ade productos para ver sugerencias.</span>';
  } else {
    const opciones = CAMBIOS_SUGERIDOS.filter(monto => monto >= total);
    if (!opciones.length) {
      sugerenciaCambio.innerHTML = '<strong>Cambio</strong><br><span class="muted">Sin opciones disponibles.</span>';
    } else {
      const items = opciones.map(monto => {
        const cambio = monto - total;
        return `<li>${formatearColones(monto)}‚Ç° ‚Üí ${formatearColones(cambio)}‚Ç°</li>`;
      }).join('');
      sugerenciaCambio.innerHTML = `<strong>Cambio</strong><ul>${items}</ul>`;
    }
  }
}

/* Tabla de historial y resumen global (acumula variantes) */
function cargarTabla() {
  try {
    const raw = JSON.parse(localStorage.getItem(STORAGE_KEYS.ordenes) || '[]');
    if (!Array.isArray(raw)) return [];
    return raw.map(normalizarOrden).filter(Boolean);
  } catch {
    return [];
  }
}
function guardarTabla(data) { localStorage.setItem(STORAGE_KEYS.ordenes, JSON.stringify(data)); }

function clonarMapaProductos(mapa) {
  const copia = {};
  Object.keys(mapa || {}).forEach(nombre => {
    const cantidad = Number(mapa[nombre]) || 0;
    if (cantidad > 0) copia[nombre] = cantidad;
  });
  return copia;
}

function clonarVariantesMapa(vars) {
  const copia = {};
  Object.keys(vars || {}).forEach(base => {
    const variantesBase = vars[base] || {};
    const variantesLimpias = {};
    Object.keys(variantesBase).forEach(nombreVar => {
      const cantidad = Number(variantesBase[nombreVar]) || 0;
      if (cantidad > 0) variantesLimpias[nombreVar] = cantidad;
    });
    if (Object.keys(variantesLimpias).length) copia[base] = variantesLimpias;
  });
  return copia;
}

function normalizarNumeroCasa(valor) {
  const num = Number.parseInt(valor, 10);
  return Number.isInteger(num) && num >= 1 && num <= 6 ? num : null;
}

function esOrdenPagada(orden) {
  return orden?.estado === ESTADOS_ORDEN.PAGADO;
}

function esOrdenEnCasa(orden) {
  return orden?.estado === ESTADOS_ORDEN.CASA;
}

function esOrdenPendientePago(orden) {
  return orden?.estado === ESTADOS_ORDEN.PENDIENTE;
}

const ESTADOS_ORDEN = {
  PENDIENTE: 'pendiente_pago',
  PAGADO: 'pagado',
  CASA: 'casa'
};

function crearOrdenRegistro({ cliente = '', productos = {}, variantes = {}, metodo = null, estado = ESTADOS_ORDEN.PENDIENTE, casa = null, entregasServidas = false }) {
  const productosCopia = clonarMapaProductos(productos);
  const variantesCopia = clonarVariantesMapa(variantes);
  const PRODS = cargarProductos();
  const entregas = {};
  Object.keys(productosCopia).forEach(nombre => {
    const cantidad = Number(productosCopia[nombre]) || 0;
    entregas[nombre] = Array.from({ length: cantidad }, () => !!entregasServidas);
  });

  const estadoNormalizado = Object.values(ESTADOS_ORDEN).includes(estado) ? estado : ESTADOS_ORDEN.PENDIENTE;
  const metodoNormalizado = estadoNormalizado === ESTADOS_ORDEN.PAGADO && (metodo === 'sinpe' || metodo === 'efectivo')
    ? metodo
    : null;
  const casaNormalizada = estadoNormalizado === ESTADOS_ORDEN.CASA
    ? normalizarNumeroCasa(casa)
    : null;

  return {
    fecha: new Date().toLocaleString(),
    cliente,
    cantidad: calcularTotalDesdeMapa(productosCopia, PRODS).total,
    metodo: metodoNormalizado,
    productos: productosCopia,
    variantes: variantesCopia,
    entregas,
    estado: estadoNormalizado,
    casa: casaNormalizada,
    pagoFecha: estadoNormalizado === ESTADOS_ORDEN.PAGADO ? new Date().toISOString() : null
  };
}

function normalizarOrden(raw) {
  if (!raw || typeof raw !== 'object') return null;

  const copia = {
    fecha: raw.fecha || new Date().toLocaleString(),
    cliente: raw.cliente || '',
    cantidad: Number(raw.cantidad) || 0,
    productos: raw.productos && typeof raw.productos === 'object' ? { ...raw.productos } : {},
    variantes: raw.variantes && typeof raw.variantes === 'object' ? JSON.parse(JSON.stringify(raw.variantes)) : {},
    entregas: raw.entregas && typeof raw.entregas === 'object' ? { ...raw.entregas } : {}
  };

  let estado = raw.estado;
  if (estado === 'cuenta_abierta') estado = ESTADOS_ORDEN.CASA;
  if (!estado) {
    if (raw.metodo === 'Cuenta abierta') estado = ESTADOS_ORDEN.CASA;
    else if (raw.metodo === 'sinpe' || raw.metodo === 'efectivo') estado = ESTADOS_ORDEN.PAGADO;
    else estado = ESTADOS_ORDEN.PENDIENTE;
  }
  if (!Object.values(ESTADOS_ORDEN).includes(estado)) estado = ESTADOS_ORDEN.PENDIENTE;

  let metodo = null;
  if (estado === ESTADOS_ORDEN.PAGADO) {
    metodo = raw.metodo === 'sinpe' ? 'sinpe' : 'efectivo';
  }

  const casa = estado === ESTADOS_ORDEN.CASA
    ? (normalizarNumeroCasa(raw.casa) || normalizarNumeroCasa(raw.cuenta) || normalizarNumeroCasa(detectarCasaDesdeNombre(raw.cliente)))
    : null;

  let pagoFecha = null;
  if (estado === ESTADOS_ORDEN.PAGADO) {
    pagoFecha = raw.pagoFecha && !Number.isNaN(Date.parse(raw.pagoFecha))
      ? raw.pagoFecha
      : new Date().toISOString();
  }

  return {
    ...copia,
    metodo,
    estado,
    casa,
    pagoFecha
  };
}

function construirLineasPorProducto(o) {
  const PRODS = cargarProductos();
  const lineas = [];
  for (let nombre in o.productos) {
    const prod = PRODS.find(p => p.nombre === nombre);
    const cant = Number(o.productos[nombre]) || 0;
    const icono = prod?.icono || '';
    const iconos = icono ? `${icono}√ó${cant}` : `${cant}x`;
    const vars = (o.variantes && o.variantes[nombre]) ? o.variantes[nombre] : null;
    const unidades = [];
    if (vars && typeof vars === 'object') {
      Object.keys(vars).forEach(varNombre => {
        const cantVar = Number(vars[varNombre]) || 0;
        for (let i = 0; i < cantVar; i++) unidades.push({ variante: varNombre });
      });
    }
    if (unidades.length < cant) {
      const restantes = cant - unidades.length;
      for (let i = 0; i < restantes; i++) unidades.push({ variante: null });
    } else if (unidades.length > cant) {
      unidades.length = cant;
    }
    lineas.push({ nombre, cantidad: cant, iconos, variantes: vars, tieneIcono: !!icono, unidades });
  }
  lineas.sort((a,b) => a.nombre.localeCompare(b.nombre));
  return lineas;
}

function normalizarEntregasLinea(orden, nombreProducto, cantidad) {
  if (!orden.entregas) orden.entregas = {};
  const cantidadFinal = Math.max(0, Number(cantidad) || 0);
  const existente = orden.entregas[nombreProducto];
  let arreglo;
  if (Array.isArray(existente)) {
    arreglo = existente.slice(0, cantidadFinal);
    if (arreglo.length < cantidadFinal) {
      arreglo = arreglo.concat(Array.from({ length: cantidadFinal - arreglo.length }, () => false));
    }
  } else if (typeof existente === 'boolean') {
    arreglo = Array.from({ length: cantidadFinal }, () => existente);
  } else {
    arreglo = Array.from({ length: cantidadFinal }, () => false);
  }
  orden.entregas[nombreProducto] = arreglo;
  return arreglo;
}
function toggleEntregaUnidad(fecha, nombreProducto, indice) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  const orden = ordenes[i];
  const cantidad = orden?.productos?.[nombreProducto] || 0;
  const entregasLinea = normalizarEntregasLinea(orden, nombreProducto, cantidad);
  const idxUnidad = Number(indice);
  if (!Number.isInteger(idxUnidad) || idxUnidad < 0 || idxUnidad >= entregasLinea.length) return;
  entregasLinea[idxUnidad] = !entregasLinea[idxUnidad];
  orden.entregas[nombreProducto] = entregasLinea;
  guardarTabla(ordenes);
  actualizarTabla();
}
function toggleEntregaLineaCompleta(fecha, nombreProducto) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  const orden = ordenes[i];
  const cantidad = orden?.productos?.[nombreProducto] || 0;
  const entregasLinea = normalizarEntregasLinea(orden, nombreProducto, cantidad);
  const todoServido = entregasLinea.length > 0 && entregasLinea.every(Boolean);
  const target = !todoServido;
  for (let idx = 0; idx < entregasLinea.length; idx++) {
    entregasLinea[idx] = target;
  }
  orden.entregas[nombreProducto] = entregasLinea;
  guardarTabla(ordenes);
  actualizarTabla();
}
function toggleEntregaMaestro(fecha) {
  let ordenes = cargarTabla();
  const i = ordenes.findIndex(x => x.fecha === fecha);
  if (i === -1) return;
  const o = ordenes[i];
  const lineas = construirLineasPorProducto(o);
  if (!o.entregas) o.entregas = {};
  const allServed = lineas.length > 0 && lineas.every(l => {
    const entregasLinea = normalizarEntregasLinea(o, l.nombre, l.cantidad);
    return entregasLinea.length > 0 && entregasLinea.every(Boolean);
  });
  const target = !allServed;
  lineas.forEach(l => {
    const entregasLinea = normalizarEntregasLinea(o, l.nombre, l.cantidad);
    for (let idx = 0; idx < entregasLinea.length; idx++) {
      entregasLinea[idx] = target;
    }
    o.entregas[l.nombre] = entregasLinea;
  });
  guardarTabla(ordenes);
  actualizarTabla();
}

function marcarPendienteComoServido(fecha, nombreProducto, indiceUnidad = null) {
  if (!fecha || !nombreProducto) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  const cantidad = orden?.productos?.[nombreProducto] || 0;
  const entregasLinea = normalizarEntregasLinea(orden, nombreProducto, cantidad);
  if (!Array.isArray(entregasLinea) || !entregasLinea.length) return;

  let objetivo = null;
  if (Number.isInteger(indiceUnidad) && indiceUnidad >= 0 && indiceUnidad < entregasLinea.length) {
    objetivo = indiceUnidad;
  } else {
    objetivo = entregasLinea.findIndex(v => !v);
  }

  if (objetivo === -1 || objetivo === null) return;
  entregasLinea[objetivo] = true;
  orden.entregas[nombreProducto] = entregasLinea;
  guardarTabla(ordenes);
  actualizarTabla();
}

function actualizarTabla() {
  const PRODS = cargarProductos();
  const prodMap = new Map(PRODS.map(p => [p.nombre, p]));
  let ordenes = cargarTabla();
  let tbody = document.querySelector('#tabla tbody');
  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  const pendientesCliente = new Map();
  const pendientesProducto = new Map();
  const registrarPendienteProducto = (productoNombre, varianteNombre, indiceUnidad, icono, clienteNombre, fechaTexto, fechaValor) => {
    const clave = `${productoNombre}__${varianteNombre || ''}`;
    const valorFecha = Number.isFinite(fechaValor) ? fechaValor : fechaTextoToMs(fechaTexto);
    if (!pendientesProducto.has(clave)) {
      pendientesProducto.set(clave, {
        nombre: productoNombre,
        icono,
        total: 0,
        unidades: [],
        variante: varianteNombre || null,
        primeraFecha: valorFecha
      });
    }
    const prodPendiente = pendientesProducto.get(clave);
    prodPendiente.total += 1;
    prodPendiente.primeraFecha = Math.min(prodPendiente.primeraFecha, valorFecha);
    prodPendiente.unidades.push({
      cliente: clienteNombre,
      fecha: fechaTexto,
      fechaValor: valorFecha,
      pedidoFecha: fechaTexto,
      producto: productoNombre,
      variante: varianteNombre || null,
      indice: indiceUnidad
    });
  };

  tbody.innerHTML = '';

  ordenes.sort((a, b) => new Date(b.fecha) - new Date(a.fecha)).forEach(o => {
    const lineas = construirLineasPorProducto(o);
    o.entregas = o.entregas || {};
    const entregasPorLinea = new Map();
    lineas.forEach(l => {
      entregasPorLinea.set(l.nombre, normalizarEntregasLinea(o, l.nombre, l.cantidad));
    });

    const esPagada = esOrdenPagada(o);
    const enCasa = esOrdenEnCasa(o);

    const allServed = lineas.length > 0 && lineas.every(l => {
      const entregasLinea = entregasPorLinea.get(l.nombre) || [];
      return entregasLinea.length > 0 && entregasLinea.every(Boolean);
    });
    const masterChecked = allServed ? 'checked' : '';
    let productosHTML = `
      <div class="productos-maestro">
        <input type="checkbox" class="master-checkbox" ${masterChecked}
              title="Marcar todo el pedido"
              aria-label="Marcar todo el pedido"
              onclick="toggleEntregaMaestro('${jsEsc(o.fecha)}')">
      </div>
    `;
    if (lineas.length >= 1) {
      lineas.forEach(l => {
        const entregasLinea = entregasPorLinea.get(l.nombre) || [];
        const unidadesServidas = entregasLinea.filter(Boolean).length;
        const lineaServida = entregasLinea.length > 0 && unidadesServidas === entregasLinea.length;
        const prodInfo = prodMap.get(l.nombre);
        const iconoProd = prodInfo?.icono || '';
        const unidadesMarkup = l.unidades.map((unidad, idx) => {
          const servida = !!entregasLinea[idx];
          const clases = ['entrega-unidad', iconoProd ? 'con-icono' : 'sin-icono'];
          if (servida) clases.push('servida');
          const contenido = iconoProd
            ? `<span class="unidad-icono">${html(iconoProd)}</span>`
            : `<span class="unidad-icono">${idx + 1}</span>`;
          const varianteTexto = unidad?.variante
            ? `<span class="unidad-variante">${html(unidad.variante)}</span>`
            : '';
          const tituloPartes = [l.nombre, `Unidad ${idx + 1}`];
          if (unidad?.variante) tituloPartes.push(unidad.variante);
          const titulo = html(tituloPartes.join(' ¬∑ '));
          return `<button type="button" class="${clases.join(' ')}" title="${titulo}" onclick="toggleEntregaUnidad('${jsEsc(o.fecha)}','${jsEsc(l.nombre)}',${idx})">${contenido}${varianteTexto}</button>`;
        }).join('');
        const lineaLabel = lineaServida ? 'Todo servido' : `Servidas ${unidadesServidas}/${l.cantidad}`;
        const variantesTooltip = l.variantes && Object.keys(l.variantes).length
          ? Object.keys(l.variantes).map(v => `${v}: ${l.variantes[v]}`).join(' ¬∑ ')
          : '';
        const lineaDescripcion = variantesTooltip ? `${l.nombre} (${variantesTooltip})` : l.nombre;
        const lineaTooltip = `${lineaDescripcion} ¬∑ ${lineaLabel}`;
        productosHTML += `
          <div class="productos-linea" title="${html(lineaTooltip)}">
            <div class="entrega-unidades">${unidadesMarkup}</div>
          </div>
        `;

        const pendientesIndices = [];
        for (let idx = 0; idx < entregasLinea.length; idx++) {
          if (!entregasLinea[idx]) pendientesIndices.push(idx);
        }
        if (pendientesIndices.length > 0) {
          const clienteNombre = (o.cliente || '').trim() || 'Sin nombre';
          const fechaTexto = o.fecha;
          const fechaValor = fechaTextoToMs(fechaTexto);

          if (!pendientesCliente.has(clienteNombre)) pendientesCliente.set(clienteNombre, []);
          pendientesIndices.forEach(idxUnidad => {
            const unidadInfo = l.unidades[idxUnidad] || {};
            const varNombre = unidadInfo?.variante || null;
            pendientesCliente.get(clienteNombre).push({
              nombre: l.nombre,
              icono: iconoProd,
              variante: varNombre,
              fecha: fechaTexto,
              fechaValor,
              pedidoFecha: o.fecha,
              indice: idxUnidad
            });
            registrarPendienteProducto(l.nombre, varNombre, idxUnidad, iconoProd, clienteNombre, fechaTexto, fechaValor);
          });
        }
      });
    }

    const fila = document.createElement('tr');
    if (allServed) fila.classList.add('servido');
    if (enCasa) fila.classList.add('orden-casa');

    let pagoHTML = '';
    if (esPagada) {
      const clasePago = o.metodo === 'sinpe' ? 'pago-sinpe' : 'pago-efectivo';
      const textoPago = o.metodo === 'sinpe' ? 'Sinpe' : 'Efectivo';
      pagoHTML = `<span class="pago-badge ${clasePago}">${html(textoPago)}<button type="button" onclick="desmarcarPago('${jsEsc(o.fecha)}')">Deshacer</button></span>`;
    } else if (enCasa) {
      const casaTexto = o.casa ? `Casa ${o.casa}` : 'Casa';
      pagoHTML = `
        <div class="pago-acciones">
          <span class="pago-badge pago-casa">${html(casaTexto)}</span>
          <button type="button" class="pago-btn efectivo" onclick="registrarPago('${jsEsc(o.fecha)}','efectivo')">Efectivo</button>
          <button type="button" class="pago-btn sinpe" onclick="registrarPago('${jsEsc(o.fecha)}','sinpe')">Sinpe</button>
          <button type="button" class="pago-btn simple" onclick="liberarCasa('${jsEsc(o.fecha)}')">Liberar</button>
        </div>
      `;
    } else {
      pagoHTML = `
        <div class="pago-acciones">
          <button type="button" class="pago-btn efectivo" onclick="registrarPago('${jsEsc(o.fecha)}','efectivo')">Efectivo</button>
          <button type="button" class="pago-btn sinpe" onclick="registrarPago('${jsEsc(o.fecha)}','sinpe')">Sinpe</button>
          ${construirSelectorCasas(o.fecha)}
        </div>
      `;
    }

    fila.innerHTML = `
      <td class="col-fecha">${html(o.fecha)}</td>
      <td>${html(o.cliente || '')}</td>
      <td>${o.cantidad}‚Ç°</td>
      <td>${pagoHTML}</td>
      <td>${productosHTML}</td>
      <td class="col-eliminar"><button type="button" class="btn-eliminar-orden" aria-label="Eliminar orden ${html(o.fecha)}" onclick="eliminarOrden('${jsEsc(o.fecha)}')">&times;</button></td>
    `;
    tbody.appendChild(fila);

    if (esPagada) {
      resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
      resumen.total += o.cantidad;
      for (let p in o.productos) {
        resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
      }
      const vars = o.variantes || {};
      Object.keys(vars).forEach(base=>{
        resumen.variantes[base] = resumen.variantes[base] || {};
        Object.keys(vars[base]).forEach(vn=>{
          resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
        });
      });
    }
  });

  const pendientesPorCliente = Array.from(pendientesCliente.entries()).map(([cliente, items]) => {
    const itemsOrdenados = items.slice().sort((a, b) => {
      const fechaDiff = (a.fechaValor - b.fechaValor);
      if (fechaDiff !== 0) return fechaDiff;
      const nombreDiff = a.nombre.localeCompare(b.nombre);
      if (nombreDiff !== 0) return nombreDiff;
      const varianteA = a.variante || '';
      const varianteB = b.variante || '';
      const varianteDiff = varianteA.localeCompare(varianteB);
      if (varianteDiff !== 0) return varianteDiff;
      return (a.indice - b.indice);
    });
    const primeraFecha = itemsOrdenados.length ? itemsOrdenados[0].fechaValor : Number.POSITIVE_INFINITY;
    return {
      cliente,
      total: itemsOrdenados.length,
      items: itemsOrdenados,
      primeraFecha
    };
  }).sort((a, b) => (a.primeraFecha - b.primeraFecha) || a.cliente.localeCompare(b.cliente));

  const pendientesPorProducto = Array.from(pendientesProducto.values()).map(entry => {
    const unidadesOrdenadas = entry.unidades.slice().sort((a, b) => {
      const fechaDiff = (a.fechaValor - b.fechaValor);
      if (fechaDiff !== 0) return fechaDiff;
      const clienteDiff = (a.cliente || '').localeCompare(b.cliente || '');
      if (clienteDiff !== 0) return clienteDiff;
      return (a.indice - b.indice);
    });
    const primeraFecha = unidadesOrdenadas.length ? unidadesOrdenadas[0].fechaValor : entry.primeraFecha;
    return {
      nombre: entry.nombre,
      icono: entry.icono,
      total: entry.total,
      variante: entry.variante,
      unidades: unidadesOrdenadas,
      primeraFecha
    };
  }).sort((a, b) => {
    const fechaDiff = a.primeraFecha - b.primeraFecha;
    if (fechaDiff !== 0) return fechaDiff;
    const nombreDiff = a.nombre.localeCompare(b.nombre);
    if (nombreDiff !== 0) return nombreDiff;
    return (a.variante || '').localeCompare(b.variante || '');
  });

  pendientesData = { porCliente: pendientesPorCliente, porProducto: pendientesPorProducto };
  actualizarPendientesUI();

  let resumenTbody = document.querySelector('#tablaResumen tbody');
  resumenTbody.innerHTML = '';
  resumenTbody.innerHTML += `<tr><td>Total Recaudado</td><td>${resumen.total}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Efectivo</td><td>${resumen.efectivo || 0}‚Ç°</td></tr>`;
  resumenTbody.innerHTML += `<tr><td>Total Sinpe</td><td>${resumen.sinpe || 0}‚Ç°</td></tr>`;
  for (let p in resumen.productos) {
    resumenTbody.innerHTML += `<tr><td>Ventas de ${html(p)}</td><td>${resumen.productos[p]}</td></tr>`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      const detalle = Object.keys(vars).map(v=>`${html(v)}: ${vars[v]}`).join(' ¬∑ ');
      resumenTbody.innerHTML += `<tr><td class="indentado">‚Äî ${html(p)} (variantes)</td><td>${detalle}</td></tr>`;
    }
  }

  ultimoResumen = {
    efectivo: resumen.efectivo || 0,
    sinpe: resumen.sinpe || 0,
    total: resumen.total || 0
  };
  renderPendientesPago();
  renderCasas();
  actualizarPanelCierre();
}

/* =================== PAGOS Y CASAS =================== */
function registrarPago(fecha, metodo) {
  if (!fecha || (metodo !== 'efectivo' && metodo !== 'sinpe')) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  orden.estado = ESTADOS_ORDEN.PAGADO;
  orden.metodo = metodo;
  orden.casa = null;
  orden.pagoFecha = new Date().toISOString();
  guardarTabla(ordenes);
  actualizarTabla();
}

function desmarcarPago(fecha) {
  if (!fecha) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  orden.estado = ESTADOS_ORDEN.PENDIENTE;
  orden.metodo = null;
  orden.pagoFecha = null;
  guardarTabla(ordenes);
  actualizarTabla();
}

function enviarOrdenACasa(fecha, casaNumero) {
  const casa = normalizarNumeroCasa(casaNumero);
  if (!fecha || !casa) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  orden.estado = ESTADOS_ORDEN.CASA;
  orden.casa = casa;
  orden.metodo = null;
  orden.pagoFecha = null;
  guardarTabla(ordenes);
  actualizarTabla();
}

function construirSelectorCasas(fecha) {
  const fechaEscapada = jsEsc(fecha);
  const opciones = Array.from({ length: 6 }, (_, i) => `<option value="${i + 1}">Casa ${i + 1}</option>`).join('');
  return `
    <label class="pago-dropdown">
      <span class="sr-only">Asignar a casa</span>
      <select class="pago-select" onchange="manejarSeleccionCasa('${fechaEscapada}', this)">
        <option value="">Casas</option>
        ${opciones}
      </select>
    </label>
  `;
}

function manejarSeleccionCasa(fecha, selectEl) {
  if (!selectEl) return;
  const casaSeleccionada = selectEl.value;
  if (!casaSeleccionada) return;
  enviarOrdenACasa(fecha, casaSeleccionada);
  selectEl.value = '';
  selectEl.blur();
}

function liberarCasa(fecha) {
  if (!fecha) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  const orden = ordenes[idx];
  orden.estado = ESTADOS_ORDEN.PENDIENTE;
  orden.casa = null;
  orden.metodo = null;
  orden.pagoFecha = null;
  guardarTabla(ordenes);
  actualizarTabla();
}

function resumenProductosCorto(o) {
  return construirLineasPorProducto(o).map(l => {
    const variantes = l.variantes && Object.keys(l.variantes).length
      ? ` <span class="productos-nombre">(${Object.keys(l.variantes).map(v => `${html(v)}: ${l.variantes[v]}`).join(' ¬∑ ')})</span>`
      : '';
    return `${html(l.iconos)} ${html(l.nombre)}${variantes}`;
  }).join('<br>');
}

function renderPendientesPago() {
  const tbody = document.querySelector('#tablaPendientesPago tbody');
  if (!tbody) return;
  const ordenes = cargarTabla();
  const pendientes = ordenes.filter(esOrdenPendientePago);
  tbody.innerHTML = '';
  if (pendientes.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" class="muted">No hay pedidos pendientes de pago.</td></tr>';
    return;
  }
  pendientes.sort((a, b) => new Date(a.fecha) - new Date(b.fecha)).forEach(o => {
    const productos = resumenProductosCorto(o) || '<span class="muted">Sin detalle</span>';
    const selectorCasas = construirSelectorCasas(o.fecha);
    const acciones = `
      <div class="pago-acciones">
        <button type="button" class="pago-btn efectivo" onclick="registrarPago('${jsEsc(o.fecha)}','efectivo')">Efectivo</button>
        <button type="button" class="pago-btn sinpe" onclick="registrarPago('${jsEsc(o.fecha)}','sinpe')">Sinpe</button>
        ${selectorCasas}
      </div>
    `;
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${html(o.fecha)}</td>
      <td>${html(o.cliente || 'Sin nombre')}</td>
      <td>${o.cantidad}‚Ç°</td>
      <td>${productos}</td>
      <td>${acciones}</td>
    `;
    tbody.appendChild(fila);
  });
}

function renderCasas() {
  const grid = document.getElementById('casasGrid');
  if (!grid) return;
  const ordenes = cargarTabla();
  const casas = new Map(Array.from({ length: 6 }, (_, i) => [i + 1, []]));
  ordenes.forEach(o => {
    if (!esOrdenEnCasa(o)) return;
    const casa = normalizarNumeroCasa(o.casa) || normalizarNumeroCasa(detectarCasaDesdeNombre(o.cliente));
    if (!casa) return;
    casas.get(casa).push(o);
  });

  grid.innerHTML = '';
  casas.forEach((lista, numero) => {
    const card = document.createElement('article');
    card.className = 'casa-card';
    card.innerHTML = `<h3>Casa ${numero}<span>${lista.length} pedido${lista.length === 1 ? '' : 's'}</span></h3>`;
    if (!lista.length) {
      card.innerHTML += '<div class="casa-vacia">Sin pedidos asignados.</div>';
    } else {
      const ul = document.createElement('ul');
      ul.className = 'casa-pedidos-list';
      lista.sort((a, b) => new Date(a.fecha) - new Date(b.fecha)).forEach(o => {
        const li = document.createElement('li');
        li.className = 'casa-pedido';
        const productos = resumenProductosCorto(o) || '<span class="muted">Sin detalle</span>';
        li.innerHTML = `
          <div class="casa-pedido-header">
            <span>${html(o.cliente || 'Sin nombre')}</span>
            <span>${formatearColones(o.cantidad)}‚Ç°</span>
          </div>
          <div class="productos-nombre">${productos}</div>
          <div class="casa-pedido-acciones">
            <button type="button" class="pago-btn efectivo" onclick="registrarPago('${jsEsc(o.fecha)}','efectivo')">Efectivo</button>
            <button type="button" class="pago-btn sinpe" onclick="registrarPago('${jsEsc(o.fecha)}','sinpe')">Sinpe</button>
            <button type="button" class="pago-btn simple" onclick="liberarCasa('${jsEsc(o.fecha)}')">Retirar</button>
          </div>
        `;
        ul.appendChild(li);
      });
      card.appendChild(ul);
    }
    grid.appendChild(card);
  });
}

function detectarCasaDesdeNombre(nombre) {
  if (!nombre) return null;
  const texto = String(nombre).trim().toLowerCase();
  const matchCasa = texto.match(/casa\s*([1-6])/);
  if (matchCasa) return Number(matchCasa[1]);
  const matchNumero = texto.match(/\b([1-6])\b/);
  if (matchNumero) return Number(matchNumero[1]);
  return null;
}

function eliminarOrden(fecha) {
  if (!confirm('¬øEst√°s seguro de eliminar esta orden?')) return;
  let ordenes = cargarTabla();
  const idx = ordenes.findIndex(o => o.fecha === fecha);
  if (idx === -1) return;
  ordenes.splice(idx, 1);
  guardarTabla(ordenes);
  actualizarTabla();
}

function eliminarTodasOrdenes() {
  guardarTabla([]);
  actualizarTabla();
}

function mostrarWarningEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.add('active');
  setTimeout(() => {
    const confirmBtn = overlay.querySelector('.confirm');
    if (confirmBtn) confirmBtn.focus();
  }, 0);
}

function cancelarEliminarTodos() {
  const overlay = document.getElementById('warningEliminarTodos');
  if (!overlay) return;
  overlay.classList.remove('active');
}

function confirmarEliminarTodos() {
  eliminarTodasOrdenes();
  cancelarEliminarTodos();
}

function mergeVariantes(target, source) {
  if (!target || !source) return;
  Object.keys(source).forEach(nombreVar => {
    const cantidad = Number(source[nombreVar]) || 0;
    if (cantidad > 0) {
      target[nombreVar] = (target[nombreVar] || 0) + cantidad;
    }
  });
}

function normalizarPendientesPorCliente(map) {
  const resultado = [];
  map.forEach((items, cliente) => {
    const agrupados = new Map();
    items.forEach(item => {
      const key = item.nombre;
      if (!agrupados.has(key)) {
        agrupados.set(key, {
          nombre: item.nombre,
          icono: item.icono || '',
          cantidad: 0,
          variantes: {},
          fecha: item.fecha || ''
        });
      }
      const prod = agrupados.get(key);
      prod.cantidad += Number(item.cantidad) || 0;
      mergeVariantes(prod.variantes, item.variantes || {});
      if (!prod.fecha && item.fecha) prod.fecha = item.fecha;
    });

    const itemsOrdenados = Array.from(agrupados.values()).map(prod => {
      if (!prod.variantes || Object.keys(prod.variantes).length === 0) prod.variantes = null;
      return prod;
    }).sort((a, b) => a.nombre.localeCompare(b.nombre));

    const total = itemsOrdenados.reduce((sum, prod) => sum + (Number(prod.cantidad) || 0), 0);
    resultado.push({ cliente, total, items: itemsOrdenados });
  });
  return resultado;
}

function actualizarPendientesUI() {
  const contCliente = document.getElementById('pendientesPorCliente');
  const contProducto = document.getElementById('pendientesPorProducto');

  if (contCliente) {
    if (!pendientesData.porCliente.length) {
      contCliente.innerHTML = '<p class="pendientes-vacio">No hay productos pendientes por servir.</p>';
    } else {
      contCliente.innerHTML = pendientesData.porCliente.map(entry => {
        const lista = entry.items.map(item => {
          const icono = item.icono ? `<span class="pendientes-icono">${html(item.icono)}</span>` : '';
          const variante = item.variante ? `<span class="pendientes-variante">${html(item.variante)}</span>` : '';
          const unidadBadge = Number.isInteger(item.indice) ? `<span class="pendientes-variante">Unidad ${item.indice + 1}</span>` : '';
          const fecha = item.fecha ? `<span class="pendientes-fecha">Pedido: ${html(item.fecha)}</span>` : '';
          const indiceAttr = Number.isInteger(item.indice) ? ` data-indice="${item.indice}"` : '';
          const completar = `<button type="button" class="pendiente-completar" data-fecha="${html(item.pedidoFecha)}" data-producto="${html(item.nombre)}"${indiceAttr} title="Marcar como completado">Completar</button>`;
          return `<li><div class="fila-principal">${icono}<span>${html(item.nombre)}</span>${variante}${unidadBadge}${completar}</div>${fecha}</li>`;
        }).join('');
        return `
          <article class="pendiente-card">
            <div class="pendiente-card-header">
              <div class="header-left"><span><strong>${html(entry.cliente)}</strong></span></div>
              <span class="pendientes-total">${entry.total} pendiente${entry.total === 1 ? '' : 's'}</span>
            </div>
            <ul class="pendientes-list">${lista}</ul>
          </article>
        `;
      }).join('');
    }
  }

  if (contProducto) {
    if (!pendientesData.porProducto.length) {
      contProducto.innerHTML = '<p class="pendientes-vacio">No hay productos pendientes por servir.</p>';
    } else {
      contProducto.innerHTML = pendientesData.porProducto.map(prod => {
        const icono = prod.icono ? `<span class="pendientes-icono">${html(prod.icono)}</span>` : '';
        const variante = prod.variante ? `<span class="pendientes-variante">${html(prod.variante)}</span>` : '';
        const clientesDetalle = prod.unidades.map(unidad => {
          const clienteNombre = (unidad.cliente || 'Sin nombre');
          const fecha = unidad.fecha ? `<span class="pendientes-fecha">Pedido: ${html(unidad.fecha)}</span>` : '';
          const unidadBadge = Number.isInteger(unidad.indice) ? `<span class="pendientes-variante">Unidad ${unidad.indice + 1}</span>` : '';
          const varianteDetalle = unidad.variante && !prod.variante ? `<span class="pendientes-variante">${html(unidad.variante)}</span>` : '';
          const indiceAttr = Number.isInteger(unidad.indice) ? ` data-indice="${unidad.indice}"` : '';
          const completar = `<button type="button" class="pendiente-completar" data-fecha="${html(unidad.pedidoFecha)}" data-producto="${html(prod.nombre)}"${indiceAttr} title="Marcar como completado">Completar</button>`;
          return `<li><div class="fila-principal"><span>para ${html(clienteNombre)}</span>${varianteDetalle}${unidadBadge}${completar}</div>${fecha}</li>`;
        }).join('');
        return `
          <article class="pendiente-card">
            <div class="pendiente-card-header">
              <div class="header-left">${icono}<span><strong>${html(prod.nombre)}</strong></span>${variante}</div>
              <span class="pendientes-total">${prod.total} pendiente${prod.total === 1 ? '' : 's'}</span>
            </div>
            <ul class="pendientes-list">${clientesDetalle}</ul>
          </article>
        `;
      }).join('');
    }
  }
}

function abrirPendientes(tab = 'cliente') {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay) return;
  actualizarPendientesUI();
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden', 'false');
  cambiarTabPendientes(tab);
  const closeBtn = overlay.querySelector('.pendientes-close');
  if (closeBtn) closeBtn.focus();
}

function cerrarPendientes() {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay || !overlay.classList.contains('active')) return;
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden', 'true');
  const btn = document.getElementById('verPendientesBtn');
  if (btn) btn.focus();
}

function cambiarTabPendientes(tab) {
  const overlay = document.getElementById('pendientesOverlay');
  if (!overlay) return;
  const tabs = overlay.querySelectorAll('.pendientes-tab');
  tabs.forEach(btn => {
    const activa = btn.dataset.tab === tab;
    btn.classList.toggle('active', activa);
    btn.setAttribute('aria-selected', activa ? 'true' : 'false');
  });
  const clientePane = document.getElementById('pendientesPorCliente');
  const productoPane = document.getElementById('pendientesPorProducto');
  if (clientePane) clientePane.hidden = tab !== 'cliente';
  if (productoPane) productoPane.hidden = tab !== 'producto';
  overlay.dataset.activeTab = tab;
}

document.addEventListener('click', event => {
  const btn = event.target.closest('.pendiente-completar');
  if (!btn) return;
  const { fecha, producto, indice } = btn.dataset;
  const indiceNumero = indice === undefined ? null : Number.parseInt(indice, 10);
  if (Number.isInteger(indiceNumero)) {
    marcarPendienteComoServido(fecha, producto, indiceNumero);
  } else {
    marcarPendienteComoServido(fecha, producto);
  }
});

/* Enviar / recoger selecci√≥n */
function recogerSeleccionProductosBase() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => out[nombre] = seleccionActual[nombre].total || 0);
  return out;
}
function recogerSeleccionVariantes() {
  const out = {};
  Object.keys(seleccionActual).forEach(nombre => {
    const vars = seleccionActual[nombre].variantes || {};
    if (Object.keys(vars).length) out[nombre] = {...vars};
  });
  return out;
}
function enviar() {
  const totalNum = +document.getElementById('total').innerText.replace(/[^\d]/g, '');
  if (totalNum == 0) { alert('A√±ade productos'); return; }

  const productosVendidos = recogerSeleccionProductosBase();
  const variantesVendidas = recogerSeleccionVariantes();
  const cliente = (document.getElementById('cliente').value || '').trim();

  const nuevaOrden = crearOrdenRegistro({
    cliente,
    productos: productosVendidos,
    variantes: variantesVendidas,
    estado: ESTADOS_ORDEN.PENDIENTE,
    casa: null,
    entregasServidas: false
  });

  const casaAuto = detectarCasaDesdeNombre(cliente);
  if (casaAuto) {
    nuevaOrden.estado = ESTADOS_ORDEN.CASA;
    nuevaOrden.casa = casaAuto;
    nuevaOrden.metodo = null;
    nuevaOrden.pagoFecha = null;
    alert(`Pedido asignado autom√°ticamente a la Casa ${casaAuto}.`);
  }

  let ordenes = cargarTabla();
  ordenes.push(nuevaOrden);

  guardarTabla(ordenes);
  actualizarTabla();
  borrar();
}

/* Limpiar selecci√≥n */
function borrar() {
  seleccionActual = {};
  productosNodos.forEach(p => {
    const c = p.querySelector('.contador'), r = p.querySelector('.restar');
    if (c) { c.textContent = ''; c.style.display = 'none'; }
    if (r) { r.style.display = 'none'; }
  });
  ocultarPanelVariantes();
  const clienteInput = document.getElementById('cliente');
  if (clienteInput) clienteInput.value = '';
  actualizarResumen();
}

/* =================== PRECIO COMBO =================== */
function calcularTotalDesdeMapa(mapa, PRODS=null) {
  const PRODUCTOS = PRODS || cargarProductos();
  let total = 0;
  let individuales = { ...mapa };
  const combos = [];
  let cambios;
  do {
    cambios = false;
    const posiblesBebidas = PRODUCTOS.filter(p => p.tipo === 'bebida' && (individuales[p.nombre] || 0) > 0);
    const posiblesComidas = PRODUCTOS.filter(p => p.tipo === 'comida' && (individuales[p.nombre] || 0) > 0);
    for (let bebida of posiblesBebidas) {
      for (let comida of posiblesComidas) {
        if ((individuales[bebida.nombre] || 0) > 0 &&
            (individuales[comida.nombre] || 0) > 0 &&
            (Number(bebida.precio) + Number(comida.precio)) > Number(PRECIO_COMBO)) {
          combos.push([bebida.nombre, comida.nombre]);
          individuales[bebida.nombre]--;
          individuales[comida.nombre]--;
          cambios = true;
          break;
        }
      }
      if (cambios) break;
    }
  } while (cambios);

  const comboCantidades = {};
  combos.forEach(c => {
    const clave = c.join(' + ');
    comboCantidades[clave] = (comboCantidades[clave] || 0) + 1;
  });

  for (let combo in comboCantidades) total += comboCantidades[combo] * PRECIO_COMBO;
  for (let p in individuales) {
    const cant = individuales[p] || 0;
    if (cant > 0) {
      const precioUnitario = PRODUCTOS.find(x => x.nombre === p)?.precio || 0;
      total += cant * precioUnitario;
    }
  }
  return { total, comboCantidades, individuales };
}

/* =================== CIERRE DE CAJA (incluye variantes en resumen CSV) =================== */
function cerrarCaja() {
  if (!confirm("¬øSeguro que quieres cerrar la caja? Se enviar√° un resumen al correo y se conservar√°n los pedidos sin pagar o asignados a casas.")) return;

  const ordenes = cargarTabla();
  const pagadas = ordenes.filter(esOrdenPagada);
  const pendientes = ordenes.filter(o => !esOrdenPagada(o));
  const fecha = new Date().toISOString().split('T')[0];
  const subject = `Ignis Latte - Cierre de caja ${fecha}`;
  const message = `Cierre autom√°tico generado el ${fecha}`;

  let resumen = { efectivo: 0, sinpe: 0, total: 0, productos: {}, variantes: {} };
  pagadas.forEach(o => {
    resumen[o.metodo] = (resumen[o.metodo] || 0) + o.cantidad;
    resumen.total += o.cantidad;
    for (let p in o.productos) {
      resumen.productos[p] = (resumen.productos[p] || 0) + o.productos[p];
    }
    const vars = o.variantes || {};
    Object.keys(vars).forEach(base=>{
      resumen.variantes[base] = resumen.variantes[base] || {};
      Object.keys(vars[base]).forEach(vn=>{
        resumen.variantes[base][vn] = (resumen.variantes[base][vn] || 0) + vars[base][vn];
      });
    });
  });

  const cierreInput = document.getElementById('cierreEfectivoInput');
  const efectivoContado = cierreInput ? parseColones(cierreInput.value) : 0;
  const fondo = obtenerFondoInicial();
  const efectivoEsperado = fondo + (resumen.efectivo || 0);
  const diferenciaConteo = efectivoContado - efectivoEsperado;

  let tablaResumenTexto = "Resumen;Valor\n";
  tablaResumenTexto += `Total Recaudado;${resumen.total}‚Ç°\n`;
  tablaResumenTexto += `Total Efectivo;${resumen.efectivo || 0}‚Ç°\n`;
  tablaResumenTexto += `Total Sinpe;${resumen.sinpe || 0}‚Ç°\n`;
  tablaResumenTexto += `Fondo de caja;${fondo}‚Ç°\n`;
  tablaResumenTexto += `Efectivo real contado;${efectivoContado}‚Ç°\n`;
  tablaResumenTexto += `Efectivo esperado;${efectivoEsperado}‚Ç°\n`;
  tablaResumenTexto += `Diferencia conteo;${diferenciaConteo}‚Ç°\n`;
  for (let p in resumen.productos) {
    tablaResumenTexto += `Ventas de ${p};${resumen.productos[p]}\n`;
    const vars = resumen.variantes[p];
    if (vars && Object.keys(vars).length) {
      tablaResumenTexto += `Variantes de ${p};${Object.keys(vars).map(v=>`${v}:${vars[v]}`).join(' | ')}\n`;
    }
  }

  let tablaHistoricaTexto = "Fecha;Cliente;Cantidad;M√©todo\n";
  pagadas.forEach(o => {
    tablaHistoricaTexto += `${o.fecha};${o.cliente || ''};${o.cantidad}‚Ç°;${o.metodo}\n`;
  });

  emailjs.send("service_kmko3hp", "template_7xn4zvs", {
    subject, message,
    tabla_resumen: tablaResumenTexto,
    tabla_historica: tablaHistoricaTexto,
    name: "Ignis Latte",
    email: "info@ignismundi.org"
  }).then(() => {
    alert("Correo enviado con √©xito.");
    if (pendientes.length > 0) {
      guardarTabla(pendientes);
    } else {
      localStorage.removeItem(STORAGE_KEYS.ordenes);
    }
    actualizarTabla();
  }, (error) => {
    console.error(error);
    alert("Error al enviar el correo: " + JSON.stringify(error));
  });
}

const clienteInputPedidos = document.getElementById('cliente');
if (clienteInputPedidos) {
  clienteInputPedidos.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
      event.preventDefault();
      enviar();
    }
  });
}

const btnPendientes = document.getElementById('verPendientesBtn');
if (btnPendientes) {
  btnPendientes.addEventListener('click', () => abrirPendientes('cliente'));
}

const overlayPendientes = document.getElementById('pendientesOverlay');
if (overlayPendientes) {
  overlayPendientes.addEventListener('click', (event) => {
    if (event.target === overlayPendientes) cerrarPendientes();
  });
  const closeBtn = overlayPendientes.querySelector('.pendientes-close');
  if (closeBtn) closeBtn.addEventListener('click', cerrarPendientes);
  overlayPendientes.querySelectorAll('.pendientes-tab').forEach(tabBtn => {
    tabBtn.addEventListener('click', () => {
      const tab = tabBtn.dataset.tab || 'cliente';
      cambiarTabPendientes(tab);
    });
  });
}

document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') {
    cancelarEliminarTodos();
    cerrarPendientes();
    ocultarPanelVariantes();
  }
});

const overlayEliminarTodos = document.getElementById('warningEliminarTodos');
if (overlayEliminarTodos) {
  overlayEliminarTodos.addEventListener('click', (event) => {
    if (event.target === overlayEliminarTodos) cancelarEliminarTodos();
  });
}

aplicarConfigApertura();
inicializarBreakdown('apertura');
inicializarBreakdown('cierre');

document.querySelectorAll('.toggle-breakdown').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.dataset.target;
    if (target) toggleBreakdownById(target, btn);
  });
});

const fondoInput = document.getElementById('fondoCajaInput');
if (fondoInput) {
  fondoInput.addEventListener('focus', () => {
    limpiarBreakdown('apertura');
  });
  fondoInput.addEventListener('input', () => {
    configApertura.fondo = parseColones(fondoInput.value);
    guardarConfigApertura();
    actualizarResumenApertura();
  });
}

const cierreInput = document.getElementById('cierreEfectivoInput');
if (cierreInput) {
  cierreInput.addEventListener('input', () => {
    actualizarPanelCierre();
  });
}

actualizarResumenApertura();
actualizarPanelCierre();

/* =================== ARRANQUE (Datos base) =================== */
crearProductos();
actualizarResumen();
actualizarTabla();

mostrarTab('apertura');
</script>
</body>
</html>
